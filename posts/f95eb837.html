<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>学习笔记｜Gorm框架 | RyanChouBlog</title>
<noscript>开启Javascript是必要的</noscript>
<link rel="icon" type="image/x-icon" href="/img/avatar.webp">
<link rel="apple-touch-icon" href="/img/avatar.webp">
<meta name="apple-mobile-web-app-title" content="RyanChouBlog">
<link rel="bookmark" href="/img/avatar.webp">
<link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/avatar.webp">
<meta name="description" content="一个记录学习与生活的博客">
<meta name="theme-color" content="#1C1C1F">
<link rel="stylesheet" href="/css/var.css">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/custom.css">



<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    

<link rel="stylesheet" href="/lib/snackbar.min.css">


<script src="/lib/qrcode.min.js"></script>





<script>var GLOBALCONFIG = {"root":"/","runtime":"2023-03-01 00:00:00","lazyload":{"enable":false,"error":"/img/acrylic.png"},"hightlight":{"enable":false,"limit":200},"lightbox":true,"randomlinks":false,"lang":{"theme":{"dark":"已切换至深色模式","light":"已切换至浅色模式"},"copy":{"success":"复制成功","error":"复制失败"},"backtop":"返回顶部","time":{"recent":"最近","yesterday":"昨天","berforeyesterday":"前天","daybefore":"天前","runtime":"天"},"sayhello":{"morning":"早上好","noon":"中午好","afternoon":"下午好","night":"晚上好","goodnight":"晚安","iam":"!  我是"},"search":{"empty":"搜索结果为空","hit":"已为您找到 ${query} 条结果","placeholder":"输入关键词快速查找"}},"covercolor":false,"comment":{"enable":false,"twikooUrl":null}};</script><script id="site-config">var PAGECONFIG = {"is_home":false,"is_post":true,"is_page":false,"page":false,"toc":true,"comment":false};</script>
    <meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="RyanChouBlog" type="application/atom+xml">
</head>
    <body id="body">
        
        <div id="console" style="zoom: 1;" class="">
    <div class="close-btn" onclick="acrylic.hideConsole()" href="javascript:void(0);">
        <i class="fas fa-circle-xmark"></i>
    </div>
    
        <div class="console-card-group">
            <div class="console-card-group-left">
                <div class="console-card" id="card-newest-comments" onclick="acrylic.hideConsole()">
                    <div class="card-content">
                        <div class="author-content-item-tips">互动</div>
                        <div class="author-content-item-title">最新评论</div>
                    </div>
                    <div class="aside-list"></div>
                </div>
    
            </div>
            <div class="console-card-group-right">
                <div class="console-card tags" onclick="acrylic.hideConsole()">
                    <div class="card-content">
                        <div class="author-content-item-tips">标签</div>
                        <div class="author-content-item-title">寻找感兴趣的领域</div>
                    </div>
                    <div class="card-tag-cloud">
                        
                            <a href="/tags/Docker/" style="font-size: 0.8rem; color: #d3d3d3">Docker<sup>1</sup></a>
                        
                            <a href="/tags/Git/" style="font-size: 0.8rem; color: #d3d3d3">Git<sup>1</sup></a>
                        
                            <a href="/tags/Gin/" style="font-size: 0.8rem; color: #d3d3d3">Gin<sup>1</sup></a>
                        
                            <a href="/tags/Golang/" style="font-size: 0.8rem; color: #d3d3d3">Golang<sup>3</sup></a>
                        
                            <a href="/tags/Linux/" style="font-size: 0.8rem; color: #d3d3d3">Linux<sup>1</sup></a>
                        
                            <a href="/tags/Gorm/" style="font-size: 0.8rem; color: #d3d3d3">Gorm<sup>1</sup></a>
                        
                            <a href="/tags/MySQL/" style="font-size: 0.8rem; color: #d3d3d3">MySQL<sup>1</sup></a>
                        
                    </div>
                </div>
                <div class="console-card history" onclick="acrylic.hideConsole()">
                    <ul class="card-archive-list">
    
     
        <li class="card-archive-list-item"><a class="card-archive-list-link" onclick="pjax.loadUrl('/archives/2023-06/')" data-pjax-state=""><span
            class="card-archive-list-date">2023-06</span>
            <div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span
                    class="card-archive-list-count-unit">篇</span></div>
            </a>
        </li>
     
        <li class="card-archive-list-item"><a class="card-archive-list-link" onclick="pjax.loadUrl('/archives/2023-05/')" data-pjax-state=""><span
            class="card-archive-list-date">2023-05</span>
            <div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span
                    class="card-archive-list-count-unit">篇</span></div>
            </a>
        </li>
        
</ul>

                </div>
            </div>
        </div>
    
    
    <div class="button-group">
        <div class="console-btn-item"> <a class="darkmode_switchbutton" onclick="acrylic.switchDarkMode()" title="显示模式切换"
                href="javascript:void(0);" rel="external nofollow" data-pjax-state=""><i class="fas fa-moon"
                    style="font-size: 1rem;"></i></a></div>
        
    </div>
    <div class="console-mask" onclick="acrylic.hideConsole()" href="javascript:void(0);" rel="external nofollow"></div>
</div>
        <div id="sidebar" style="zoom: 1;">
    <div id="menu-mask" style="display: none;"></div>
    <div id="sidebar-menus" class>
        <span class="sidebar-menu-item-title">功能</span>
        <div class="sidebar-menu-item">
            <a class="darkmode_switchbutton menu-child" onclick="acrylic.switchDarkMode()" title="显示模式切换"
                href="javascript:void(0);" rel="external nofollow">
                <i class="fas fa-moon" style="font-size: 1rem;"></i>
                <span>显示模式</span>
            </a>
        </div>
        
            <div class="back-menu-list-groups">
    
  </div>
  
        
        <div class="menus_items">
    
        <div class="menus_item">
            
                <a class="site-page" href="javascript:void(0);" rel="external nofollow">
                    <span> 文库</span>
                </a>
                <ul class="menus_item_child">
                    
                        <li>
                            <a class="site-page child" href="/archives/">
                                <i class="fas fa-box-archive"></i>
                                <span> 文章列表</span>
                            </a>
                        </li>
                    
                        <li>
                            <a class="site-page child" href="/categories/">
                                <i class="fas fa-cube"></i>
                                <span> 全部分类</span>
                            </a>
                        </li>
                    
                        <li>
                            <a class="site-page child" href="/tags/">
                                <i class="fas fa-tags"></i>
                                <span> 全部标签</span>
                            </a>
                        </li>
                    
                </ul>
             
        </div>
    
</div>
        <span class="sidebar-menu-item-title">标签</span>
        <div class="card-widget card-tags card-archives card-webinfo card-allinfo">
            <div class="item-headline">
                <i class="fas fa-tags"></i>
                <span>标签</span>
            </div>
            <div class="card-tag-cloud">
                
                    <a href="/tags/Docker/" style="font-size: 1em; color: #d3d3d3">Docker
                        <sup>1</sup>
                    </a>
                
                    <a href="/tags/Git/" style="font-size: 1em; color: #d3d3d3">Git
                        <sup>1</sup>
                    </a>
                
                    <a href="/tags/Gin/" style="font-size: 1em; color: #d3d3d3">Gin
                        <sup>1</sup>
                    </a>
                
                    <a href="/tags/Golang/" style="font-size: 1em; color: #d3d3d3">Golang
                        <sup>3</sup>
                    </a>
                
                    <a href="/tags/Linux/" style="font-size: 1em; color: #d3d3d3">Linux
                        <sup>1</sup>
                    </a>
                
                    <a href="/tags/Gorm/" style="font-size: 1em; color: #d3d3d3">Gorm
                        <sup>1</sup>
                    </a>
                
                    <a href="/tags/MySQL/" style="font-size: 1em; color: #d3d3d3">MySQL
                        <sup>1</sup>
                    </a>
                
            </div>
        </div>
    </div>
</div>    
        
            <div class="post" id="body-wrap">
                <header class="post-bg" id="page-header">
    <nav id="nav" class="show">
    <div id="nav-group">
        <div id="blog_name">
            
                <div class="back-home-button" tabindex="-1">
                    <i class="back-home-button-icon fas fa-grip-vertical"></i>
                    <div class="back-menu-list-groups">
    
  </div>
  
                </div>
            
            <a id="site-name" href="/" title="返回博客主页">
                    
                        <span class="heoicon">Ryan</span>
                    
            </a>
        </div>
        <div id="page-name-mask">
            <div id="page-name">
                <a id="page-name-text" onclick="acrylic.toTop()">学习笔记｜Gorm框架</a>
            </div>
        </div>
        <div id="menus">
            <div class="menus_items">
    
        <div class="menus_item">
            
                <a class="site-page" href="javascript:void(0);" rel="external nofollow">
                    <span> 文库</span>
                </a>
                <ul class="menus_item_child">
                    
                        <li>
                            <a class="site-page child" href="/archives/">
                                <i class="fas fa-box-archive"></i>
                                <span> 文章列表</span>
                            </a>
                        </li>
                    
                        <li>
                            <a class="site-page child" href="/categories/">
                                <i class="fas fa-cube"></i>
                                <span> 全部分类</span>
                            </a>
                        </li>
                    
                        <li>
                            <a class="site-page child" href="/tags/">
                                <i class="fas fa-tags"></i>
                                <span> 全部标签</span>
                            </a>
                        </li>
                    
                </ul>
             
        </div>
    
</div>
        </div>
        <!-- <div id="nav-left">
            <div id="fps-group">
                <div id="fps">145</div><span class="fpsText">FPS</span>
            </div>
        </div> -->
        <div id="nav-right">
            
    <div class="nav-button only-home" id="travellings_button">
        <a class="site-page"  target="_blank" rel="noopener external nofollow" href="https://www.travellings.cn/go.html" title="开往-友链接力"  width="120">
            <i class="fa-solid fa-train-subway" style="font-size: 1rem;"></i>
        </a>
    </div>


    <div class="nav-button" id="randomPost_button">
        <a class="site-page" onclick="toRandomPost()"
            title="随机前往一个文章">
            <i class="fas fa-shuffle" style="font-size: 1rem;"></i>
        </a>
    </div>



    <div class="nav-button" id="nav-console">
        <a class="console_switchbutton" onclick="acrylic.showConsole()"
        title="显示中控台" href="javascript:void(0);" rel="external nofollow">
        <i class="fas fa-bars-progress" style="font-size: 1rem;"></i>
        </a>
    </div>

<div class="nav-button" id="nav-totop" onclick="acrylic.toTop()">
    <a class="totopbtn">
        <i class="fas fa-arrow-up"></i>
        <span id="percent">0</span>
    </a>
</div>
<div id="toggle-menu">
    <a class="site-page">
        <i class="fas fa-bars fa-fw" style="font-size: 1rem;"></i>
    </a>
</div>
        </div>
    </div>
</nav>
    
        <div class="coverdiv" id="coverdiv">
    <img id="post-cover" class="nolazyload" src="/img/hello.jpg" alt="cover">
</div>
<div id="post-info">
    <div id="post-firstinfo">
        <div class="meta-firstline">
            <a class="post-meta-original" title="该文章为文章，注意版权协议">
                
            </a>
            
            <div class="tag_share">
                <div class="post-meta__tag-list">
                    
                        <a class="post-meta__tags" href="/tags/Gorm/">
                            <span class="tags-punctuation">#</span>
                            <span class="tags-name">Gorm</span>
                        </a>
                    
                </div>
            </div>
        </div>
    </div>
    <h1 class="post-title">学习笔记｜Gorm框架</h1>
    <div id="post-meta">
        <div class="meta-secondline">
            <span class="post-meta-date" title="发布于">
                <i class="post-meta-icon fa-fw fas fa-calendar"></i>
                <time datetime="2023-05-27T16:24:31+08:00"></time>
            </span>
            
            
                <span class="post-meta-position" title="作者IP归属地为江苏">
                    <i class="fas fa-location-dot post-meta-icon"></i>
                    <span>江苏</span>
                </span>
            
            
            
                
        </div>
    </div>
</div>
<section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg"
    xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
    <defs>
        <path id="gentle-wave"
            d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path>
    </defs>
    <g class="parallax">
        <use href="#gentle-wave" x="48" y="0"></use>
        <use href="#gentle-wave" x="48" y="3"></use>
        <use href="#gentle-wave" x="48" y="5"></use>
        <use href="#gentle-wave" x="48" y="7"></use>
    </g>
</svg>
</section>

        
</header>
                <main class="layout" id="content-inner">
    <div id="post">
        <article class="post-content" id="article-container">
            <h1 id="Gorm概述"><a href="#Gorm概述" class="headerlink" title="Gorm概述"></a>Gorm概述</h1><h2 id="ORM简介"><a href="#ORM简介" class="headerlink" title="ORM简介"></a>ORM简介</h2><p>对象关系映射（Object Relational<br>Mapping，简称ORM）模式是一种为了解决面向对象与关系数据库（如mysql数据库）存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre><code>go get -u gorm.io/gorm
go get -u gorm.io/driver/mysql
</code></pre>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模型 model</span></span><br><span class="line"><span class="keyword">type</span> Product <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model  <span class="comment">//继承</span></span><br><span class="line">    Code  <span class="type">string</span></span><br><span class="line">    Price <span class="type">uint</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建表 （迁移 schema）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">create</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    db.AutoMigrate(&amp;Product&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入数据</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    p := Product&#123;</span><br><span class="line">        Code:  <span class="string">&quot;1001&quot;</span>,</span><br><span class="line">        Price: <span class="number">100</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    db.Create(&amp;p)</span><br><span class="line">    <span class="comment">// 或者</span></span><br><span class="line">    db.Create(&amp;Product&#123;Code: <span class="string">&quot;D42&quot;</span>, Price: <span class="number">100</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">find</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> p Product</span><br><span class="line">    db.First(&amp;p, <span class="number">1</span>) <span class="comment">//根据整形主键查询</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;p: %v\n&quot;</span>, p)</span><br><span class="line">    db.First(&amp;p, <span class="string">&quot;code = ?&quot;</span>, <span class="string">&quot;1001&quot;</span>) <span class="comment">//查找code字段值为1001的记录</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;p: %v\n&quot;</span>, p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">update</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> p Product</span><br><span class="line">    db.First(&amp;p, <span class="number">1</span>)</span><br><span class="line">    db.Model(&amp;p).Update(<span class="string">&quot;Price&quot;</span>, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//db.Model(&amp;p).Update(Product&#123;Price: 1001, Code: &quot;1001&quot;&#125;) //仅更新非零值字段</span></span><br><span class="line">    <span class="comment">//db.Model(&amp;p).Update(map[string]interface&#123;&#125;&#123;&quot;Price&quot;: 1003, &quot;Code&quot;: &quot;1003&quot;&#125;)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">delete</span><span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> p Product</span><br><span class="line">    db.First(&amp;p, <span class="number">1</span>)</span><br><span class="line">    db.Delete(&amp;p, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dsn := <span class="string">&quot;root:mima1234@tcp(127.0.0.1:3306)/golang_db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line">    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to connect database&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//create(db)</span></span><br><span class="line">    <span class="comment">//insert(db)</span></span><br><span class="line">    <span class="comment">//find(db)</span></span><br><span class="line">    <span class="comment">//update(db)</span></span><br><span class="line">    <span class="comment">//delete(db)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="gorm声明模型"><a href="#gorm声明模型" class="headerlink" title="gorm声明模型"></a>gorm声明模型</h1><h2 id="模型定义"><a href="#模型定义" class="headerlink" title="模型定义"></a>模型定义</h2><p>模型是标准的 struct，由 Go 的基本数据类型、实现了 Scanner 和 Valuer<br>接口的自定义类型及其指针或别名组成</p>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID           <span class="type">uint</span></span><br><span class="line"> Name         <span class="type">string</span></span><br><span class="line"> Email        *<span class="type">string</span></span><br><span class="line"> Age          <span class="type">uint8</span></span><br><span class="line"> Birthday     *time.Time</span><br><span class="line"> MemberNumber sql.NullString</span><br><span class="line"> ActivatedAt  sql.NullTime</span><br><span class="line"> CreatedAt    time.Time</span><br><span class="line"> UpdatedAt    time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h2><p>GORM 倾向于约定，而不是配置。默认情况下，GORM 使用 <code>ID</code><br>作为主键，使用结构体名的 <code>蛇形复数</code> 作为表名，字段名的 <code>蛇形</code><br>作为列名，并使用 <code>CreatedAt</code>、<code>UpdatedAt</code> 字段追踪创建、更新时间</p>
<p>遵循 GORM<br>已有的约定，可以减少您的配置和代码量。如果约定不符合您的需求，GORM<br>允许您自定义配置它们</p>
<h2 id="gorm-Model"><a href="#gorm-Model" class="headerlink" title="gorm.Model"></a>gorm.Model</h2><p>GORM 定义一个 <code>gorm.Model</code> 结构体，其包括字段<br><code>ID</code>、<code>CreatedAt</code>、<code>UpdatedAt</code>、<code>DeletedAt</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gorm.Model 的定义</span></span><br><span class="line"><span class="keyword">type</span> Model <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID        <span class="type">uint</span>           <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line"> CreatedAt time.Time</span><br><span class="line"> UpdatedAt time.Time</span><br><span class="line"> DeletedAt gorm.DeletedAt <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您可以将它嵌入到您的结构体中，以包含这几个字段，详情请参考 嵌入结构体</p>
<h2 id="高级选项"><a href="#高级选项" class="headerlink" title="高级选项"></a>高级选项</h2><h3 id="字段级权限控制"><a href="#字段级权限控制" class="headerlink" title="字段级权限控制"></a>字段级权限控制</h3><p>可导出的字段在使用 GORM 进行 CRUD 时拥有全部的权限，此外，GORM<br>允许您用标签控制字段级别的权限。这样您就可以让一个字段的权限是只读、只写、只创建、只更新或者被忽略</p>
<blockquote>
<p><strong>注意：</strong> 使用 GORM Migrator 创建表时，不会创建被忽略的字段</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;&lt;-:create&quot;`</span> <span class="comment">// 允许读和创建</span></span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;&lt;-:update&quot;`</span> <span class="comment">// 允许读和更新</span></span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;&lt;-&quot;`</span>        <span class="comment">// 允许读和写（创建和更新）</span></span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;&lt;-:false&quot;`</span>  <span class="comment">// 允许读，禁止写</span></span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;-&gt;&quot;`</span>        <span class="comment">// 只读（除非有自定义配置，否则禁止写）</span></span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;-&gt;;&lt;-:create&quot;`</span> <span class="comment">// 允许读和写</span></span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;-&gt;:false;&lt;-:create&quot;`</span> <span class="comment">// 仅创建（禁止从 db 读）</span></span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;-&quot;`</span>  <span class="comment">// 通过 struct 读写会忽略该字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建-x2F-更新时间追踪（纳秒、毫秒、秒、Time）"><a href="#创建-x2F-更新时间追踪（纳秒、毫秒、秒、Time）" class="headerlink" title="创建&#x2F;更新时间追踪（纳秒、毫秒、秒、Time）"></a>创建&#x2F;更新时间追踪（纳秒、毫秒、秒、Time）</h3><p>GORM 约定使用 <code>CreatedAt</code>、<code>UpdatedAt</code><br>追踪创建&#x2F;更新时间。如果您定义了这种字段，GORM 在创建、更新时会自动填充<br>当前时间</p>
<p>要使用不同名称的字段，您可以配置 <code>autoCreateTime</code>、<code>autoUpdateTime</code> 标签</p>
<p>如果您想要保存 UNIX（毫&#x2F;纳）秒时间戳，而不是 time，您只需简单地将<br><code>time.Time</code> 修改为 <code>int</code> 即可</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> CreatedAt time.Time <span class="comment">// Set to current time if it is zero on creating</span></span><br><span class="line"> UpdatedAt <span class="type">int</span>       <span class="comment">// Set to current unix seconds on updating or if it is zero on creating</span></span><br><span class="line"> Updated   <span class="type">int64</span> <span class="string">`gorm:&quot;autoUpdateTime:nano&quot;`</span> <span class="comment">// Use unix nano seconds as updating time</span></span><br><span class="line"> Updated   <span class="type">int64</span> <span class="string">`gorm:&quot;autoUpdateTime:milli&quot;`</span><span class="comment">// Use unix milli seconds as updating time</span></span><br><span class="line"> Created   <span class="type">int64</span> <span class="string">`gorm:&quot;autoCreateTime&quot;`</span>      <span class="comment">// Use unix seconds as creating time</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="嵌入结构体"><a href="#嵌入结构体" class="headerlink" title="嵌入结构体"></a>嵌入结构体</h3><p>对于匿名字段，GORM 会将其字段包含在父结构体中，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> gorm.Model</span><br><span class="line"> Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 等效于</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID        <span class="type">uint</span>           <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line"> CreatedAt time.Time</span><br><span class="line"> UpdatedAt time.Time</span><br><span class="line"> DeletedAt gorm.DeletedAt <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line"> Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于正常的结构体字段，你也可以通过标签 <code>embedded</code> 将其嵌入，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Author <span class="keyword">struct</span> &#123;</span><br><span class="line">   Name  <span class="type">string</span></span><br><span class="line">   Email <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Blog <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID      <span class="type">int</span></span><br><span class="line"> Author  Author <span class="string">`gorm:&quot;embedded&quot;`</span></span><br><span class="line"> Upvotes <span class="type">int32</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 等效于</span></span><br><span class="line"><span class="keyword">type</span> Blog <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID    <span class="type">int64</span></span><br><span class="line"> Name  <span class="type">string</span></span><br><span class="line"> Email <span class="type">string</span></span><br><span class="line"> Upvotes  <span class="type">int32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且，您可以使用标签 <code>embeddedPrefix</code> 来为 db 中的字段名添加前缀，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Blog <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID      <span class="type">int</span></span><br><span class="line"> Author  Author <span class="string">`gorm:&quot;embedded;embeddedPrefix:author_&quot;`</span></span><br><span class="line"> Upvotes <span class="type">int32</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 等效于</span></span><br><span class="line"><span class="keyword">type</span> Blog <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID          <span class="type">int64</span></span><br><span class="line">   AuthorName  <span class="type">string</span></span><br><span class="line">   AuthorEmail <span class="type">string</span></span><br><span class="line"> Upvotes     <span class="type">int32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="字段标签"><a href="#字段标签" class="headerlink" title="字段标签"></a>字段标签</h3><p>声明 model 时，tag 是可选的，GORM 支持以下 tag：tag 名大小写不敏感，但建议使用 <code>camelCase</code> 风格</p>
<table>
<thead>
<tr>
<th align="left">标签名</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">column</td>
<td align="left">指定 db 列名</td>
</tr>
<tr>
<td align="left">type</td>
<td align="left">列数据类型，推荐使用兼容性好的通用类型，例如：所有数据库都支持 bool、int、uint、float、string、time、bytes 并且可以和其他标签一起使用，例如：<code>not null</code>、<code>size</code>, <code>autoIncrement</code>… 像 <code>varbinary(8)</code> 这样指定数据库数据类型也是支持的。在使用指定数据库数据类型时，它需要是完整的数据库数据类型，如：<code>MEDIUMINT UNSIGNED not NULL AUTO_INCREMENT</code></td>
</tr>
<tr>
<td align="left">size</td>
<td align="left">指定列大小，例如：<code>size:256</code></td>
</tr>
<tr>
<td align="left">primaryKey</td>
<td align="left">指定列为主键</td>
</tr>
<tr>
<td align="left">unique</td>
<td align="left">指定列为唯一</td>
</tr>
<tr>
<td align="left">default</td>
<td align="left">指定列的默认值</td>
</tr>
<tr>
<td align="left">precision</td>
<td align="left">指定列的精度</td>
</tr>
<tr>
<td align="left">scale</td>
<td align="left">指定列大小</td>
</tr>
<tr>
<td align="left">not null</td>
<td align="left">指定列为 NOT NULL</td>
</tr>
<tr>
<td align="left">autoIncrement</td>
<td align="left">指定列为自动增长</td>
</tr>
<tr>
<td align="left">autoIncrementIncrement</td>
<td align="left">自动步长，控制连续记录之间的间隔</td>
</tr>
<tr>
<td align="left">embedded</td>
<td align="left">嵌套字段</td>
</tr>
<tr>
<td align="left">embeddedPrefix</td>
<td align="left">嵌入字段的列名前缀</td>
</tr>
<tr>
<td align="left">autoCreateTime</td>
<td align="left">创建时追踪当前时间，对于 <code>int</code> 字段，它会追踪秒级时间戳，您可以使用 <code>nano</code>&#x2F;<code>milli</code> 来追踪纳秒、毫秒时间戳，例如：<code>autoCreateTime:nano</code></td>
</tr>
<tr>
<td align="left">autoUpdateTime</td>
<td align="left">创建&#x2F;更新时追踪当前时间，对于 <code>int</code> 字段，它会追踪秒级时间戳，您可以使用 <code>nano</code>&#x2F;<code>milli</code> 来追踪纳秒、毫秒时间戳，例如：<code>autoUpdateTime:milli</code></td>
</tr>
<tr>
<td align="left">index</td>
<td align="left">根据参数创建索引，多个字段使用相同的名称则创建复合索引，查看 索引 获取详情</td>
</tr>
<tr>
<td align="left">uniqueIndex</td>
<td align="left">与 <code>index</code> 相同，但创建的是唯一索引</td>
</tr>
<tr>
<td align="left">check</td>
<td align="left">创建检查约 束，例如 <code>check:age &gt; 13</code>，查看 约束 获取详情</td>
</tr>
<tr>
<td align="left">&lt;-</td>
<td align="left">设置字段写入的权限， <code>&lt;-:create</code> 只创建、<code>&lt;-:update</code> 只更新、<code>&lt;-:false</code> 无写入权限、<code>&lt;-</code> 创建和更新权限</td>
</tr>
<tr>
<td align="left">-&gt;</td>
<td align="left">设置字段读的权限，<code>-&gt;:false</code> 无读权限</td>
</tr>
<tr>
<td align="left">-</td>
<td align="left">忽略该字段，<code>-</code> 无读写权限</td>
</tr>
<tr>
<td align="left">comment</td>
<td align="left">迁移时为字段添加注释</td>
</tr>
</tbody></table>
<h3 id="关联标签"><a href="#关联标签" class="headerlink" title="关联标签"></a>关联标签</h3><p>GORM 允许通过标签为关联配置外键、约束、many2many 表，详情请参考 关联部分</p>
<h1 id="gorm连接到数据库"><a href="#gorm连接到数据库" class="headerlink" title="gorm连接到数据库"></a>gorm连接到数据库</h1><p>GORM 官方支持的数据库类型有：MySQL, PostgreSQL, SQlite, SQL Server</p>
<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;gorm.io/driver/mysql&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="comment">// 参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name 获取详情</span></span><br><span class="line"> dsn := <span class="string">&quot;user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;</span></span><br><span class="line"> db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：</strong>想要正确的处理 <code>time.Time</code> ，您需要带上 <code>parseTime</code> 参数，<br>(更多参数) 要支持完整的 UTF-8 编码，您需要将 <code>charset=utf8</code> 更改为<br><code>charset=utf8mb4</code> 查看 此文章 获取详情</p>
</blockquote>
<p>MySQl 驱动程序提供了 一些高级配置 可以在初始化过程中使用，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db, err := gorm.Open(mysql.New(mysql.Config&#123;</span><br><span class="line"> DSN: <span class="string">&quot;gorm:gorm@tcp(127.0.0.1:3306)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span>, <span class="comment">// DSN data source name</span></span><br><span class="line"> DefaultStringSize: <span class="number">256</span>, <span class="comment">// string 类型字段的默认长度</span></span><br><span class="line"> DisableDatetimePrecision: <span class="literal">true</span>, <span class="comment">// 禁用 datetime 精度，MySQL 5.6 之前的数据库不支持</span></span><br><span class="line"> DontSupportRenameIndex: <span class="literal">true</span>, <span class="comment">// 重命名索引时采用删除并新建的方式，MySQL 5.7 之前的数据库和 MariaDB 不支持重命名索引</span></span><br><span class="line"> DontSupportRenameColumn: <span class="literal">true</span>, <span class="comment">// 用 `change` 重命名列，MySQL 8 之前的数据库和 MariaDB 不支持重命名列</span></span><br><span class="line"> SkipInitializeWithVersion: <span class="literal">false</span>, <span class="comment">// 根据当前 MySQL 版本自动配置</span></span><br><span class="line">&#125;), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="自定义驱动"><a href="#自定义驱动" class="headerlink" title="自定义驱动"></a>自定义驱动</h3><p>GORM 允许通过 <code>DriverName</code> 选项自定义 MySQL 驱动，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> _ <span class="string">&quot;example.com/my_mysql_driver&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db, err := gorm.Open(mysql.New(mysql.Config&#123;</span><br><span class="line"> DriverName: <span class="string">&quot;my_mysql_driver&quot;</span>,</span><br><span class="line"> DSN: <span class="string">&quot;gorm:gorm@tcp(localhost:9910)/gorm?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span>, <span class="comment">// Data Source Name，参考 https://github.com/go-sql-driver/mysql#dsn-data-source-name</span></span><br><span class="line">&#125;), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="现有的数据库连接"><a href="#现有的数据库连接" class="headerlink" title="现有的数据库连接"></a>现有的数据库连接</h3><p>GORM 允许通过一个现有的数据库连接来初始化 <code>*gorm.DB</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;database/sql&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sqlDB, err := sql.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;mydb_dsn&quot;</span>)</span><br><span class="line">gormDB, err := gorm.Open(mysql.New(mysql.Config&#123;</span><br><span class="line"> Conn: sqlDB,</span><br><span class="line">&#125;), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;gorm.io/driver/postgres&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">dsn := <span class="string">&quot;host=localhost user=gorm password=gorm dbname=gorm port=9920 sslmode=disable TimeZone=Asia/Shanghai&quot;</span></span><br><span class="line">db, err := gorm.Open(postgres.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>我们使用 pgx 作为 postgres 的 database&#x2F;sql 驱动，默认情况下，它会启用<br>prepared statement 缓存，你可以这样禁用它：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/go-gorm/postgres</span></span><br><span class="line">db, err := gorm.Open(postgres.New(postgres.Config&#123;</span><br><span class="line"> DSN: <span class="string">&quot;user=gorm password=gorm dbname=gorm port=9920 sslmode=disable TimeZone=Asia/Shanghai&quot;</span>,</span><br><span class="line"> PreferSimpleProtocol: <span class="literal">true</span>, <span class="comment">// disables implicit prepared statement usage</span></span><br><span class="line">&#125;), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="自定义驱动-1"><a href="#自定义驱动-1" class="headerlink" title="自定义驱动"></a>自定义驱动</h3><p>GORM 允许通过 <code>DriverName</code> 选项自定义 PostgreSQL 驱动，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> _ <span class="string">&quot;github.com/GoogleCloudPlatform/cloudsql-proxy/proxy/dialers/postgres&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">db, err := gorm.Open(postgres.New(postgres.Config&#123;</span><br><span class="line"> DriverName: <span class="string">&quot;cloudsqlpostgres&quot;</span>,</span><br><span class="line"> DSN: <span class="string">&quot;host=project:region:instance user=postgres dbname=postgres password=password sslmode=disable&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="现有的数据库连接-1"><a href="#现有的数据库连接-1" class="headerlink" title="现有的数据库连接"></a>现有的数据库连接</h3><p>GORM 允许通过一个现有的数据库连接来初始化 <code>*gorm.DB</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;database/sql&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sqlDB, err := sql.Open(<span class="string">&quot;postgres&quot;</span>, <span class="string">&quot;mydb_dsn&quot;</span>)</span><br><span class="line">gormDB, err := gorm.Open(postgres.New(postgres.Config&#123;</span><br><span class="line"> Conn: sqlDB,</span><br><span class="line">&#125;), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;gorm.io/driver/sqlite&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// github.com/mattn/go-sqlite3</span></span><br><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">&quot;gorm.db&quot;</span>), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：</strong> 您也可以使用 <code>file::memory:?cache=shared</code><br>替代文件路径。这会告诉 SQLite 在系统内存中使用一个临时数据库。(查看<br>SQLite 文档 获取详情)</p>
</blockquote>
<h2 id="SQL-Server"><a href="#SQL-Server" class="headerlink" title="SQL Server"></a>SQL Server</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;gorm.io/driver/sqlserver&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// github.com/denisenkom/go-mssqldb</span></span><br><span class="line">dsn := <span class="string">&quot;sqlserver://gorm:LoremIpsum86@localhost:9930?database=gorm&quot;</span></span><br><span class="line">db, err := gorm.Open(sqlserver.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Clickhouse"><a href="#Clickhouse" class="headerlink" title="Clickhouse"></a>Clickhouse</h2><p><a target="_blank" rel="noopener" href="https://github.com/go-gorm/clickhouse">https://github.com/go-gorm/clickhouse</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;gorm.io/driver/clickhouse&quot;</span></span><br><span class="line"> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> dsn := <span class="string">&quot;tcp://localhost:9000?database=gorm&amp;username=gorm&amp;password=gorm&amp;read_timeout=10&amp;write_timeout=20&quot;</span></span><br><span class="line"> db, err := gorm.Open(clickhouse.Open(dsn), &amp;gorm.Config&#123;&#125;)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// Auto Migrate</span></span><br><span class="line"> db.AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"> <span class="comment">// Set table options</span></span><br><span class="line"> db.Set(<span class="string">&quot;gorm:table_options&quot;</span>, <span class="string">&quot;ENGINE=Distributed(cluster, default, hits)&quot;</span>).AutoMigrate(&amp;User&#123;&#125;)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 插入</span></span><br><span class="line"> db.Create(&amp;user)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 查询</span></span><br><span class="line"> db.Find(&amp;user, <span class="string">&quot;id = ?&quot;</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 批量插入</span></span><br><span class="line"> <span class="keyword">var</span> users = []User&#123;user1, user2, user3&#125;</span><br><span class="line"> db.Create(&amp;users)</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h2><p>GORM 使用 database&#x2F;sql 维护连接池</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sqlDB, err := db.DB()</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetMaxIdleConns 设置空闲连接池中连接的最大数量</span></span><br><span class="line">sqlDB.SetMaxIdleConns(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetMaxOpenConns 设置打开数据库连接的最大数量。</span></span><br><span class="line">sqlDB.SetMaxOpenConns(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetConnMaxLifetime 设置了连接可复用的最大时间。</span></span><br><span class="line">sqlDB.SetConnMaxLifetime(time.Hour)</span><br></pre></td></tr></table></figure>

<p>查看 通用接口 获取详情。</p>
<h1 id="gorm创建记录"><a href="#gorm创建记录" class="headerlink" title="gorm创建记录"></a>gorm创建记录</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;Name: <span class="string">&quot;Jinzhu&quot;</span>, Age: <span class="number">18</span>, Birthday: time.Now()&#125;</span><br><span class="line"></span><br><span class="line">result := db.Create(&amp;user) <span class="comment">// 通过数据的指针来创建</span></span><br><span class="line"></span><br><span class="line">user.ID             <span class="comment">// 返回插入数据的主键</span></span><br><span class="line">result.Error        <span class="comment">// 返回 error</span></span><br><span class="line">result.RowsAffected <span class="comment">// 返回插入记录的条数</span></span><br></pre></td></tr></table></figure>

<h2 id="用指定的字段创建记录"><a href="#用指定的字段创建记录" class="headerlink" title="用指定的字段创建记录"></a>用指定的字段创建记录</h2><p>创建记录并更新给出的字段。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Select(<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;Age&quot;</span>, <span class="string">&quot;CreatedAt&quot;</span>).Create(&amp;user)</span><br><span class="line"><span class="comment">// INSERT INTO `users` (`name`,`age`,`created_at`) VALUES (&quot;jinzhu&quot;, 18, &quot;2020-07-04 11:05:21.775&quot;)</span></span><br></pre></td></tr></table></figure>

<p>创建一个记录且一同忽略传递给略去的字段值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Omit(<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;Age&quot;</span>, <span class="string">&quot;CreatedAt&quot;</span>).Create(&amp;user)</span><br><span class="line"><span class="comment">// INSERT INTO `users` (`birthday`,`updated_at`) VALUES (&quot;2020-01-01 00:00:00.000&quot;, &quot;2020-07-04 11:05:21.775&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h2><p>要有效地插入大量记录，请将一个 <code>slice</code> 传递给 <code>Create</code> 方法。GORM<br>将生成单独一条SQL语句来插入所有数据，并回填主键的值，钩子方法也会被调用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = []User&#123;&#123;Name: <span class="string">&quot;jinzhu1&quot;</span>&#125;, &#123;Name: <span class="string">&quot;jinzhu2&quot;</span>&#125;, &#123;Name: <span class="string">&quot;jinzhu3&quot;</span>&#125;&#125;</span><br><span class="line">db.Create(&amp;users)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, user := <span class="keyword">range</span> users &#123;</span><br><span class="line"> user.ID <span class="comment">// 1,2,3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>CreateInBatches</code> 分批创建时，你可以指定每批的数量，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = []User&#123;&#123;name: <span class="string">&quot;jinzhu_1&quot;</span>&#125;, ...., &#123;Name: <span class="string">&quot;jinzhu_10000&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数量为 100</span></span><br><span class="line">db.CreateInBatches(users, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>Upsert 和 Create With Associations 也支持批量插入</p>
<blockquote>
<p><strong>注意</strong> 使用<code>CreateBatchSize</code> 选项初始化 GORM 时，所有的创建&amp; 关联<br><code>INSERT</code> 都将遵循该选项</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">&quot;gorm.db&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line"> CreateBatchSize: <span class="number">1000</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db := db.Session(&amp;gorm.Session&#123;CreateBatchSize: <span class="number">1000</span>&#125;)</span><br><span class="line"></span><br><span class="line">users = [<span class="number">5000</span>]User&#123;&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Pets: []Pet&#123;pet1, pet2, pet3&#125;&#125;...&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;users)</span><br><span class="line"><span class="comment">// INSERT INTO users xxx (5 batches)</span></span><br><span class="line"><span class="comment">// INSERT INTO pets xxx (15 batches)</span></span><br></pre></td></tr></table></figure>

<h2 id="创建钩子"><a href="#创建钩子" class="headerlink" title="创建钩子"></a>创建钩子</h2><p>GORM 允许用户定义的钩子有 <code>BeforeSave</code>, <code>BeforeCreate</code>, <code>AfterSave</code>,<br><code>AfterCreate</code> 创建记录时将调用这些钩子方法，请参考 Hooks<br>中关于生命周期的详细信息</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line"> u.UUID = uuid.New()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> u.Role == <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;invalid role&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您想跳过 <code>钩子</code> 方法，您可以使用 <code>SkipHooks</code> 会话模式，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Create(&amp;user)</span><br><span class="line"></span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Create(&amp;users)</span><br><span class="line"></span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).CreateInBatches(users, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h2 id="根据-Map-创建"><a href="#根据-Map-创建" class="headerlink" title="根据 Map 创建"></a>根据 Map 创建</h2><p>GORM 支持根据 <code>map[string]interface&#123;&#125;</code> 和 <code>[]map[string]interface&#123;&#125;&#123;&#125;</code><br>创建记录，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;User&#123;&#125;).Create(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"> <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">18</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// batch insert from `[]map[string]interface&#123;&#125;&#123;&#125;`</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Create([]<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">&#123;<span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jinzhu_1&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">18</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jinzhu_2&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">20</span>&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：</strong> 根据 map 创建记录时，association<br>不会被调用，且主键也不会自动填充</p>
</blockquote>
<h2 id="使用-SQL-表达式、Context-Valuer-创建记录"><a href="#使用-SQL-表达式、Context-Valuer-创建记录" class="headerlink" title="使用 SQL 表达式、Context Valuer 创建记录"></a>使用 SQL 表达式、Context Valuer 创建记录</h2><p>GORM 允许使用 SQL 表达式插入数据，有两种方法实现这个目标。根据<br><code>map[string]interface&#123;&#125;</code> 或 自定义数据类型 创建，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过 map 创建记录</span></span><br><span class="line">db.Model(User&#123;&#125;).Create(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line"> <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>,</span><br><span class="line"> <span class="string">&quot;Location&quot;</span>: clause.Expr&#123;SQL: <span class="string">&quot;ST_PointFromText(?)&quot;</span>, Vars: []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;POINT(100 100)&quot;</span>&#125;&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// INSERT INTO `users` (`name`,`location`) VALUES (&quot;jinzhu&quot;,ST_PointFromText(&quot;POINT(100 100)&quot;));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过自定义类型创建记录</span></span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> &#123;</span><br><span class="line">   X, Y <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Scan 方法实现了 sql.Scanner 接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc *Location)</span></span> Scan(v <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line"> <span class="comment">// Scan a value into struct from database driver</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc Location)</span></span> GormDataType() <span class="type">string</span> &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&quot;geometry&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc Location)</span></span> GormValue(ctx context.Context, db *gorm.DB) clause.Expr &#123;</span><br><span class="line"> <span class="keyword">return</span> clause.Expr&#123;</span><br><span class="line">   SQL:  <span class="string">&quot;ST_PointFromText(?)&quot;</span>,</span><br><span class="line">   Vars: []<span class="keyword">interface</span>&#123;&#125;&#123;fmt.Sprintf(<span class="string">&quot;POINT(%d %d)&quot;</span>, loc.X, loc.Y)&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> Name     <span class="type">string</span></span><br><span class="line"> Location Location</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;User&#123;</span><br><span class="line"> Name:     <span class="string">&quot;jinzhu&quot;</span>,</span><br><span class="line"> Location: Location&#123;X: <span class="number">100</span>, Y: <span class="number">100</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// INSERT INTO `users` (`name`,`location`) VALUES (&quot;jinzhu&quot;,ST_PointFromText(&quot;POINT(100 100)&quot;))</span></span><br></pre></td></tr></table></figure>

<h2 id="高级选项-1"><a href="#高级选项-1" class="headerlink" title="高级选项"></a>高级选项</h2><h3 id="关联创建"><a href="#关联创建" class="headerlink" title="关联创建"></a>关联创建</h3><p>创建关联数据时，如果关联值是非零值，这些关联会被 upsert，且它们的 <code>Hook</code><br>方法也会被调用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line"> gorm.Model</span><br><span class="line"> Number   <span class="type">string</span></span><br><span class="line"> UserID   <span class="type">uint</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> gorm.Model</span><br><span class="line"> Name       <span class="type">string</span></span><br><span class="line"> CreditCard CreditCard</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;User&#123;</span><br><span class="line"> Name: <span class="string">&quot;jinzhu&quot;</span>,</span><br><span class="line"> CreditCard: CreditCard&#123;Number: <span class="string">&quot;411111111111&quot;</span>&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// INSERT INTO `users` ...</span></span><br><span class="line"><span class="comment">// INSERT INTO `credit_cards` ...</span></span><br></pre></td></tr></table></figure>

<p>您也可以通过 <code>Select</code>、 <code>Omit</code> 跳过关联保存，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.Omit(<span class="string">&quot;CreditCard&quot;</span>).Create(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过所有关联</span></span><br><span class="line">db.Omit(clause.Associations).Create(&amp;user)</span><br></pre></td></tr></table></figure>

<h3 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h3><p>您可以通过标签 <code>default</code> 为字段定义默认值，如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID   <span class="type">int64</span></span><br><span class="line"> Name <span class="type">string</span> <span class="string">`gorm:&quot;default:galeone&quot;`</span></span><br><span class="line"> Age  <span class="type">int64</span>  <span class="string">`gorm:&quot;default:18&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插入记录到数据库时，默认值 <em>会被用于</em> 填充值为 零值 的字段</p>
<blockquote>
<p><strong>注意</strong> 像 <code>0</code>、<code>&#39;&#39;</code>、<code>false</code><br>等零值，不会将这些字段定义的默认值保存到数据库。您需要使用指针类型或<br>Scanner&#x2F;Valuer 来避免这个问题，例如：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> gorm.Model</span><br><span class="line"> Name <span class="type">string</span></span><br><span class="line"> Age  *<span class="type">int</span>           <span class="string">`gorm:&quot;default:18&quot;`</span></span><br><span class="line"> Active sql.NullBool <span class="string">`gorm:&quot;default:true&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong> 若要数据库有默认、虚拟&#x2F;生成的值，你必须为字段设置 <code>default</code><br>标签。若要在迁移时跳过默认值定义，你可以使用 <code>default:(-)</code>，例如：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line"> ID        <span class="type">string</span> <span class="string">`gorm:&quot;default:uuid_generate_v3()&quot;`</span> <span class="comment">// db func</span></span><br><span class="line"> FirstName <span class="type">string</span></span><br><span class="line"> LastName  <span class="type">string</span></span><br><span class="line"> Age       <span class="type">uint8</span></span><br><span class="line"> FullName  <span class="type">string</span> <span class="string">`gorm:&quot;-&gt;;type:GENERATED ALWAYS AS (concat(firstname,&#x27; &#x27;,lastname));default:(-);&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用虚拟&#x2F;生成的值时，你可能需要禁用它的创建、更新权限，查看 字段级权限<br>获取详情</p>
<h3 id="Upsert-及冲突"><a href="#Upsert-及冲突" class="headerlink" title="Upsert 及冲突"></a>Upsert 及冲突</h3><p>GORM 为不同数据库提供了兼容的 Upsert 支持</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/gorm/clause&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在冲突时，什么都不做</span></span><br><span class="line">db.Clauses(clause.OnConflict&#123;DoNothing: <span class="literal">true</span>&#125;).Create(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在`id`冲突时，将列更新为默认值</span></span><br><span class="line">db.Clauses(clause.OnConflict&#123;</span><br><span class="line"> Columns:   []clause.Column&#123;&#123;Name: <span class="string">&quot;id&quot;</span>&#125;&#125;,</span><br><span class="line"> DoUpdates: clause.Assignments(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>&#125;),</span><br><span class="line">&#125;).Create(&amp;users)</span><br><span class="line"><span class="comment">// MERGE INTO &quot;users&quot; USING *** WHEN NOT MATCHED THEN INSERT *** WHEN MATCHED THEN UPDATE SET ***; SQL Server</span></span><br><span class="line"><span class="comment">// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE ***; MySQL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用SQL语句</span></span><br><span class="line">db.Clauses(clause.OnConflict&#123;</span><br><span class="line"> Columns:   []clause.Column&#123;&#123;Name: <span class="string">&quot;id&quot;</span>&#125;&#125;,</span><br><span class="line"> DoUpdates: clause.Assignments(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;count&quot;</span>: gorm.Expr(<span class="string">&quot;GREATEST(count, VALUES(count))&quot;</span>)&#125;),</span><br><span class="line">&#125;).Create(&amp;users)</span><br><span class="line"><span class="comment">// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE `count`=GREATEST(count, VALUES(count));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在`id`冲突时，将列更新为新值</span></span><br><span class="line">db.Clauses(clause.OnConflict&#123;</span><br><span class="line"> Columns:   []clause.Column&#123;&#123;Name: <span class="string">&quot;id&quot;</span>&#125;&#125;,</span><br><span class="line"> DoUpdates: clause.AssignmentColumns([]<span class="type">string</span>&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>&#125;),</span><br><span class="line">&#125;).Create(&amp;users)</span><br><span class="line"><span class="comment">// MERGE INTO &quot;users&quot; USING *** WHEN NOT MATCHED THEN INSERT *** WHEN MATCHED THEN UPDATE SET &quot;name&quot;=&quot;excluded&quot;.&quot;name&quot;; SQL Server</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; *** ON CONFLICT (&quot;id&quot;) DO UPDATE SET &quot;name&quot;=&quot;excluded&quot;.&quot;name&quot;, &quot;age&quot;=&quot;excluded&quot;.&quot;age&quot;; PostgreSQL</span></span><br><span class="line"><span class="comment">// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE `name`=VALUES(name),`age=VALUES(age); MySQL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在冲突时，更新除主键以外的所有列到新值。</span></span><br><span class="line">db.Clauses(clause.OnConflict&#123;</span><br><span class="line"> UpdateAll: <span class="literal">true</span>,</span><br><span class="line">&#125;).Create(&amp;users)</span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; *** ON CONFLICT (&quot;id&quot;) DO UPDATE SET &quot;name&quot;=&quot;excluded&quot;.&quot;name&quot;, &quot;age&quot;=&quot;excluded&quot;.&quot;age&quot;, ...;</span></span><br></pre></td></tr></table></figure>

<p>您还可以查看 高级查询 中的 <code>FirstOrInit</code>、<code>FirstOrCreate</code></p>
<h1 id="gorm查询记录"><a href="#gorm查询记录" class="headerlink" title="gorm查询记录"></a>gorm查询记录</h1><h2 id="检索单个对象"><a href="#检索单个对象" class="headerlink" title="检索单个对象"></a>检索单个对象</h2><p>GORM 提供了 <code>First</code>、<code>Take</code>、<code>Last</code><br>方法，以便从数据库中检索单个对象。当查询数据库时它添加了 <code>LIMIT 1</code><br>条件，且没有找到记录时，它会返回 <code>ErrRecordNotFound</code> 错误</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取第一条记录（主键升序）</span></span><br><span class="line">db.First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users ORDER BY id LIMIT 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取一条记录，没有指定排序字段</span></span><br><span class="line">db.Take(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users LIMIT 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取最后一条记录（主键降序）</span></span><br><span class="line">db.Last(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users ORDER BY id DESC LIMIT 1;</span></span><br><span class="line"></span><br><span class="line">result := db.First(&amp;user)</span><br><span class="line">result.RowsAffected <span class="comment">// 返回找到的记录数</span></span><br><span class="line">result.Error        <span class="comment">// returns error or nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查 ErrRecordNotFound 错误</span></span><br><span class="line">errors.Is(result.Error, gorm.ErrRecordNotFound)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果你想避免<code>ErrRecordNotFound</code>错误，你可以使用<code>Find</code>，比如<code>db.Limit(1).Find(&amp;user)</code>，<code>Find</code>方法可以接受struct和slice的数据。</p>
</blockquote>
<p><code>First</code> 和 <code>Last</code><br>会根据主键排序，分别查询第一条和最后一条记录。只有在目标 struct<br>是指针或者通过 <code>db.Model()</code> 指定 model 时，该方法才有效。此外，如果相关<br>model 没有定义主键，那么将按 model 的第一个字段进行排序。例如:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user User</span><br><span class="line"><span class="keyword">var</span> users []User  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 有效，因为目标 struct 是指针</span></span><br><span class="line">db.First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` ORDER BY `users`.`id` LIMIT 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 有效，因为通过 `db.Model()` 指定了 model</span></span><br><span class="line">result := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">db.Model(&amp;User&#123;&#125;).First(&amp;result)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` ORDER BY `users`.`id` LIMIT 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 无效</span></span><br><span class="line">result := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).First(&amp;result)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配合 Take 有效</span></span><br><span class="line">result := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).Take(&amp;result)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 未指定主键，会根据第一个字段排序(即：`Code`)</span></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> &#123;</span><br><span class="line"> Code <span class="type">string</span></span><br><span class="line"> Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line">db.First(&amp;Language&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM `languages` ORDER BY `languages`.`code` LIMIT 1</span></span><br></pre></td></tr></table></figure>

<h3 id="用主键检索"><a href="#用主键检索" class="headerlink" title="用主键检索"></a>用主键检索</h3><p>如果主键是数字类型，您可以使用 内联条件<br>来检索对象。传入字符串参数时，需要特别注意 SQL 注入问题，查看 安全<br>获取详情.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.First(&amp;user, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE id = 10;</span></span><br><span class="line"></span><br><span class="line">db.First(&amp;user, <span class="string">&quot;10&quot;</span>)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE id = 10;</span></span><br><span class="line"></span><br><span class="line">db.Find(&amp;users, []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE id IN (1,2,3);</span></span><br></pre></td></tr></table></figure>

<p>如果主键是字符串（例如像 uuid），查询将被写成这样：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.First(&amp;user, <span class="string">&quot;id = ?&quot;</span>, <span class="string">&quot;1b74413f-f3b8-409f-ac47-e8c062e3472a&quot;</span>)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE id = &quot;1b74413f-f3b8-409f-ac47-e8c062e3472a&quot;;</span></span><br></pre></td></tr></table></figure>

<h2 id="检索全部对象"><a href="#检索全部对象" class="headerlink" title="检索全部对象"></a>检索全部对象</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取全部记录</span></span><br><span class="line">result := db.Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users;</span></span><br><span class="line"></span><br><span class="line">result.RowsAffected <span class="comment">// 返回找到的记录数，相当于 `len(users)`</span></span><br><span class="line">result.Error        <span class="comment">// returns error</span></span><br></pre></td></tr></table></figure>

<h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><h3 id="String-条件"><a href="#String-条件" class="headerlink" title="String 条件"></a>String 条件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取第一条匹配的记录</span></span><br><span class="line">db.Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;jinzhu&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取全部匹配的记录</span></span><br><span class="line">db.Where(<span class="string">&quot;name &lt;&gt; ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name &lt;&gt; &#x27;jinzhu&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IN</span></span><br><span class="line">db.Where(<span class="string">&quot;name IN ?&quot;</span>, []<span class="type">string</span>&#123;<span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;jinzhu 2&quot;</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name IN (&#x27;jinzhu&#x27;,&#x27;jinzhu 2&#x27;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LIKE</span></span><br><span class="line">db.Where(<span class="string">&quot;name LIKE ?&quot;</span>, <span class="string">&quot;%jin%&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name LIKE &#x27;%jin%&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AND</span></span><br><span class="line">db.Where(<span class="string">&quot;name = ? AND age &gt;= ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;22&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;jinzhu&#x27; AND age &gt;= 22;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Time</span></span><br><span class="line">db.Where(<span class="string">&quot;updated_at &gt; ?&quot;</span>, lastWeek).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE updated_at &gt; &#x27;2000-01-01 00:00:00&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BETWEEN</span></span><br><span class="line">db.Where(<span class="string">&quot;created_at BETWEEN ? AND ?&quot;</span>, lastWeek, today).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE created_at BETWEEN &#x27;2000-01-01 00:00:00&#x27; AND &#x27;2000-01-08 00:00:00&#x27;;</span></span><br></pre></td></tr></table></figure>

<h3 id="Struct-amp-Map-条件"><a href="#Struct-amp-Map-条件" class="headerlink" title="Struct &amp; Map 条件"></a>Struct &amp; Map 条件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Struct</span></span><br><span class="line">db.Where(&amp;User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Age: <span class="number">20</span>&#125;).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 20 ORDER BY id LIMIT 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Map</span></span><br><span class="line">db.Where(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">20</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 主键切片条件</span></span><br><span class="line">db.Where([]<span class="type">int64</span>&#123;<span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE id IN (20, 21, 22);</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong> 当使用结构作为条件查询时，GORM<br>只会查询非零值字段。这意味着如果您的字段值为 <code>0</code>、<code>&#39;&#39;</code>、<code>false</code> 或其他<br>零值，该字段不会被用于构建查询条件，例如：</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Where(&amp;User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Age: <span class="number">0</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot;;</span></span><br></pre></td></tr></table></figure>

<p>如果想要包含零值查询条件，你可以使用 map，其会包含所有 key-value<br>的查询条件，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Where(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;Name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;Age&quot;</span>: <span class="number">0</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 0;</span></span><br></pre></td></tr></table></figure>

<p>查看 指定结构体查询字段 获取详情.</p>
<h3 id="指定结构体查询字段"><a href="#指定结构体查询字段" class="headerlink" title="指定结构体查询字段"></a>指定结构体查询字段</h3><p>当使用 struct 进行查询时，你可以通过向 <code>Where()</code> 传入 struct<br>来指定查询条件的字段、值、表名，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Where(&amp;User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>&#125;, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Age&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 0;</span></span><br><span class="line"></span><br><span class="line">db.Where(&amp;User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>&#125;, <span class="string">&quot;Age&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 0;</span></span><br></pre></td></tr></table></figure>

<h3 id="内联条件"><a href="#内联条件" class="headerlink" title="内联条件"></a>内联条件</h3><p>查询条件也可以被内联到 <code>First</code> 和 <code>Find</code> 之类的方法中，其用法类似于<br><code>Where</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据主键获取记录，如果是非整型主键</span></span><br><span class="line">db.First(&amp;user, <span class="string">&quot;id = ?&quot;</span>, <span class="string">&quot;string_primary_key&quot;</span>)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE id = &#x27;string_primary_key&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Plain SQL</span></span><br><span class="line">db.Find(&amp;user, <span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot;;</span></span><br><span class="line"></span><br><span class="line">db.Find(&amp;users, <span class="string">&quot;name &lt;&gt; ? AND age &gt; ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>, <span class="number">20</span>)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name &lt;&gt; &quot;jinzhu&quot; AND age &gt; 20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Struct</span></span><br><span class="line">db.Find(&amp;users, User&#123;Age: <span class="number">20</span>&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Map</span></span><br><span class="line">db.Find(&amp;users, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;age&quot;</span>: <span class="number">20</span>&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 20;</span></span><br></pre></td></tr></table></figure>

<h3 id="Not-条件"><a href="#Not-条件" class="headerlink" title="Not 条件"></a>Not 条件</h3><p>构建 NOT 条件，用法与 <code>Where</code> 类似</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.Not(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE NOT name = &quot;jinzhu&quot; ORDER BY id LIMIT 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Not In</span></span><br><span class="line">db.Not(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: []<span class="type">string</span>&#123;<span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;jinzhu 2&quot;</span>&#125;&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name NOT IN (&quot;jinzhu&quot;, &quot;jinzhu 2&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Struct</span></span><br><span class="line">db.Not(User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Age: <span class="number">18</span>&#125;).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name &lt;&gt; &quot;jinzhu&quot; AND age &lt;&gt; 18 ORDER BY id LIMIT 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不在主键切片中的记录</span></span><br><span class="line">db.Not([]<span class="type">int64</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE id NOT IN (1,2,3) ORDER BY id LIMIT 1;</span></span><br></pre></td></tr></table></figure>

<h3 id="Or-条件"><a href="#Or-条件" class="headerlink" title="Or 条件"></a>Or 条件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.Where(<span class="string">&quot;role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>).Or(<span class="string">&quot;role = ?&quot;</span>, <span class="string">&quot;super_admin&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE role = &#x27;admin&#x27; OR role = &#x27;super_admin&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Struct</span></span><br><span class="line">db.Where(<span class="string">&quot;name = &#x27;jinzhu&#x27;&quot;</span>).Or(User&#123;Name: <span class="string">&quot;jinzhu 2&quot;</span>, Age: <span class="number">18</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;jinzhu&#x27; OR (name = &#x27;jinzhu 2&#x27; AND age = 18);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Map</span></span><br><span class="line">db.Where(<span class="string">&quot;name = &#x27;jinzhu&#x27;&quot;</span>).Or(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu 2&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;jinzhu&#x27; OR (name = &#x27;jinzhu 2&#x27; AND age = 18);</span></span><br></pre></td></tr></table></figure>

<p>更复杂的 SQL 查询， 请查看 高级查询中的组条件。</p>
<h2 id="选择特定字段"><a href="#选择特定字段" class="headerlink" title="选择特定字段"></a>选择特定字段</h2><p><code>Select</code> 允许您指定从数据库中检索哪些字段， 默认情况下，GORM<br>会检索所有字段。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.Select(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT name, age FROM users;</span></span><br><span class="line"></span><br><span class="line">db.Select([]<span class="type">string</span>&#123;<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT name, age FROM users;</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).Select(<span class="string">&quot;COALESCE(age,?)&quot;</span>, <span class="number">42</span>).Rows()</span><br><span class="line"><span class="comment">// SELECT COALESCE(age,&#x27;42&#x27;) FROM users;</span></span><br></pre></td></tr></table></figure>

<p>还可以看一看 智能选择字段</p>
<h2 id="Order"><a href="#Order" class="headerlink" title="Order"></a>Order</h2><p>指定从数据库检索记录时的排序方式</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.Order(<span class="string">&quot;age desc, name&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users ORDER BY age desc, name;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个 order</span></span><br><span class="line">db.Order(<span class="string">&quot;age desc&quot;</span>).Order(<span class="string">&quot;name&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users ORDER BY age desc, name;</span></span><br><span class="line"></span><br><span class="line">db.Clauses(clause.OrderBy&#123;</span><br><span class="line"> Expression: clause.Expr&#123;SQL: <span class="string">&quot;FIELD(id,?)&quot;</span>, Vars: []<span class="keyword">interface</span>&#123;&#125;&#123;[]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;&#125;, WithoutParentheses: <span class="literal">true</span>&#125;,</span><br><span class="line">&#125;).Find(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM users ORDER BY FIELD(id,1,2,3)</span></span><br></pre></td></tr></table></figure>

<h2 id="Limit-amp-Offset"><a href="#Limit-amp-Offset" class="headerlink" title="Limit &amp; Offset"></a>Limit &amp; Offset</h2><p><code>Limit</code> 指定获取记录的最大数量 <code>Offset</code><br>指定在开始返回记录之前要跳过的记录数量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">db.Limit(<span class="number">3</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users LIMIT 3;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 -1 消除 Limit 条件</span></span><br><span class="line">db.Limit(<span class="number">10</span>).Find(&amp;users1).Limit(<span class="number">-1</span>).Find(&amp;users2)</span><br><span class="line"><span class="comment">// SELECT * FROM users LIMIT 10; (users1)</span></span><br><span class="line"><span class="comment">// SELECT * FROM users; (users2)</span></span><br><span class="line"></span><br><span class="line">db.Offset(<span class="number">3</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users OFFSET 3;</span></span><br><span class="line"></span><br><span class="line">db.Limit(<span class="number">10</span>).Offset(<span class="number">5</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users OFFSET 5 LIMIT 10;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 -1 消除 Offset 条件</span></span><br><span class="line">db.Offset(<span class="number">10</span>).Find(&amp;users1).Offset(<span class="number">-1</span>).Find(&amp;users2)</span><br><span class="line"><span class="comment">// SELECT * FROM users OFFSET 10; (users1)</span></span><br><span class="line"><span class="comment">// SELECT * FROM users; (users2)</span></span><br></pre></td></tr></table></figure>

<p>查看 Pagination 学习如何写一个分页器</p>
<h2 id="Group-By-amp-Having"><a href="#Group-By-amp-Having" class="headerlink" title="Group By &amp; Having"></a>Group By &amp; Having</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> result <span class="keyword">struct</span> &#123;</span><br><span class="line"> Date  time.Time</span><br><span class="line"> Total <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Select(<span class="string">&quot;name, sum(age) as total&quot;</span>).Where(<span class="string">&quot;name LIKE ?&quot;</span>, <span class="string">&quot;group%&quot;</span>).Group(<span class="string">&quot;name&quot;</span>).First(&amp;result)</span><br><span class="line"><span class="comment">// SELECT name, sum(age) as total FROM `users` WHERE name LIKE &quot;group%&quot; GROUP BY `name` LIMIT 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Select(<span class="string">&quot;name, sum(age) as total&quot;</span>).Group(<span class="string">&quot;name&quot;</span>).Having(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;group&quot;</span>).Find(&amp;result)</span><br><span class="line"><span class="comment">// SELECT name, sum(age) as total FROM `users` GROUP BY `name` HAVING name = &quot;group&quot;</span></span><br><span class="line"></span><br><span class="line">rows, err := db.Table(<span class="string">&quot;orders&quot;</span>).Select(<span class="string">&quot;date(created_at) as date, sum(amount) as total&quot;</span>).Group(<span class="string">&quot;date(created_at)&quot;</span>).Rows()</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rows, err := db.Table(<span class="string">&quot;orders&quot;</span>).Select(<span class="string">&quot;date(created_at) as date, sum(amount) as total&quot;</span>).Group(<span class="string">&quot;date(created_at)&quot;</span>).Having(<span class="string">&quot;sum(amount) &gt; ?&quot;</span>, <span class="number">100</span>).Rows()</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Result <span class="keyword">struct</span> &#123;</span><br><span class="line"> Date  time.Time</span><br><span class="line"> Total <span class="type">int64</span></span><br><span class="line">&#125;</span><br><span class="line">db.Table(<span class="string">&quot;orders&quot;</span>).Select(<span class="string">&quot;date(created_at) as date, sum(amount) as total&quot;</span>).Group(<span class="string">&quot;date(created_at)&quot;</span>).Having(<span class="string">&quot;sum(amount) &gt; ?&quot;</span>, <span class="number">100</span>).Scan(&amp;results)</span><br></pre></td></tr></table></figure>

<h2 id="Distinct"><a href="#Distinct" class="headerlink" title="Distinct"></a>Distinct</h2><p>从模型中选择不相同的值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Distinct(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>).Order(<span class="string">&quot;name, age desc&quot;</span>).Find(&amp;results)</span><br></pre></td></tr></table></figure>

<p><code>Distinct</code> 也可以配合 <code>Pluck</code>, <code>Count</code> 使用</p>
<h2 id="Joins"><a href="#Joins" class="headerlink" title="Joins"></a>Joins</h2><p>指定 Joins 条件</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> result <span class="keyword">struct</span> &#123;</span><br><span class="line"> Name  <span class="type">string</span></span><br><span class="line"> Email <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Select(<span class="string">&quot;users.name, emails.email&quot;</span>).Joins(<span class="string">&quot;left join emails on emails.user_id = users.id&quot;</span>).Scan(&amp;result&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT users.name, emails.email FROM `users` left join emails on emails.user_id = users.id</span></span><br><span class="line"></span><br><span class="line">rows, err := db.Table(<span class="string">&quot;users&quot;</span>).Select(<span class="string">&quot;users.name, emails.email&quot;</span>).Joins(<span class="string">&quot;left join emails on emails.user_id = users.id&quot;</span>).Rows()</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).Select(<span class="string">&quot;users.name, emails.email&quot;</span>).Joins(<span class="string">&quot;left join emails on emails.user_id = users.id&quot;</span>).Scan(&amp;results)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带参数的多表连接</span></span><br><span class="line">db.Joins(<span class="string">&quot;JOIN emails ON emails.user_id = users.id AND emails.email = ?&quot;</span>, <span class="string">&quot;jinzhu@example.org&quot;</span>).Joins(<span class="string">&quot;JOIN credit_cards ON credit_cards.user_id = users.id&quot;</span>).Where(<span class="string">&quot;credit_cards.number = ?&quot;</span>, <span class="string">&quot;411111111111&quot;</span>).Find(&amp;user)</span><br></pre></td></tr></table></figure>

<h3 id="Joins-预加载"><a href="#Joins-预加载" class="headerlink" title="Joins 预加载"></a>Joins 预加载</h3><p>您可以使用 <code>Joins</code> 实现单条 SQL 预加载关联记录，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Joins(<span class="string">&quot;Company&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id`;</span></span><br></pre></td></tr></table></figure>

<p>条件连接</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Joins(<span class="string">&quot;Company&quot;</span>, DB.Where(&amp;Company&#123;Alive: <span class="literal">true</span>&#125;)).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT `users`.`id`,`users`.`name`,`users`.`age`,`Company`.`id` AS `Company__id`,`Company`.`name` AS `Company__name` FROM `users` LEFT JOIN `companies` AS `Company` ON `users`.`company_id` = `Company`.`id` AND `Company`.`alive` = true;</span></span><br></pre></td></tr></table></figure>

<h2 id="扫描结果"><a href="#扫描结果" class="headerlink" title="扫描结果"></a>扫描结果</h2><p>使用 <code>Find</code>方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Result <span class="keyword">struct</span> &#123;</span><br><span class="line"> Name <span class="type">string</span></span><br><span class="line"> Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result Result</span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).Select(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;Antonio&quot;</span>).Scan(&amp;result)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Raw SQL</span></span><br><span class="line">db.Raw(<span class="string">&quot;SELECT name, age FROM users WHERE name = ?&quot;</span>, <span class="string">&quot;Antonio&quot;</span>).Scan(&amp;result)</span><br></pre></td></tr></table></figure>

<h1 id="gorm高级查询"><a href="#gorm高级查询" class="headerlink" title="gorm高级查询"></a>gorm高级查询</h1><h2 id="智能选择字段"><a href="#智能选择字段" class="headerlink" title="智能选择字段"></a>智能选择字段</h2><p>GORM 允许通过<br><code>Select</code>方法选择特定的字段，如果您在应用程序中经常使用此功能，你也可以定义一个较小的结构体，以实现调用<br>API 时自动选择特定的字段，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID     <span class="type">uint</span></span><br><span class="line">  Name   <span class="type">string</span></span><br><span class="line">  Age    <span class="type">int</span></span><br><span class="line">  Gender <span class="type">string</span></span><br><span class="line">  <span class="comment">// 假设后面还有几百个字段...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> APIUser <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">uint</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询时会自动选择 `id`, `name` 字段</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Limit(<span class="number">10</span>).Find(&amp;APIUser&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT `id`, `name` FROM `users` LIMIT 10</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong> <code>QueryFields</code> 模式会根据当前 model 的所有字段名称进行<br>select。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">&quot;gorm.db&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line">  QueryFields: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">db.Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT `users`.`name`, `users`.`age`, ... FROM `users` // 带上这个选项</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Session Mode</span></span><br><span class="line">db.Session(&amp;gorm.Session&#123;QueryFields: <span class="literal">true</span>&#125;).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT `users`.`name`, `users`.`age`, ... FROM `users`</span></span><br></pre></td></tr></table></figure>

<h2 id="Locking-FOR-UPDATE"><a href="#Locking-FOR-UPDATE" class="headerlink" title="Locking (FOR UPDATE)"></a>Locking (FOR UPDATE)</h2><p>GORM 支持多种类型的锁，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.Clauses(clause.Locking&#123;Strength: <span class="string">&quot;UPDATE&quot;</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FOR UPDATE</span></span><br><span class="line"></span><br><span class="line">db.Clauses(clause.Locking&#123;</span><br><span class="line">  Strength: <span class="string">&quot;SHARE&quot;</span>,</span><br><span class="line">  Table: clause.Table&#123;Name: clause.CurrentTable&#125;,</span><br><span class="line">&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FOR SHARE OF `users`</span></span><br><span class="line"></span><br><span class="line">db.Clauses(clause.Locking&#123;</span><br><span class="line">  Strength: <span class="string">&quot;UPDATE&quot;</span>,</span><br><span class="line">  Options: <span class="string">&quot;NOWAIT&quot;</span>,</span><br><span class="line">&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FOR UPDATE NOWAIT</span></span><br></pre></td></tr></table></figure>

<h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><p>子查询可以嵌套在查询中，GORM 允许在使用 <code>*gorm.DB</code><br>对象作为参数时生成子查询</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.Where(<span class="string">&quot;amount &gt; (?)&quot;</span>, db.Table(<span class="string">&quot;orders&quot;</span>).Select(<span class="string">&quot;AVG(amount)&quot;</span>)).Find(&amp;orders)</span><br><span class="line"><span class="comment">// SELECT * FROM &quot;orders&quot; WHERE amount &gt; (SELECT AVG(amount) FROM &quot;orders&quot;);</span></span><br><span class="line"></span><br><span class="line">subQuery := db.Select(<span class="string">&quot;AVG(age)&quot;</span>).Where(<span class="string">&quot;name LIKE ?&quot;</span>, <span class="string">&quot;name%&quot;</span>).Table(<span class="string">&quot;users&quot;</span>)</span><br><span class="line">db.Select(<span class="string">&quot;AVG(age) as avgage&quot;</span>).Group(<span class="string">&quot;name&quot;</span>).Having(<span class="string">&quot;AVG(age) &gt; (?)&quot;</span>, subQuery).Find(&amp;results)</span><br><span class="line"><span class="comment">// SELECT AVG(age) as avgage FROM `users` GROUP BY `name` HAVING AVG(age) &gt; (SELECT AVG(age) FROM `users` WHERE name LIKE &quot;name%&quot;)</span></span><br></pre></td></tr></table></figure>

<h3 id="From-子查询"><a href="#From-子查询" class="headerlink" title="From 子查询"></a>From 子查询</h3><p>GORM 允许您在 <code>Table</code> 方法中通过 FROM 子句使用子查询，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.Table(<span class="string">&quot;(?) as u&quot;</span>, db.Model(&amp;User&#123;&#125;).Select(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>)).Where(<span class="string">&quot;age = ?&quot;</span>, <span class="number">18</span>&#125;).Find(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM (SELECT `name`,`age` FROM `users`) as u WHERE `age` = 18</span></span><br><span class="line"></span><br><span class="line">subQuery1 := db.Model(&amp;User&#123;&#125;).Select(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">subQuery2 := db.Model(&amp;Pet&#123;&#125;).Select(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">db.Table(<span class="string">&quot;(?) as u, (?) as p&quot;</span>, subQuery1, subQuery2).Find(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM (SELECT `name` FROM `users`) as u, (SELECT `name` FROM `pets`) as p</span></span><br></pre></td></tr></table></figure>

<h2 id="Group-条件"><a href="#Group-条件" class="headerlink" title="Group 条件"></a>Group 条件</h2><p>使用 Group 条件可以更轻松的编写复杂 SQL</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.Where(</span><br><span class="line">    db.Where(<span class="string">&quot;pizza = ?&quot;</span>, <span class="string">&quot;pepperoni&quot;</span>).Where(db.Where(<span class="string">&quot;size = ?&quot;</span>, <span class="string">&quot;small&quot;</span>).Or(<span class="string">&quot;size = ?&quot;</span>, <span class="string">&quot;medium&quot;</span>)),</span><br><span class="line">).Or(</span><br><span class="line">    db.Where(<span class="string">&quot;pizza = ?&quot;</span>, <span class="string">&quot;hawaiian&quot;</span>).Where(<span class="string">&quot;size = ?&quot;</span>, <span class="string">&quot;xlarge&quot;</span>),</span><br><span class="line">).Find(&amp;Pizza&#123;&#125;).Statement</span><br><span class="line"></span><br><span class="line"><span class="comment">// SELECT * FROM `pizzas` WHERE (pizza = &quot;pepperoni&quot; AND (size = &quot;small&quot; OR size = &quot;medium&quot;)) OR (pizza = &quot;hawaiian&quot; AND size = &quot;xlarge&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="带多个列的-In"><a href="#带多个列的-In" class="headerlink" title="带多个列的 In"></a>带多个列的 In</h2><p>带多个列的 In 查询</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Where(<span class="string">&quot;(name, age, role) IN ?&quot;</span>, [][]<span class="keyword">interface</span>&#123;&#125;&#123;&#123;<span class="string">&quot;jinzhu&quot;</span>, <span class="number">18</span>, <span class="string">&quot;admin&quot;</span>&#125;, &#123;<span class="string">&quot;jinzhu2&quot;</span>, <span class="number">19</span>, <span class="string">&quot;user&quot;</span>&#125;&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE (name, age, role) IN ((&quot;jinzhu&quot;, 18, &quot;admin&quot;), (&quot;jinzhu 2&quot;, 19, &quot;user&quot;));</span></span><br></pre></td></tr></table></figure>

<h2 id="命名参数"><a href="#命名参数" class="headerlink" title="命名参数"></a>命名参数</h2><p>GORM 支持 <code>sql.NamedArg</code> 和 <code>map[string]interface&#123;&#125;&#123;&#125;</code><br>形式的命名参数，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Where(<span class="string">&quot;name1 = @name OR name2 = @name&quot;</span>, sql.Named(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>)).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE name1 = &quot;jinzhu&quot; OR name2 = &quot;jinzhu&quot;</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">&quot;name1 = @name OR name2 = @name&quot;</span>, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>&#125;).First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE name1 = &quot;jinzhu&quot; OR name2 = &quot;jinzhu&quot; ORDER BY `users`.`id` LIMIT 1</span></span><br></pre></td></tr></table></figure>

<h2 id="Find-至-map"><a href="#Find-至-map" class="headerlink" title="Find 至 map"></a>Find 至 map</h2><p>GORM 允许扫描结果至 <code>map[string]interface&#123;&#125;</code> 或<br><code>[]map[string]interface&#123;&#125;</code>，此时别忘了指定 <code>Model</code> 或 <code>Table</code>，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">result := <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">db.Model(&amp;User&#123;&#125;).First(&amp;result, <span class="string">&quot;id = ?&quot;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> results []<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).Find(&amp;results)</span><br></pre></td></tr></table></figure>

<h2 id="FirstOrInit"><a href="#FirstOrInit" class="headerlink" title="FirstOrInit"></a>FirstOrInit</h2><p>获取第一条匹配的记录，或者根据给定的条件初始化一个实例（仅支持 sturct 和<br>map 条件）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，则根据给定的条件初始化一条记录</span></span><br><span class="line">db.FirstOrInit(&amp;user, User&#123;Name: <span class="string">&quot;non_existing&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// user -&gt; User&#123;Name: &quot;non_existing&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 111, Name: &quot;Jinzhu&quot;, Age: 18&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user</span></span><br><span class="line">db.FirstOrInit(&amp;user, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 111, Name: &quot;Jinzhu&quot;, Age: 18&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果没有找到记录，可以使用包含更多的属性的结构体初始化 user，<code>Attrs</code><br>不会被用于生成查询 SQL</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，则根据给定的条件以及 Attrs 初始化 user</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;non_existing&quot;</span>&#125;).Attrs(User&#123;Age: <span class="number">20</span>&#125;).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM USERS WHERE name = &#x27;non_existing&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;Name: &quot;non_existing&quot;, Age: 20&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 未找到 user，则根据给定的条件以及 Attrs 初始化 user</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;non_existing&quot;</span>&#125;).Attrs(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM USERS WHERE name = &#x27;non_existing&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;Name: &quot;non_existing&quot;, Age: 20&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user，则忽略 Attrs</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;Jinzhu&quot;</span>&#125;).Attrs(User&#123;Age: <span class="number">20</span>&#125;).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM USERS WHERE name = jinzhu&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 111, Name: &quot;Jinzhu&quot;, Age: 18&#125;</span></span><br></pre></td></tr></table></figure>

<p>不管是否找到记录，<code>Assign</code> 都会将属性赋值给<br>struct，但这些属性不会被用于生成查询 SQL，也不会被保存到数据库</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，根据条件和 Assign 属性初始化 struct</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;non_existing&quot;</span>&#125;).Assign(User&#123;Age: <span class="number">20</span>&#125;).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// user -&gt; User&#123;Name: &quot;non_existing&quot;, Age: 20&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到 `name` = `jinzhu` 的记录，依然会更新 Assign 相关的属性</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;Jinzhu&quot;</span>&#125;).Assign(User&#123;Age: <span class="number">20</span>&#125;).FirstOrInit(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM USERS WHERE name = jinzhu&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 111, Name: &quot;Jinzhu&quot;, Age: 20&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="FirstOrCreate"><a href="#FirstOrCreate" class="headerlink" title="FirstOrCreate"></a>FirstOrCreate</h2><p>获取第一条匹配的记录，或者根据给定的条件创建一条新纪录（仅支持 sturct 和<br>map 条件）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，则根据给定条件创建一条新纪录</span></span><br><span class="line">db.FirstOrCreate(&amp;user, User&#123;Name: <span class="string">&quot;non_existing&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; (name) VALUES (&quot;non_existing&quot;);</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 112, Name: &quot;non_existing&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 111, Name: &quot;jinzhu&quot;, &quot;Age&quot;: 18&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果没有找到记录，可以使用包含更多的属性的结构体创建记录，<code>Attrs</code><br>不会被用于生成查询 SQL 。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，根据条件和 Assign 属性创建记录</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;non_existing&quot;</span>&#125;).Attrs(User&#123;Age: <span class="number">20</span>&#125;).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;non_existing&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; (name, age) VALUES (&quot;non_existing&quot;, 20);</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 112, Name: &quot;non_existing&quot;, Age: 20&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user，则忽略 Attrs</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).Attrs(User&#123;Age: <span class="number">20</span>&#125;).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;jinzhu&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 111, Name: &quot;jinzhu&quot;, Age: 18&#125;</span></span><br></pre></td></tr></table></figure>

<p>不管是否找到记录，<code>Assign</code> 都会将属性赋值给 struct，并将结果写回数据库</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未找到 user，根据条件和 Assign 属性创建记录</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;non_existing&quot;</span>&#125;).Assign(User&#123;Age: <span class="number">20</span>&#125;).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;non_existing&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; (name, age) VALUES (&quot;non_existing&quot;, 20);</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 112, Name: &quot;non_existing&quot;, Age: 20&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到了 `name` = `jinzhu` 的 user，依然会根据 Assign 更新记录</span></span><br><span class="line">db.Where(User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).Assign(User&#123;Age: <span class="number">20</span>&#125;).FirstOrCreate(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &#x27;jinzhu&#x27; ORDER BY id LIMIT 1;</span></span><br><span class="line"><span class="comment">// UPDATE users SET age=20 WHERE id = 111;</span></span><br><span class="line"><span class="comment">// user -&gt; User&#123;ID: 111, Name: &quot;jinzhu&quot;, Age: 20&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="优化器、索引提示"><a href="#优化器、索引提示" class="headerlink" title="优化器、索引提示"></a>优化器、索引提示</h2><p>优化器提示用于控制查询优化器选择某个查询执行计划，GORM 通过<br><code>gorm.io/hints</code> 提供支持，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/hints&quot;</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.New(<span class="string">&quot;MAX_EXECUTION_TIME(10000)&quot;</span>)).Find(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT * /*+ MAX_EXECUTION_TIME(10000) */ FROM `users`</span></span><br></pre></td></tr></table></figure>

<p>索引提示允许传递索引提示到数据库，以防查询计划器出现混乱。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/hints&quot;</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.UseIndex(<span class="string">&quot;idx_user_name&quot;</span>)).Find(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` USE INDEX (`idx_user_name`)</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.ForceIndex(<span class="string">&quot;idx_user_name&quot;</span>, <span class="string">&quot;idx_user_id&quot;</span>).ForJoin()).Find(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` FORCE INDEX FOR JOIN (`idx_user_name`,`idx_user_id`)&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="迭代"><a href="#迭代" class="headerlink" title="迭代"></a>迭代</h2><p>GORM 支持通过行进行迭代</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rows, err := db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Rows()</span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">  <span class="keyword">var</span> user User</span><br><span class="line">  <span class="comment">// ScanRows 方法用于将一行记录扫描至结构体</span></span><br><span class="line">  db.ScanRows(rows, &amp;user)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 业务逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FindInBatches"><a href="#FindInBatches" class="headerlink" title="FindInBatches"></a>FindInBatches</h2><p>用于批量查询并处理记录</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每次批量处理 100 条</span></span><br><span class="line">result := db.Where(<span class="string">&quot;processed = ?&quot;</span>, <span class="literal">false</span>).FindInBatches(&amp;results, <span class="number">100</span>, <span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB, batch <span class="type">int</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> _, result := <span class="keyword">range</span> results &#123;</span><br><span class="line">    <span class="comment">// 批量处理找到的记录</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tx.Save(&amp;results)</span><br><span class="line"></span><br><span class="line">  tx.RowsAffected <span class="comment">// 本次批量操作影响的记录数</span></span><br><span class="line"></span><br><span class="line">  batch <span class="comment">// Batch 1, 2, 3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果返回错误会终止后续批量操作</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">result.Error <span class="comment">// returned error</span></span><br><span class="line">result.RowsAffected <span class="comment">// 整个批量操作影响的记录数</span></span><br></pre></td></tr></table></figure>

<h2 id="查询钩子"><a href="#查询钩子" class="headerlink" title="查询钩子"></a>查询钩子</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> AfterFind(tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> u.Role == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">    u.Role = <span class="string">&quot;user&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Pluck"><a href="#Pluck" class="headerlink" title="Pluck"></a>Pluck</h2><p>Pluck<br>用于从数据库查询单个列，并将结果扫描到切片。如果您想要查询多列，您应该使用<br><code>Select</code> 和 <a target="_blank" rel="noopener" href="https://gorm.io/zh_CN/docs/query.html#scan"><code>Scan</code></a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ages []<span class="type">int64</span></span><br><span class="line">db.Model(&amp;users).Pluck(<span class="string">&quot;age&quot;</span>, &amp;ages)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> names []<span class="type">string</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Pluck(<span class="string">&quot;name&quot;</span>, &amp;names)</span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">&quot;deleted_users&quot;</span>).Pluck(<span class="string">&quot;name&quot;</span>, &amp;names)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Distinct Pluck</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Distinct().Pluck(<span class="string">&quot;Name&quot;</span>, &amp;names)</span><br><span class="line"><span class="comment">// SELECT DISTINCT `name` FROM `users`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 超过一列的查询，应该使用 `Scan` 或者 `Find`，例如：</span></span><br><span class="line">db.Select(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>).Scan(&amp;users)</span><br><span class="line">db.Select(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>).Find(&amp;users)</span><br></pre></td></tr></table></figure>

<h2 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h2><p><code>Scopes</code> 允许你指定常用的查询，可以在调用方法时引用这些查询</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AmountGreaterThan1000</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">&quot;amount &gt; ?&quot;</span>, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PaidWithCreditCard</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">&quot;pay_mode_sign = ?&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PaidWithCod</span><span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">  <span class="keyword">return</span> db.Where(<span class="string">&quot;pay_mode_sign = ?&quot;</span>, <span class="string">&quot;C&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OrderStatus</span><span class="params">(status []<span class="type">string</span>)</span></span> <span class="function"><span class="keyword">func</span> <span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span> <span class="params">(db *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">    <span class="keyword">return</span> db.Where(<span class="string">&quot;status IN (?)&quot;</span>, status)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, PaidWithCreditCard).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于 1000 的信用卡订单</span></span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, PaidWithCod).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于 1000 的货到付款订单</span></span><br><span class="line"></span><br><span class="line">db.Scopes(AmountGreaterThan1000, OrderStatus([]<span class="type">string</span>&#123;<span class="string">&quot;paid&quot;</span>, <span class="string">&quot;shipped&quot;</span>&#125;)).Find(&amp;orders)</span><br><span class="line"><span class="comment">// 查找所有金额大于 1000 且已付款或已发货的订单</span></span><br></pre></td></tr></table></figure>

<h2 id="Count"><a href="#Count" class="headerlink" title="Count"></a>Count</h2><p>Count 用于获取匹配的记录数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> count <span class="type">int64</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Or(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu 2&quot;</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT count(1) FROM users WHERE name = &#x27;jinzhu&#x27; OR name = &#x27;jinzhu 2&#x27;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT count(1) FROM users WHERE name = &#x27;jinzhu&#x27;; (count)</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">&quot;deleted_users&quot;</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT count(1) FROM deleted_users;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Count with Distinct</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Distinct(<span class="string">&quot;name&quot;</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT COUNT(DISTINCT(`name`)) FROM `users`</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">&quot;deleted_users&quot;</span>).Select(<span class="string">&quot;count(distinct(name))&quot;</span>).Count(&amp;count)</span><br><span class="line"><span class="comment">// SELECT count(distinct(name)) FROM deleted_users</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Count with Group</span></span><br><span class="line">users := []User&#123;</span><br><span class="line">  &#123;Name: <span class="string">&quot;name1&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;name2&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;name3&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;name3&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Group(<span class="string">&quot;name&quot;</span>).Count(&amp;count)</span><br><span class="line">count <span class="comment">// =&gt; 3</span></span><br></pre></td></tr></table></figure>

<h1 id="gorm更新"><a href="#gorm更新" class="headerlink" title="gorm更新"></a>gorm更新</h1><h2 id="保存所有字段"><a href="#保存所有字段" class="headerlink" title="保存所有字段"></a>保存所有字段</h2><p><code>Save</code> 会保存所有的字段，即使字段是零值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.First(&amp;user)</span><br><span class="line"></span><br><span class="line">user.Name = <span class="string">&quot;jinzhu 2&quot;</span></span><br><span class="line">user.Age = <span class="number">100</span></span><br><span class="line">db.Save(&amp;user)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;jinzhu 2&#x27;, age=100, birthday=&#x27;2016-01-01&#x27;, updated_at = &#x27;2013-11-17 21:34:10&#x27; WHERE id=111;</span></span><br></pre></td></tr></table></figure>

<h2 id="更新单个列"><a href="#更新单个列" class="headerlink" title="更新单个列"></a>更新单个列</h2><p>当使用 <code>Update</code> 更新单个列时，你需要指定条件，否则会返回<br><code>ErrMissingWhereClause</code> 错误，查看 Block Global Updates<br>获取详情。当使用了 <code>Model</code><br>方法，且该对象主键有值，该值会被用于构建条件，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 条件更新</span></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;active = ?&quot;</span>, <span class="literal">true</span>).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, updated_at=&#x27;2013-11-17 21:34:10&#x27; WHERE active=true;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// User 的 ID 是 `111`</span></span><br><span class="line">db.Model(&amp;user).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, updated_at=&#x27;2013-11-17 21:34:10&#x27; WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据条件和 model 的值进行更新</span></span><br><span class="line">db.Model(&amp;user).Where(<span class="string">&quot;active = ?&quot;</span>, <span class="literal">true</span>).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, updated_at=&#x27;2013-11-17 21:34:10&#x27; WHERE id=111 AND active=true;</span></span><br></pre></td></tr></table></figure>

<h2 id="更新多列"><a href="#更新多列" class="headerlink" title="更新多列"></a>更新多列</h2><p><code>Updates</code> 方法支持 <code>struct</code> 和 <code>map[string]interface&#123;&#125;</code> 参数。当使用<br><code>struct</code> 更新时，默认情况下，GORM 只会更新非零值的字段</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据 `struct` 更新属性，只会更新非零值的字段</span></span><br><span class="line">db.Model(&amp;user).Updates(User&#123;Name: <span class="string">&quot;hello&quot;</span>, Age: <span class="number">18</span>, Active: <span class="literal">false</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, age=18, updated_at = &#x27;2013-11-17 21:34:10&#x27; WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 `map` 更新属性</span></span><br><span class="line">db.Model(&amp;user).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>, <span class="string">&quot;active&quot;</span>: <span class="literal">false</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, age=18, active=false, updated_at=&#x27;2013-11-17 21:34:10&#x27; WHERE id=111;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong> 当通过 struct 更新时，GORM 只会更新非零字段。<br>如果您想确保指定字段被更新，你应该使用 <code>Select</code> 更新选定字段，或使用<br><code>map</code> 来完成更新操作</p>
</blockquote>
<h2 id="更新选定字段"><a href="#更新选定字段" class="headerlink" title="更新选定字段"></a>更新选定字段</h2><p>如果您想要在更新时选定、忽略某些字段，您可以使用 <code>Select</code>、<code>Omit</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Map 进行 Select</span></span><br><span class="line"><span class="comment">// User&#x27;s ID is `111`:</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">&quot;name&quot;</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>, <span class="string">&quot;active&quot;</span>: <span class="literal">false</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27; WHERE id=111;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Omit(<span class="string">&quot;name&quot;</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>, <span class="string">&quot;active&quot;</span>: <span class="literal">false</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET age=18, active=false, updated_at=&#x27;2013-11-17 21:34:10&#x27; WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Struct 进行 Select（会 select 零值的字段）</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;Age&quot;</span>).Updates(User&#123;Name: <span class="string">&quot;new_name&quot;</span>, Age: <span class="number">0</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;new_name&#x27;, age=0 WHERE id=111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Select 所有字段（查询包括零值字段的所有字段）</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">&quot;*&quot;</span>).Update(User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Role: <span class="string">&quot;admin&quot;</span>, Age: <span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Select 除 Role 外的所有字段（包括零值字段的所有字段）</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">&quot;*&quot;</span>).Omit(<span class="string">&quot;Role&quot;</span>).Update(User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Role: <span class="string">&quot;admin&quot;</span>, Age: <span class="number">0</span>&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="更新-Hook"><a href="#更新-Hook" class="headerlink" title="更新 Hook"></a>更新 Hook</h2><p>对于更新操作，GORM 支持<br><code>BeforeSave</code>、<code>BeforeUpdate</code>、<code>AfterSave</code>、<code>AfterUpdate</code><br>钩子，这些方法将在更新记录时被调用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeUpdate(tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> u.Role == <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;admin user not allowed to update&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h2><p>如果您尚未通过 <code>Model</code> 指定记录的主键，则 GORM 会执行批量更新</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据 struct 更新</span></span><br><span class="line">db.Model(User&#123;&#125;).Where(<span class="string">&quot;role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>).Updates(User&#123;Name: <span class="string">&quot;hello&quot;</span>, Age: <span class="number">18</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, age=18 WHERE role = &#x27;admin&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 map 更新</span></span><br><span class="line">db.Table(<span class="string">&quot;users&quot;</span>).Where(<span class="string">&quot;id IN ?&quot;</span>, []<span class="type">int</span>&#123;<span class="number">10</span>, <span class="number">11</span>&#125;).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, age=18 WHERE id IN (10, 11);</span></span><br></pre></td></tr></table></figure>

<h3 id="阻止全局更新"><a href="#阻止全局更新" class="headerlink" title="阻止全局更新"></a>阻止全局更新</h3><p>如果在没有任何条件的情况下执行批量更新，默认情况下，GORM<br>不会执行该操作，并返回 <code>ErrMissingWhereClause</code> 错误</p>
<p>对此，你必须加一些条件，或者使用原生 SQL，或者启用 <code>AllowGlobalUpdate</code><br>模式，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;User&#123;&#125;).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Error <span class="comment">// gorm.ErrMissingWhereClause</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;1 = 1&quot;</span>).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET `name` = &quot;jinzhu&quot; WHERE 1=1</span></span><br><span class="line"></span><br><span class="line">db.Exec(<span class="string">&quot;UPDATE users SET name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name = &quot;jinzhu&quot;</span></span><br><span class="line"></span><br><span class="line">db.Session(&amp;gorm.Session&#123;AllowGlobalUpdate: <span class="literal">true</span>&#125;).Model(&amp;User&#123;&#125;).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET `name` = &quot;jinzhu&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="更新的记录数"><a href="#更新的记录数" class="headerlink" title="更新的记录数"></a>更新的记录数</h3><p>获取受更新影响的行数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过 `RowsAffected` 得到更新的记录数</span></span><br><span class="line">result := db.Model(User&#123;&#125;).Where(<span class="string">&quot;role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>).Updates(User&#123;Name: <span class="string">&quot;hello&quot;</span>, Age: <span class="number">18</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, age=18 WHERE role = &#x27;admin&#x27;;</span></span><br><span class="line"></span><br><span class="line">result.RowsAffected <span class="comment">// 更新的记录数</span></span><br><span class="line">result.Error        <span class="comment">// 更新的错误</span></span><br></pre></td></tr></table></figure>

<h2 id="高级选项-2"><a href="#高级选项-2" class="headerlink" title="高级选项"></a>高级选项</h2><h3 id="使用-SQL-表达式更新"><a href="#使用-SQL-表达式更新" class="headerlink" title="使用 SQL 表达式更新"></a>使用 SQL 表达式更新</h3><p>GORM 允许使用 SQL 表达式更新列，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// product 的 ID 是 `3`</span></span><br><span class="line">db.Model(&amp;product).Update(<span class="string">&quot;price&quot;</span>, gorm.Expr(<span class="string">&quot;price * ? + ?&quot;</span>, <span class="number">2</span>, <span class="number">100</span>))</span><br><span class="line"><span class="comment">// UPDATE &quot;products&quot; SET &quot;price&quot; = price * 2 + 100, &quot;updated_at&quot; = &#x27;2013-11-17 21:34:10&#x27; WHERE &quot;id&quot; = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;price&quot;</span>: gorm.Expr(<span class="string">&quot;price * ? + ?&quot;</span>, <span class="number">2</span>, <span class="number">100</span>)&#125;)</span><br><span class="line"><span class="comment">// UPDATE &quot;products&quot; SET &quot;price&quot; = price * 2 + 100, &quot;updated_at&quot; = &#x27;2013-11-17 21:34:10&#x27; WHERE &quot;id&quot; = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).UpdateColumn(<span class="string">&quot;quantity&quot;</span>, gorm.Expr(<span class="string">&quot;quantity - ?&quot;</span>, <span class="number">1</span>))</span><br><span class="line"><span class="comment">// UPDATE &quot;products&quot; SET &quot;quantity&quot; = quantity - 1 WHERE &quot;id&quot; = 3;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;product).Where(<span class="string">&quot;quantity &gt; 1&quot;</span>).UpdateColumn(<span class="string">&quot;quantity&quot;</span>, gorm.Expr(<span class="string">&quot;quantity - ?&quot;</span>, <span class="number">1</span>))</span><br><span class="line"><span class="comment">// UPDATE &quot;products&quot; SET &quot;quantity&quot; = quantity - 1 WHERE &quot;id&quot; = 3 AND quantity &gt; 1;</span></span><br></pre></td></tr></table></figure>

<p>并且 GORM 也允许使用 SQL 表达式、自定义数据类型的 Context Valuer<br>来更新，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据自定义数据类型创建</span></span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> &#123;</span><br><span class="line">    X, Y <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(loc Location)</span></span> GormValue(ctx context.Context, db *gorm.DB) clause.Expr &#123;</span><br><span class="line">  <span class="keyword">return</span> clause.Expr&#123;</span><br><span class="line">    SQL:  <span class="string">&quot;ST_PointFromText(?)&quot;</span>,</span><br><span class="line">    Vars: []<span class="keyword">interface</span>&#123;&#125;&#123;fmt.Sprintf(<span class="string">&quot;POINT(%d %d)&quot;</span>, loc.X, loc.Y)&#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;ID: <span class="number">1</span>&#125;).Updates(User&#123;</span><br><span class="line">  Name:  <span class="string">&quot;jinzhu&quot;</span>,</span><br><span class="line">  Location: Location&#123;X: <span class="number">100</span>, Y: <span class="number">100</span>&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// UPDATE `user_with_points` SET `name`=&quot;jinzhu&quot;,`location`=ST_PointFromText(&quot;POINT(100 100)&quot;) WHERE `id` = 1</span></span><br></pre></td></tr></table></figure>

<h3 id="根据子查询进行更新"><a href="#根据子查询进行更新" class="headerlink" title="根据子查询进行更新"></a>根据子查询进行更新</h3><p>使用子查询更新表</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;user).Update(<span class="string">&quot;company_name&quot;</span>, db.Model(&amp;Company&#123;&#125;).Select(<span class="string">&quot;name&quot;</span>).Where(<span class="string">&quot;companies.id = users.company_id&quot;</span>))</span><br><span class="line"><span class="comment">// UPDATE &quot;users&quot; SET &quot;company_name&quot; = (SELECT name FROM companies WHERE companies.id = users.company_id);</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">&quot;users as u&quot;</span>).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Update(<span class="string">&quot;company_name&quot;</span>, db.Table(<span class="string">&quot;companies as c&quot;</span>).Select(<span class="string">&quot;name&quot;</span>).Where(<span class="string">&quot;c.id = u.company_id&quot;</span>))</span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">&quot;users as u&quot;</span>).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;&#123;<span class="string">&quot;company_name&quot;</span>: db.Table(<span class="string">&quot;companies as c&quot;</span>).Select(<span class="string">&quot;name&quot;</span>).Where(<span class="string">&quot;c.id = u.company_id&quot;</span>)&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="不使用-Hook-和时间追踪"><a href="#不使用-Hook-和时间追踪" class="headerlink" title="不使用 Hook 和时间追踪"></a>不使用 Hook 和时间追踪</h3><p>如果您想在更新时跳过 <code>Hook</code> 方法且不追踪更新时间，可以使用<br><code>UpdateColumn</code>、<code>UpdateColumns</code>，其用法类似于 <code>Update</code>、<code>Updates</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新单个列</span></span><br><span class="line">db.Model(&amp;user).UpdateColumn(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27; WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新多个列</span></span><br><span class="line">db.Model(&amp;user).UpdateColumns(User&#123;Name: <span class="string">&quot;hello&quot;</span>, Age: <span class="number">18</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, age=18 WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新选中的列</span></span><br><span class="line">db.Model(&amp;user).Select(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>).UpdateColumns(User&#123;Name: <span class="string">&quot;hello&quot;</span>, Age: <span class="number">0</span>&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET name=&#x27;hello&#x27;, age=0 WHERE id = 111;</span></span><br></pre></td></tr></table></figure>

<h3 id="返回修改行的数据"><a href="#返回修改行的数据" class="headerlink" title="返回修改行的数据"></a>返回修改行的数据</h3><p>返回被修改的数据，仅适用于支持 Returning 的数据库，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回所有列</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">DB.Model(&amp;users).Clauses(clause.Returning&#123;&#125;).Where(<span class="string">&quot;role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>).Update(<span class="string">&quot;salary&quot;</span>, gorm.Expr(<span class="string">&quot;salary * ?&quot;</span>, <span class="number">2</span>))</span><br><span class="line"><span class="comment">// UPDATE `users` SET `salary`=salary * 2,`updated_at`=&quot;2021-10-28 17:37:23.19&quot; WHERE role = &quot;admin&quot; RETURNING *</span></span><br><span class="line"><span class="comment">// users =&gt; []User&#123;&#123;ID: 1, Name: &quot;jinzhu&quot;, Role: &quot;admin&quot;, Salary: 100&#125;, &#123;ID: 2, Name: &quot;jinzhu.2&quot;, Role: &quot;admin&quot;, Salary: 1000&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回指定的列</span></span><br><span class="line">DB.Model(&amp;users).Clauses(clause.Returning&#123;Columns: []clause.Column&#123;&#123;Name: <span class="string">&quot;name&quot;</span>&#125;, &#123;Name: <span class="string">&quot;salary&quot;</span>&#125;&#125;&#125;).Where(<span class="string">&quot;role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>).Update(<span class="string">&quot;salary&quot;</span>, gorm.Expr(<span class="string">&quot;salary * ?&quot;</span>, <span class="number">2</span>))</span><br><span class="line"><span class="comment">// UPDATE `users` SET `salary`=salary * 2,`updated_at`=&quot;2021-10-28 17:37:23.19&quot; WHERE role = &quot;admin&quot; RETURNING `name`, `salary`</span></span><br><span class="line"><span class="comment">// users =&gt; []User&#123;&#123;ID: 0, Name: &quot;jinzhu&quot;, Role: &quot;&quot;, Salary: 100&#125;, &#123;ID: 0, Name: &quot;jinzhu.2&quot;, Role: &quot;&quot;, Salary: 1000&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="检查字段是否有变更？"><a href="#检查字段是否有变更？" class="headerlink" title="检查字段是否有变更？"></a>检查字段是否有变更？</h3><p>GORM 提供了 <code>Changed</code> 方法，它可以被用在 <strong>Before Update Hook</strong><br>里，它会返回字段是否有变更的布尔值</p>
<p><code>Changed</code> 方法只能与 <code>Update</code>、<code>Updates</code> 方法一起使用，并且它只是检查<br>Model 对象字段的值与 <code>Update</code>、<code>Updates</code><br>的值是否相等，如果值有变更，且字段没有被忽略，则返回 true</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeUpdate(tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果 Role 字段有变更</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Changed(<span class="string">&quot;Role&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;role not allowed to change&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> tx.Statement.Changed(<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;Admin&quot;</span>) &#123; <span class="comment">// 如果 Name 或 Role 字段有变更</span></span><br><span class="line">    tx.Statement.SetColumn(<span class="string">&quot;Age&quot;</span>, <span class="number">18</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果任意字段有变更</span></span><br><span class="line">    <span class="keyword">if</span> tx.Statement.Changed() &#123;</span><br><span class="line">        tx.Statement.SetColumn(<span class="string">&quot;RefreshedAt&quot;</span>, time.Now())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;ID: <span class="number">1</span>, Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu2&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// Changed(&quot;Name&quot;) =&gt; true</span></span><br><span class="line">db.Model(&amp;User&#123;ID: <span class="number">1</span>, Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// Changed(&quot;Name&quot;) =&gt; false, 因为 `Name` 没有变更</span></span><br><span class="line">db.Model(&amp;User&#123;ID: <span class="number">1</span>, Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).Select(<span class="string">&quot;Admin&quot;</span>).Updates(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu2&quot;</span>, <span class="string">&quot;admin&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// Changed(&quot;Name&quot;) =&gt; false, 因为 `Name` 没有被 Select 选中并更新</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;User&#123;ID: <span class="number">1</span>, Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).Updates(User&#123;Name: <span class="string">&quot;jinzhu2&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// Changed(&quot;Name&quot;) =&gt; true</span></span><br><span class="line">db.Model(&amp;User&#123;ID: <span class="number">1</span>, Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).Updates(User&#123;Name: <span class="string">&quot;jinzhu&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// Changed(&quot;Name&quot;) =&gt; false, 因为 `Name` 没有变更</span></span><br><span class="line">db.Model(&amp;User&#123;ID: <span class="number">1</span>, Name: <span class="string">&quot;jinzhu&quot;</span>&#125;).Select(<span class="string">&quot;Admin&quot;</span>).Updates(User&#123;Name: <span class="string">&quot;jinzhu2&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// Changed(&quot;Name&quot;) =&gt; false, 因为 `Name` 没有被 Select 选中并更新</span></span><br></pre></td></tr></table></figure>

<h3 id="在-Update-时修改值"><a href="#在-Update-时修改值" class="headerlink" title="在 Update 时修改值"></a>在 Update 时修改值</h3><p>若要在 Before 钩子中改变要更新的值，如果它是一个完整的更新，可以使用<br><code>Save</code>；否则，应该使用 <code>SetColumn</code> ，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(user *User)</span></span> BeforeSave(tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> pw, err := bcrypt.GenerateFromPassword(user.Password, <span class="number">0</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">    tx.Statement.SetColumn(<span class="string">&quot;EncryptedPassword&quot;</span>, pw)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> tx.Statement.Changed(<span class="string">&quot;Code&quot;</span>) &#123;</span><br><span class="line">    s.Age += <span class="number">20</span></span><br><span class="line">    tx.Statement.SetColumn(<span class="string">&quot;Age&quot;</span>, s.Age+<span class="number">20</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Update(<span class="string">&quot;Name&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="gorm删除"><a href="#gorm删除" class="headerlink" title="gorm删除"></a>gorm删除</h1><h2 id="删除一条记录"><a href="#删除一条记录" class="headerlink" title="删除一条记录"></a>删除一条记录</h2><p>删除一条记录时，删除对象需要指定主键，否则会触发 批量 Delete，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Email 的 ID 是 `10`</span></span><br><span class="line">db.Delete(&amp;email)</span><br><span class="line"><span class="comment">// DELETE from emails where id = 10;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 带额外条件的删除</span></span><br><span class="line">db.Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Delete(&amp;email)</span><br><span class="line"><span class="comment">// DELETE from emails where id = 10 AND name = &quot;jinzhu&quot;;</span></span><br></pre></td></tr></table></figure>

<h2 id="根据主键删除"><a href="#根据主键删除" class="headerlink" title="根据主键删除"></a>根据主键删除</h2><p>GORM<br>允许通过主键(可以是复合主键)和内联条件来删除对象，它可以使用数字（如以下例子。也可以使用字符串——译者注）。查看<br>查询-内联条件（Query Inline Conditions） 了解详情。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.Delete(&amp;User&#123;&#125;, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id = 10;</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;User&#123;&#125;, <span class="string">&quot;10&quot;</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id = 10;</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;users, []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;)</span><br><span class="line"><span class="comment">// DELETE FROM users WHERE id IN (1,2,3);</span></span><br></pre></td></tr></table></figure>

<h2 id="Delete-Hook"><a href="#Delete-Hook" class="headerlink" title="Delete Hook"></a>Delete Hook</h2><p>对于删除操作，GORM 支持 <code>BeforeDelete</code>、<code>AfterDelete</code><br>Hook，在删除记录时会调用这些方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span></span> BeforeDelete(tx *gorm.DB) (err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> u.Role == <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> errors.New(<span class="string">&quot;admin user not allowed to delete&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h2><p>如果指定的值不包括主属性，那么 GORM<br>会执行批量删除，它将删除所有匹配的记录</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Where(<span class="string">&quot;email LIKE ?&quot;</span>, <span class="string">&quot;%jinzhu%&quot;</span>).Delete(&amp;Email&#123;&#125;)</span><br><span class="line"><span class="comment">// DELETE from emails where email LIKE &quot;%jinzhu%&quot;;</span></span><br><span class="line"></span><br><span class="line">db.Delete(&amp;Email&#123;&#125;, <span class="string">&quot;email LIKE ?&quot;</span>, <span class="string">&quot;%jinzhu%&quot;</span>)</span><br><span class="line"><span class="comment">// DELETE from emails where email LIKE &quot;%jinzhu%&quot;;</span></span><br></pre></td></tr></table></figure>

<h3 id="阻止全局删除"><a href="#阻止全局删除" class="headerlink" title="阻止全局删除"></a>阻止全局删除</h3><p>如果在没有任何条件的情况下执行批量删除，GORM 不会执行该操作，并返回<br><code>ErrMissingWhereClause</code> 错误</p>
<p>对此，你必须加一些条件，或者使用原生 SQL，或者启用 <code>AllowGlobalUpdate</code><br>模式，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.Delete(&amp;User&#123;&#125;).Error <span class="comment">// gorm.ErrMissingWhereClause</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">&quot;1 = 1&quot;</span>).Delete(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE 1=1</span></span><br><span class="line"></span><br><span class="line">db.Exec(<span class="string">&quot;DELETE FROM users&quot;</span>)</span><br><span class="line"><span class="comment">// DELETE FROM users</span></span><br><span class="line"></span><br><span class="line">db.Session(&amp;gorm.Session&#123;AllowGlobalUpdate: <span class="literal">true</span>&#125;).Delete(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// DELETE FROM users</span></span><br></pre></td></tr></table></figure>

<h3 id="返回删除行的数据"><a href="#返回删除行的数据" class="headerlink" title="返回删除行的数据"></a>返回删除行的数据</h3><p>返回被删除的数据，仅适用于支持 Returning 的数据库，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回所有列</span></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">DB.Clauses(clause.Returning&#123;&#125;).Where(<span class="string">&quot;role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>).Delete(&amp;users)</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE role = &quot;admin&quot; RETURNING *</span></span><br><span class="line"><span class="comment">// users =&gt; []User&#123;&#123;ID: 1, Name: &quot;jinzhu&quot;, Role: &quot;admin&quot;, Salary: 100&#125;, &#123;ID: 2, Name: &quot;jinzhu.2&quot;, Role: &quot;admin&quot;, Salary: 1000&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回指定的列</span></span><br><span class="line">DB.Clauses(clause.Returning&#123;Columns: []clause.Column&#123;&#123;Name: <span class="string">&quot;name&quot;</span>&#125;, &#123;Name: <span class="string">&quot;salary&quot;</span>&#125;&#125;&#125;).Where(<span class="string">&quot;role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>).Delete(&amp;users)</span><br><span class="line"><span class="comment">// DELETE FROM `users` WHERE role = &quot;admin&quot; RETURNING `name`, `salary`</span></span><br><span class="line"><span class="comment">// users =&gt; []User&#123;&#123;ID: 0, Name: &quot;jinzhu&quot;, Role: &quot;&quot;, Salary: 100&#125;, &#123;ID: 0, Name: &quot;jinzhu.2&quot;, Role: &quot;&quot;, Salary: 1000&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h2><p>如果您的模型包含了一个 <code>gorm.deletedat</code> 字段（<code>gorm.Model</code><br>已经包含了该字段)，它将自动获得软删除的能力！</p>
<p>拥有软删除能力的模型调用 <code>Delete</code> 时，记录不会被数据库。但 GORM 会将<br><code>DeletedAt</code> 置为当前时间， 并且你不能再通过普通的查询方法找到该记录。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user 的 ID 是 `111`</span></span><br><span class="line">db.Delete(&amp;user)</span><br><span class="line"><span class="comment">// UPDATE users SET deleted_at=&quot;2013-10-29 10:23&quot; WHERE id = 111;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量删除</span></span><br><span class="line">db.Where(<span class="string">&quot;age = ?&quot;</span>, <span class="number">20</span>).Delete(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// UPDATE users SET deleted_at=&quot;2013-10-29 10:23&quot; WHERE age = 20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在查询时会忽略被软删除的记录</span></span><br><span class="line">db.Where(<span class="string">&quot;age = 20&quot;</span>).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;</span></span><br></pre></td></tr></table></figure>

<p>如果您不想引入 <code>gorm.Model</code>，您也可以这样启用软删除特性：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID      <span class="type">int</span></span><br><span class="line">  Deleted gorm.DeletedAt</span><br><span class="line">  Name    <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查找被软删除的记录"><a href="#查找被软删除的记录" class="headerlink" title="查找被软删除的记录"></a>查找被软删除的记录</h3><p>您可以使用 <code>Unscoped</code> 找到被软删除的记录</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Unscoped().Where(<span class="string">&quot;age = 20&quot;</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE age = 20;</span></span><br></pre></td></tr></table></figure>

<h3 id="永久删除"><a href="#永久删除" class="headerlink" title="永久删除"></a>永久删除</h3><p>您也可以使用 <code>Unscoped</code> 永久删除匹配的记录</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Unscoped().Delete(&amp;order)</span><br><span class="line"><span class="comment">// DELETE FROM orders WHERE id=10;</span></span><br></pre></td></tr></table></figure>

<h3 id="Delete-Flag"><a href="#Delete-Flag" class="headerlink" title="Delete Flag"></a>Delete Flag</h3><p>将 unix 时间戳作为 delete flag</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/plugin/soft_delete&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID        <span class="type">uint</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  DeletedAt soft_delete.DeletedAt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line">SELECT * FROM users WHERE deleted_at = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">UPDATE users SET deleted_at = <span class="comment">/* current unix second */</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>INFO</strong> 在配合 unique 字段使用软删除时，您需要使用这个基于 unix<br>时间戳的 <code>DeletedAt</code> 字段创建一个复合索引，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/plugin/soft_delete&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">ID        <span class="type">uint</span></span><br><span class="line">Name      <span class="type">string</span>                <span class="string">`gorm:&quot;uniqueIndex:udx_name&quot;`</span></span><br><span class="line">DeletedAt soft_delete.DeletedAt <span class="string">`gorm:&quot;uniqueIndex:udx_name&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>使用 <code>1</code> &#x2F; <code>0</code> 作为 delete flag</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/plugin/soft_delete&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID    <span class="type">uint</span></span><br><span class="line">  Name  <span class="type">string</span></span><br><span class="line">  IsDel soft_delete.DeletedAt <span class="string">`gorm:&quot;softDelete:flag&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line">SELECT * FROM users WHERE is_del = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">UPDATE users SET is_del = <span class="number">1</span> WHERE ID = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h1 id="SQL-构建器"><a href="#SQL-构建器" class="headerlink" title="SQL 构建器"></a>SQL 构建器</h1><h2 id="原生-SQL"><a href="#原生-SQL" class="headerlink" title="原生 SQL"></a>原生 SQL</h2><p>原生查询 SQL 和 <code>Scan</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Result <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result Result</span><br><span class="line">db.Raw(<span class="string">&quot;SELECT id, name, age FROM users WHERE name = ?&quot;</span>, <span class="number">3</span>).Scan(&amp;result)</span><br><span class="line"></span><br><span class="line">db.Raw(<span class="string">&quot;SELECT id, name, age FROM users WHERE name = ?&quot;</span>, <span class="number">3</span>).Scan(&amp;result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> age <span class="type">int</span></span><br><span class="line">db.Raw(<span class="string">&quot;SELECT SUM(age) FROM users WHERE role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>).Scan(&amp;age)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> users []User</span><br><span class="line">db.Raw(<span class="string">&quot;UPDATE users SET name = ? WHERE age = ? RETURNING id, name&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>, <span class="number">20</span>).Scan(&amp;users)</span><br></pre></td></tr></table></figure>

<p><code>Exec</code> 原生 SQL</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Exec(<span class="string">&quot;DROP TABLE users&quot;</span>)</span><br><span class="line">db.Exec(<span class="string">&quot;UPDATE orders SET shipped_at = ? WHERE id IN ?&quot;</span>, time.Now(), []<span class="type">int64</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exec with SQL Expression</span></span><br><span class="line">db.Exec(<span class="string">&quot;UPDATE users SET money = ? WHERE name = ?&quot;</span>, gorm.Expr(<span class="string">&quot;money * ? + ?&quot;</span>, <span class="number">10000</span>, <span class="number">1</span>), <span class="string">&quot;jinzhu&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="命名参数-1"><a href="#命名参数-1" class="headerlink" title="命名参数"></a>命名参数</h2><p>GORM 支持 <code>sql.NamedArg</code>、<code>map[string]interface&#123;&#125;&#123;&#125;</code> 或 struct<br>形式的命名参数，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">db.Where(<span class="string">&quot;name1 = @name OR name2 = @name&quot;</span>, sql.Named(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>)).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE name1 = &quot;jinzhu&quot; OR name2 = &quot;jinzhu&quot;</span></span><br><span class="line"></span><br><span class="line">db.Where(<span class="string">&quot;name1 = @name OR name2 = @name&quot;</span>, <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu2&quot;</span>&#125;).First(&amp;result3)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE name1 = &quot;jinzhu2&quot; OR name2 = &quot;jinzhu2&quot; ORDER BY `users`.`id` LIMIT 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原生 SQL 及命名参数</span></span><br><span class="line">db.Raw(<span class="string">&quot;SELECT * FROM users WHERE name1 = @name OR name2 = @name2 OR name3 = @name&quot;</span>,</span><br><span class="line">   sql.Named(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jinzhu1&quot;</span>), sql.Named(<span class="string">&quot;name2&quot;</span>, <span class="string">&quot;jinzhu2&quot;</span>)).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name1 = &quot;jinzhu1&quot; OR name2 = &quot;jinzhu2&quot; OR name3 = &quot;jinzhu1&quot;</span></span><br><span class="line"></span><br><span class="line">db.Exec(<span class="string">&quot;UPDATE users SET name1 = @name, name2 = @name2, name3 = @name&quot;</span>,</span><br><span class="line">   sql.Named(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jinzhunew&quot;</span>), sql.Named(<span class="string">&quot;name2&quot;</span>, <span class="string">&quot;jinzhunew2&quot;</span>))</span><br><span class="line"><span class="comment">// UPDATE users SET name1 = &quot;jinzhunew&quot;, name2 = &quot;jinzhunew2&quot;, name3 = &quot;jinzhunew&quot;</span></span><br><span class="line"></span><br><span class="line">db.Raw(<span class="string">&quot;SELECT * FROM users WHERE (name1 = @name AND name3 = @name) AND name2 = @name2&quot;</span>,</span><br><span class="line">   <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jinzhu&quot;</span>, <span class="string">&quot;name2&quot;</span>: <span class="string">&quot;jinzhu2&quot;</span>&#125;).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE (name1 = &quot;jinzhu&quot; AND name3 = &quot;jinzhu&quot;) AND name2 = &quot;jinzhu2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NamedArgument <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Name2 <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Raw(<span class="string">&quot;SELECT * FROM users WHERE (name1 = @Name AND name3 = @Name) AND name2 = @Name2&quot;</span>,</span><br><span class="line">     NamedArgument&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Name2: <span class="string">&quot;jinzhu2&quot;</span>&#125;).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE (name1 = &quot;jinzhu&quot; AND name3 = &quot;jinzhu&quot;) AND name2 = &quot;jinzhu2&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="DryRun-模式"><a href="#DryRun-模式" class="headerlink" title="DryRun 模式"></a>DryRun 模式</h2><p>在不执行的情况下生成 <code>SQL</code> 及其参数，可以用于准备或测试生成的 SQL</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stmt := db.Session(&amp;Session&#123;DryRun: <span class="literal">true</span>&#125;).First(&amp;user, <span class="number">1</span>).Statement</span><br><span class="line">stmt.SQL.String() <span class="comment">//=&gt; SELECT * FROM `users` WHERE `id` = $1 ORDER BY `id`</span></span><br><span class="line">stmt.Vars         <span class="comment">//=&gt; []interface&#123;&#125;&#123;1&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="ToSQL"><a href="#ToSQL" class="headerlink" title="ToSQL"></a>ToSQL</h2><p>返回生成的 <code>SQL</code> 但不执行。</p>
<p>GORM使用 database&#x2F;sql 的参数占位符来构建 SQL<br>语句，它会自动转义参数以避免 SQL 注入，但我们不保证生成 SQL<br>的安全，请只用于调试。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gosql := DB.ToSQL(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> *gorm.DB &#123;</span><br><span class="line">  <span class="keyword">return</span> tx.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;id = ?&quot;</span>, <span class="number">100</span>).Limit(<span class="number">10</span>).Order(<span class="string">&quot;age desc&quot;</span>).Find(&amp;[]User&#123;&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">sql <span class="comment">//=&gt; SELECT * FROM &quot;users&quot; WHERE id = 100 AND &quot;users&quot;.&quot;deleted_at&quot; IS NULL ORDER BY age desc LIMIT 10</span></span><br></pre></td></tr></table></figure>

<h2 id="Row-amp-Rows"><a href="#Row-amp-Rows" class="headerlink" title="Row &amp; Rows"></a><code>Row</code> &amp; <code>Rows</code></h2><p>获取 <code>*sql.Row</code> 结果</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 GORM API 构建 SQL</span></span><br><span class="line">row := db.Table(<span class="string">&quot;users&quot;</span>).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Select(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;age&quot;</span>).Row()</span><br><span class="line">row.Scan(&amp;name, &amp;age)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用原生 SQL</span></span><br><span class="line">row := db.Raw(<span class="string">&quot;select name, age, email from users where name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Row()</span><br><span class="line">row.Scan(&amp;name, &amp;age, &amp;email)</span><br></pre></td></tr></table></figure>

<p>获取 <code>*sql.Rows</code> 结果</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 GORM API 构建 SQL</span></span><br><span class="line">rows, err := db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Select(<span class="string">&quot;name, age, email&quot;</span>).Rows()</span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">  rows.Scan(&amp;name, &amp;age, &amp;email)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 业务逻辑...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原生 SQL</span></span><br><span class="line">rows, err := db.Raw(<span class="string">&quot;select name, age, email from users where name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Rows()</span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">  rows.Scan(&amp;name, &amp;age, &amp;email)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 业务逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转到 FindInBatches 获取如何在批量中查询和处理记录的信息， 转到 Group<br>条件 获取如何构建复杂 SQL 查询的信息</p>
<h2 id="将-sql-Rows-扫描至-model"><a href="#将-sql-Rows-扫描至-model" class="headerlink" title="将 sql.Rows 扫描至 model"></a>将 <code>sql.Rows</code> 扫描至 model</h2><p>使用 <code>ScanRows</code> 将一行记录扫描至 struct，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rows, err := db.Model(&amp;User&#123;&#125;).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Select(<span class="string">&quot;name, age, email&quot;</span>).Rows() <span class="comment">// (*sql.Rows, error)</span></span><br><span class="line"><span class="keyword">defer</span> rows.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> user User</span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">  <span class="comment">// ScanRows 将一行扫描至 user</span></span><br><span class="line">  db.ScanRows(rows, &amp;user)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 业务逻辑...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h2><p>在同一个 db tcp 连接中运行多个 SQL（不在事务中）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Connection(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  tx.Exec(<span class="string">&quot;SET my.role = ?&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br><span class="line"></span><br><span class="line">  tx.First(&amp;User&#123;&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="高级应用"><a href="#高级应用" class="headerlink" title="高级应用"></a>高级应用</h2><h3 id="子句（Clause）"><a href="#子句（Clause）" class="headerlink" title="子句（Clause）"></a>子句（Clause）</h3><p>GORM 使用 SQL builder 在内部生成 SQL，对于每个操作，GORM<br>创建一个<code>*gorm.Statement</code>对象，所有 GORM API<br>添加&#x2F;更改<code>Clause</code>，<code>Statement</code>最后，GORM 基于这些子句生成 SQL</p>
<p>例如，当使用 查询时<code>First</code>，它将以下子句添加到<code>Statement</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">clause.Select&#123;Columns: <span class="string">&quot;*&quot;</span>&#125;</span><br><span class="line">clause.From&#123;Tables: clause.CurrentTable&#125;</span><br><span class="line">clause.Limit&#123;Limit: <span class="number">1</span>&#125;</span><br><span class="line">clause.OrderByColumn&#123;</span><br><span class="line">  Column: clause.Column&#123;Table: clause.CurrentTable, Name: clause.PrimaryKey&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后 GORM 构建最终在<code>Query</code>回调中查询 SQL，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Statement.Build(<span class="string">&quot;SELECT&quot;</span>, <span class="string">&quot;FROM&quot;</span>, <span class="string">&quot;WHERE&quot;</span>, <span class="string">&quot;GROUP BY&quot;</span>, <span class="string">&quot;ORDER BY&quot;</span>, <span class="string">&quot;LIMIT&quot;</span>, <span class="string">&quot;FOR&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>生成SQL：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM <span class="string">`users`</span> ORDER BY <span class="string">`users`</span>.<span class="string">`id`</span> LIMIT <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>你可以定义自己的Clause并与 GORM 一起使用，它需要实现接口</p>
<h3 id="子句构造器"><a href="#子句构造器" class="headerlink" title="子句构造器"></a>子句构造器</h3><p>对于不同的数据库，子句可能会产生不同的 SQL，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Offset(<span class="number">10</span>).Limit(<span class="number">5</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">// Generated for SQL Server</span></span><br><span class="line"><span class="comment">// SELECT * FROM &quot;users&quot; OFFSET 10 ROW FETCH NEXT 5 ROWS ONLY</span></span><br><span class="line"><span class="comment">// Generated for MySQL</span></span><br><span class="line"><span class="comment">// SELECT * FROM `users` LIMIT 5 OFFSET 10</span></span><br></pre></td></tr></table></figure>

<p>支持是因为 GORM 允许数据库驱动注册 Clause Builder<br>替换默认的，以Limit为例</p>
<h3 id="子句选项"><a href="#子句选项" class="headerlink" title="子句选项"></a>子句选项</h3><p>GORM 定义了许多子句，并且一些子句提供了可用于您的应用程序的高级选项</p>
<p>尽管它们中的大多数很少使用，但如果您发现 GORM 公共 API<br>无法满足您的要求，不妨检查一下，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Clauses(clause.Insert&#123;Modifier: <span class="string">&quot;IGNORE&quot;</span>&#125;).Create(&amp;user)</span><br><span class="line"><span class="comment">// INSERT IGNORE INTO users (name,age...) VALUES (&quot;jinzhu&quot;,18...);</span></span><br></pre></td></tr></table></figure>

<h3 id="语句修饰符"><a href="#语句修饰符" class="headerlink" title="语句修饰符"></a>语句修饰符</h3><p>GORM 提供接口StatementModifier允许您修改语句以匹配您的要求，以Hints为例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/hints&quot;</span></span><br><span class="line"></span><br><span class="line">db.Clauses(hints.New(<span class="string">&quot;hint&quot;</span>)).Find(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// SELECT * /*+ hint */ FROM `users`</span></span><br></pre></td></tr></table></figure>

<h1 id="Belongs-To"><a href="#Belongs-To" class="headerlink" title="Belongs To"></a>Belongs To</h1><h2 id="Belongs-To-1"><a href="#Belongs-To-1" class="headerlink" title="Belongs To"></a>Belongs To</h2><p><code>belongs to</code> 会与另一个模型建立了一对一的连接。<br>这种模型的每一个实例都”属于”另一个模型的一个实例。</p>
<p>例如，您的应用包含 user 和 company，并且每个 user 能且只能被分配给一个<br>company。下面的类型就表示这种关系。 注意，在 <code>User</code> 对象中，有一个和<br><code>Company</code> 一样的 <code>CompanyID</code>。 默认情况下， <code>CompanyID</code> 被隐含地用来在<br><code>User</code> 和 <code>Company</code> 之间创建一个外键关系， 因此必须包含在 <code>User</code><br>结构体中才能填充 <code>Company</code> 内部结构体。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `User` 属于 `Company`，`CompanyID` 是外键</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  CompanyID <span class="type">int</span></span><br><span class="line">  Company   Company</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写外键"><a href="#重写外键" class="headerlink" title="重写外键"></a>重写外键</h2><p>要定义一个 belongs to<br>关系，数据库的表中必须存在外键。默认情况下，外键的名字，使用拥有者的类型名称加上表的主键的字段名字</p>
<p>例如，定义一个User实体属于Company实体，那么外键的名字一般使用CompanyID。</p>
<p>GORM同时提供自定义外键名字的方式，如下例所示。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name         <span class="type">string</span></span><br><span class="line">  CompanyRefer <span class="type">int</span></span><br><span class="line">  Company      Company <span class="string">`gorm:&quot;foreignKey:CompanyRefer&quot;`</span></span><br><span class="line">  <span class="comment">// 使用 CompanyRefer 作为外键</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写引用"><a href="#重写引用" class="headerlink" title="重写引用"></a>重写引用</h2><p>对于 belongs to 关系，GORM<br>通常使用数据库表，主表（拥有者）的主键值作为外键参考。<br>正如上面的例子，我们使用主表Company中的主键字段ID作为外键的参考值。</p>
<p>如果在Company实体中设置了User实体，那么GORM会自动把Company中的ID属性保存到User的CompanyID属性中。</p>
<p>同样的，您也可以使用标签 <code>references</code> 来更改它，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  CompanyID <span class="type">string</span></span><br><span class="line">  Company   Company <span class="string">`gorm:&quot;references:Code&quot;`</span> <span class="comment">// 使用 Code 作为引用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Code <span class="type">string</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Belongs-to-的-CRUD"><a href="#Belongs-to-的-CRUD" class="headerlink" title="Belongs to 的 CRUD"></a>Belongs to 的 CRUD</h2><p>点击 关联模式 链接获取 belongs to 相关的用法</p>
<h2 id="预加载"><a href="#预加载" class="headerlink" title="预加载"></a>预加载</h2><p>GORM允许通过使用<code>Preload</code>或者<code>Joins</code>来主动加载实体的关联关系，具体内容请参考，预加载（主动加载）</p>
<h2 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h2><p>你可以通过<code>OnUpdate</code>,<br><code>OnDelete</code>配置标签来增加关联关系的级联操作，如下面的例子，通过GORM可以完成用户和公司的级联更新和级联删除操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  CompanyID <span class="type">int</span></span><br><span class="line">  Company   Company <span class="string">`gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Company <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="gorm-Has-One关系"><a href="#gorm-Has-One关系" class="headerlink" title="gorm Has One关系"></a>gorm Has One关系</h1><h2 id="Has-One"><a href="#Has-One" class="headerlink" title="Has One"></a>Has One</h2><p><code>has one</code> 与另一个模型建立一对一的关联，但它和一对一关系有些许不同。<br>这种关联表明一个模型的每个实例都包含或拥有另一个模型的一个实例。</p>
<p>例如，您的应用包含 user 和 credit card 模型，且每个 user 只能有一张<br>credit card。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 有一张 CreditCard，UserID 是外键</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCard CreditCard</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number <span class="type">string</span></span><br><span class="line">  UserID <span class="type">uint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写外键-1"><a href="#重写外键-1" class="headerlink" title="重写外键"></a>重写外键</h2><p>对于 <code>has one</code><br>关系，同样必须存在外键字段。拥有者将把属于它的模型的主键保存到这个字段。</p>
<p>这个字段的名称通常由 <code>has one</code> 模型的类型加上其 <code>主键</code><br>生成，对于上面的例子，它是 <code>UserID</code>。</p>
<p>为 user 添加 credit card 时，它会将 user 的 <code>ID</code> 保存到自己的 <code>UserID</code><br>字段。</p>
<p>如果你想要使用另一个字段来保存该关系，你同样可以使用标签 <code>foreignKey</code><br>来更改它，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCard CreditCard <span class="string">`gorm:&quot;foreignKey:UserName&quot;`</span></span><br><span class="line">  <span class="comment">// 使用 UserName 作为外键</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number   <span class="type">string</span></span><br><span class="line">  UserName <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写引用-1"><a href="#重写引用-1" class="headerlink" title="重写引用"></a>重写引用</h2><p>默认情况下，拥有者实体会将 <code>has one</code><br>对应模型的主键保存为外键，您也可以修改它，用另一个字段来保存，例如下个这个使用<br><code>Name</code> 来保存的例子。</p>
<p>您可以使用标签 <code>references</code> 来更改它，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name       <span class="type">string</span>     <span class="string">`gorm:&quot;index&quot;`</span></span><br><span class="line">  CreditCard CreditCard <span class="string">`gorm:&quot;foreignkey:UserName;references:name&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number   <span class="type">string</span></span><br><span class="line">  UserName <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多态关联"><a href="#多态关联" class="headerlink" title="多态关联"></a>多态关联</h2><p>GORM 为 <code>has one</code> 和 <code>has many</code><br>提供了多态关联支持，它会将拥有者实体的表名、主键值都保存到多态类型的字段中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Cat <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID    <span class="type">int</span></span><br><span class="line">  Name  <span class="type">string</span></span><br><span class="line">  Toy   Toy <span class="string">`gorm:&quot;polymorphic:Owner;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Dog <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Toy  Toy <span class="string">`gorm:&quot;polymorphic:Owner;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Toy <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID        <span class="type">int</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  OwnerID   <span class="type">int</span></span><br><span class="line">  OwnerType <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;Dog&#123;Name: <span class="string">&quot;dog1&quot;</span>, Toy: Toy&#123;Name: <span class="string">&quot;toy1&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="comment">// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)</span></span><br><span class="line"><span class="comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1&quot;,&quot;1&quot;,&quot;dogs&quot;)</span></span><br></pre></td></tr></table></figure>

<p>您可以使用标签 <code>polymorphicValue</code> 来更改多态类型的值，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Dog <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Toy  Toy <span class="string">`gorm:&quot;polymorphic:Owner;polymorphicValue:master&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Toy <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID        <span class="type">int</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  OwnerID   <span class="type">int</span></span><br><span class="line">  OwnerType <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;Dog&#123;Name: <span class="string">&quot;dog1&quot;</span>, Toy: Toy&#123;Name: <span class="string">&quot;toy1&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="comment">// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)</span></span><br><span class="line"><span class="comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1&quot;,&quot;1&quot;,&quot;master&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="Has-One-的-CURD"><a href="#Has-One-的-CURD" class="headerlink" title="Has One 的 CURD"></a>Has One 的 CURD</h2><h2 id="预加载-1"><a href="#预加载-1" class="headerlink" title="预加载"></a>预加载</h2><p>GORM 可以通过 <code>Preload</code>、<code>Joins</code> 预加载 <code>has one</code> 关联的记录，查看<br>预加载 获取详情</p>
<h2 id="自引用-Has-One"><a href="#自引用-Has-One" class="headerlink" title="自引用 Has One"></a>自引用 Has One</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  ManagerID *<span class="type">uint</span></span><br><span class="line">  Manager   *User</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="外键约束-1"><a href="#外键约束-1" class="headerlink" title="外键约束"></a>外键约束</h2><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code><br>实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCard CreditCard <span class="string">`gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number <span class="type">string</span></span><br><span class="line">  UserID <span class="type">uint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你也可以在删除记录时通过 <code>Select</code> 来删除关联的记录，查看 Delete with<br>Select 获取详情</p>
<h1 id="gorm-Has-Many关系"><a href="#gorm-Has-Many关系" class="headerlink" title="gorm Has Many关系"></a>gorm Has Many关系</h1><h2 id="Has-Many"><a href="#Has-Many" class="headerlink" title="Has Many"></a>Has Many</h2><p><code>has many</code> 与另一个模型建立了一对多的连接。 不同于<br><code>has one</code>，拥有者可以有零或多个关联模型。</p>
<p>例如，您的应用包含 user 和 credit card 模型，且每个 user 可以有多张<br>credit card。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 有多张 CreditCard，UserID 是外键</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCards []CreditCard</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number <span class="type">string</span></span><br><span class="line">  UserID <span class="type">uint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写外键-2"><a href="#重写外键-2" class="headerlink" title="重写外键"></a>重写外键</h2><p>要定义 <code>has many</code> 关系，同样必须存在外键。<br>默认的外键名是拥有者的类型名加上其主键字段名</p>
<p>例如，要定义一个属于 <code>User</code> 的模型，则其外键应该是 <code>UserID</code>。</p>
<p>此外，想要使用另一个字段作为外键，您可以使用 <code>foreignKey</code> 标签自定义它：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCards []CreditCard <span class="string">`gorm:&quot;foreignKey:UserRefer&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number    <span class="type">string</span></span><br><span class="line">  UserRefer <span class="type">uint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写引用-2"><a href="#重写引用-2" class="headerlink" title="重写引用"></a>重写引用</h2><p>GORM 通常使用拥有者的主键作为外键的值。 对于上面的例子，它是 <code>User</code> 的<br><code>ID</code> 字段。</p>
<p>为 user 添加 credit card 时，GORM 会将 user 的 <code>ID</code> 字段保存到 credit<br>card 的 <code>UserID</code> 字段。</p>
<p>同样的，您也可以使用标签 <code>references</code> 来更改它，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  MemberNumber <span class="type">string</span></span><br><span class="line">  CreditCards  []CreditCard <span class="string">`gorm:&quot;foreignKey:UserNumber;references:MemberNumber&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number     <span class="type">string</span></span><br><span class="line">  UserNumber <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多态关联-1"><a href="#多态关联-1" class="headerlink" title="多态关联"></a>多态关联</h2><p>GORM 为 <code>has one</code> 和 <code>has many</code><br>提供了多态关联支持，它会将拥有者实体的表名、主键都保存到多态类型的字段中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Dog <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Toys []Toy <span class="string">`gorm:&quot;polymorphic:Owner;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Toy <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID        <span class="type">int</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  OwnerID   <span class="type">int</span></span><br><span class="line">  OwnerType <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;Dog&#123;Name: <span class="string">&quot;dog1&quot;</span>, Toys: []Toy&#123;&#123;Name: <span class="string">&quot;toy1&quot;</span>&#125;, &#123;Name: <span class="string">&quot;toy2&quot;</span>&#125;&#125;&#125;)</span><br><span class="line"><span class="comment">// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)</span></span><br><span class="line"><span class="comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1&quot;,&quot;1&quot;,&quot;dogs&quot;), (&quot;toy2&quot;,&quot;1&quot;,&quot;dogs&quot;)</span></span><br></pre></td></tr></table></figure>

<p>您可以使用标签 <code>polymorphicValue</code> 来更改多态类型的值，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Dog <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">int</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Toys []Toy <span class="string">`gorm:&quot;polymorphic:Owner;polymorphicValue:master&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Toy <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID        <span class="type">int</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  OwnerID   <span class="type">int</span></span><br><span class="line">  OwnerType <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;Dog&#123;Name: <span class="string">&quot;dog1&quot;</span>, Toys: []Toy&#123;&#123;Name: <span class="string">&quot;toy1&quot;</span>&#125;, &#123;Name: <span class="string">&quot;toy2&quot;</span>&#125;&#125;&#125;)</span><br><span class="line"><span class="comment">// INSERT INTO `dogs` (`name`) VALUES (&quot;dog1&quot;)</span></span><br><span class="line"><span class="comment">// INSERT INTO `toys` (`name`,`owner_id`,`owner_type`) VALUES (&quot;toy1&quot;,&quot;1&quot;,&quot;master&quot;), (&quot;toy2&quot;,&quot;1&quot;,&quot;master&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="Has-Many-的-CURD"><a href="#Has-Many-的-CURD" class="headerlink" title="Has Many 的 CURD"></a>Has Many 的 CURD</h2><p>查看 关联模式 获取 has many 相关的用法</p>
<h2 id="预加载-2"><a href="#预加载-2" class="headerlink" title="预加载"></a>预加载</h2><p>GORM 可以通过 <code>Preload</code> 预加载 has many 关联的记录，查看 预加载 获取详情</p>
<h2 id="自引用-Has-Many"><a href="#自引用-Has-Many" class="headerlink" title="自引用 Has Many"></a>自引用 Has Many</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  ManagerID *<span class="type">uint</span></span><br><span class="line">  Team      []User <span class="string">`gorm:&quot;foreignkey:ManagerID&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="外键约束-2"><a href="#外键约束-2" class="headerlink" title="外键约束"></a>外键约束</h2><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code><br>实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  CreditCards []CreditCard <span class="string">`gorm:&quot;constraint:OnUpdate:CASCADE,OnDelete:SET NULL;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Number <span class="type">string</span></span><br><span class="line">  UserID <span class="type">uint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你也可以在删除记录时通过 <code>Select</code> 来删除 has many 关联的记录，查看<br>Delete with Select 获取详情</p>
<h1 id="gorm-Many-To-Many关系"><a href="#gorm-Many-To-Many关系" class="headerlink" title="gorm Many To Many关系"></a>gorm Many To Many关系</h1><h2 id="Many-To-Many"><a href="#Many-To-Many" class="headerlink" title="Many To Many"></a>Many To Many</h2><p>Many to Many 会在两个 model 中添加一张连接表。</p>
<p>例如，您的应用包含了 user 和 language，且一个 user 可以说多种<br>language，多个 user 也可以说一种 language。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 拥有并属于多种 language，`user_languages` 是连接表</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []Language <span class="string">`gorm:&quot;many2many:user_languages;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当使用 GORM 的 <code>AutoMigrate</code> 为 <code>User</code> 创建表时，GORM 会自动创建连接表</p>
<h2 id="反向引用"><a href="#反向引用" class="headerlink" title="反向引用"></a>反向引用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User 拥有并属于多种 language，`user_languages` 是连接表</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []*Language <span class="string">`gorm:&quot;many2many:user_languages;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">  Users []*User <span class="string">`gorm:&quot;many2many:user_languages;&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写外键-3"><a href="#重写外键-3" class="headerlink" title="重写外键"></a>重写外键</h2><p>对于 <code>many2many</code> 关系，连接表会同时拥有两个模型的外键，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []Language <span class="string">`gorm:&quot;many2many:user_languages;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接表：user_languages</span></span><br><span class="line"><span class="comment">//   foreign key: user_id, reference: users.id</span></span><br><span class="line"><span class="comment">//   foreign key: language_id, reference: languages.id</span></span><br></pre></td></tr></table></figure>

<p>若要重写它们，可以使用标签<br><code>foreignKey</code>、<code>references</code>、<code>joinforeignKey</code>、<code>joinReferences</code>。当然，您不需要使用全部的标签，你可以仅使用其中的一个重写部分的外键、引用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    Profiles []Profile <span class="string">`gorm:&quot;many2many:user_profiles;foreignKey:Refer;joinForeignKey:UserReferID;References:UserRefer;joinReferences:ProfileRefer&quot;`</span></span><br><span class="line">    Refer    <span class="type">uint</span>      <span class="string">`gorm:&quot;index:,unique&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Profile <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    Name      <span class="type">string</span></span><br><span class="line">    UserRefer <span class="type">uint</span> <span class="string">`gorm:&quot;index:,unique&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 会创建连接表：user_profiles</span></span><br><span class="line"><span class="comment">//   foreign key: user_refer_id, reference: users.refer</span></span><br><span class="line"><span class="comment">//   foreign key: profile_refer, reference: profiles.user_refer</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：</strong><br>某些数据库只允许在唯一索引字段上创建外键，如果您在迁移时会创建外键，则需要指定<br><code>unique index</code> 标签。</p>
</blockquote>
<h2 id="自引用-Many2Many"><a href="#自引用-Many2Many" class="headerlink" title="自引用 Many2Many"></a>自引用 Many2Many</h2><p>自引用 many2many 关系</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">    Friends []*User <span class="string">`gorm:&quot;many2many:user_friends&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 会创建连接表：user_friends</span></span><br><span class="line"><span class="comment">//   foreign key: user_id, reference: users.id</span></span><br><span class="line"><span class="comment">//   foreign key: friend_id, reference: users.id</span></span><br></pre></td></tr></table></figure>

<h2 id="预加载-3"><a href="#预加载-3" class="headerlink" title="预加载"></a>预加载</h2><p>GORM 可以通过 <code>Preload</code> 预加载 has many 关联的记录，查看 预加载 获取详情</p>
<h2 id="Many2Many-的-CURD"><a href="#Many2Many-的-CURD" class="headerlink" title="Many2Many 的 CURD"></a>Many2Many 的 CURD</h2><p>查看 关联模式 获取 many2many 相关的用法</p>
<h2 id="自定义连接表"><a href="#自定义连接表" class="headerlink" title="自定义连接表"></a>自定义连接表</h2><p><code>连接表</code> 可以是一个全功能的模型，支持<br><code>Soft Delete</code>、<code>钩子</code>、更多的字段，就跟其它模型一样。您可以通过<br><code>SetupJoinTable</code> 指定它，例如：</p>
<blockquote>
<p><strong>注意：</strong> 自定义连接表要求外键是复合主键或复合唯一索引</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID        <span class="type">int</span></span><br><span class="line">  Name      <span class="type">string</span></span><br><span class="line">  Addresses []Address <span class="string">`gorm:&quot;many2many:person_addresses;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Address <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID   <span class="type">uint</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PersonAddress <span class="keyword">struct</span> &#123;</span><br><span class="line">  PersonID  <span class="type">int</span> <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">  AddressID <span class="type">int</span> <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">  CreatedAt time.Time</span><br><span class="line">  DeletedAt gorm.DeletedAt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(PersonAddress)</span></span> BeforeCreate(db *gorm.DB) <span class="type">error</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改 Person 的 Addresses 字段的连接表为 PersonAddress</span></span><br><span class="line"><span class="comment">// PersonAddress 必须定义好所需的外键，否则会报错</span></span><br><span class="line">err := db.SetupJoinTable(&amp;Person&#123;&#125;, <span class="string">&quot;Addresses&quot;</span>, &amp;PersonAddress&#123;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="外键约束-3"><a href="#外键约束-3" class="headerlink" title="外键约束"></a>外键约束</h2><p>你可以通过为标签 <code>constraint</code> 配置 <code>OnUpdate</code>、<code>OnDelete</code><br>实现外键约束，在使用 GORM 进行迁移时它会被创建，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">  gorm.Model</span><br><span class="line">  Languages []Language <span class="string">`gorm:&quot;many2many:user_speaks;&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Language <span class="keyword">struct</span> &#123;</span><br><span class="line">  Code <span class="type">string</span> <span class="string">`gorm:&quot;primarykey&quot;`</span></span><br><span class="line">  Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CREATE TABLE `user_speaks` (`user_id` integer,`language_code` text,PRIMARY KEY (`user_id`,`language_code`),CONSTRAINT `fk_user_speaks_user` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE SET NULL ON UPDATE CASCADE,CONSTRAINT `fk_user_speaks_language` FOREIGN KEY (`language_code`) REFERENCES `languages`(`code`) ON DELETE SET NULL ON UPDATE CASCADE);</span></span><br></pre></td></tr></table></figure>

<p>你也可以在删除记录时通过 <code>Select</code> 来删除 many2many 关系的记录，查看<br>Delete with Select 获取详情</p>
<h2 id="复合外键"><a href="#复合外键" class="headerlink" title="复合外键"></a>复合外键</h2><p>如果您的模型使用了 复合主键，GORM 会默认启用复合外键。</p>
<p>您也可以覆盖默认的外键、指定多个外键，只需用逗号分隔那些键名，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Tag <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID     <span class="type">uint</span>   <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">  Locale <span class="type">string</span> <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">  Value  <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Blog <span class="keyword">struct</span> &#123;</span><br><span class="line">  ID         <span class="type">uint</span>   <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">  Locale     <span class="type">string</span> <span class="string">`gorm:&quot;primaryKey&quot;`</span></span><br><span class="line">  Subject    <span class="type">string</span></span><br><span class="line">  Body       <span class="type">string</span></span><br><span class="line">  Tags       []Tag <span class="string">`gorm:&quot;many2many:blog_tags;&quot;`</span></span><br><span class="line">  LocaleTags []Tag <span class="string">`gorm:&quot;many2many:locale_blog_tags;ForeignKey:id,locale;References:id&quot;`</span></span><br><span class="line">  SharedTags []Tag <span class="string">`gorm:&quot;many2many:shared_blog_tags;ForeignKey:id;References:id&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接表：blog_tags</span></span><br><span class="line"><span class="comment">//   foreign key: blog_id, reference: blogs.id</span></span><br><span class="line"><span class="comment">//   foreign key: blog_locale, reference: blogs.locale</span></span><br><span class="line"><span class="comment">//   foreign key: tag_id, reference: tags.id</span></span><br><span class="line"><span class="comment">//   foreign key: tag_locale, reference: tags.locale</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接表：locale_blog_tags</span></span><br><span class="line"><span class="comment">//   foreign key: blog_id, reference: blogs.id</span></span><br><span class="line"><span class="comment">//   foreign key: blog_locale, reference: blogs.locale</span></span><br><span class="line"><span class="comment">//   foreign key: tag_id, reference: tags.id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接表：shared_blog_tags</span></span><br><span class="line"><span class="comment">//   foreign key: blog_id, reference: blogs.id</span></span><br><span class="line"><span class="comment">//   foreign key: tag_id, reference: tags.id</span></span><br></pre></td></tr></table></figure>

<h1 id="gorm-实体关联"><a href="#gorm-实体关联" class="headerlink" title="gorm 实体关联"></a>gorm 实体关联</h1><h2 id="自动创建、更新"><a href="#自动创建、更新" class="headerlink" title="自动创建、更新"></a>自动创建、更新</h2><p>在创建、更新记录时，GORM 会通过 Upsert 自动保存关联及其引用记录。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;</span><br><span class="line">  Name:            <span class="string">&quot;jinzhu&quot;</span>,</span><br><span class="line">  BillingAddress:  Address&#123;Address1: <span class="string">&quot;Billing Address - Address 1&quot;</span>&#125;,</span><br><span class="line">  ShippingAddress: Address&#123;Address1: <span class="string">&quot;Shipping Address - Address 1&quot;</span>&#125;,</span><br><span class="line">  Emails:          []Email&#123;</span><br><span class="line">    &#123;Email: <span class="string">&quot;jinzhu@example.com&quot;</span>&#125;,</span><br><span class="line">    &#123;Email: <span class="string">&quot;jinzhu-2@example.com&quot;</span>&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  Languages:       []Language&#123;</span><br><span class="line">    &#123;Name: <span class="string">&quot;ZH&quot;</span>&#125;,</span><br><span class="line">    &#123;Name: <span class="string">&quot;EN&quot;</span>&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Create(&amp;user)</span><br><span class="line"><span class="comment">// BEGIN TRANSACTION;</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY DO NOTHING;</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY DO NOTHING;</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;languages&quot; (&quot;name&quot;) VALUES (&#x27;ZH&#x27;), (&#x27;EN&#x27;) ON DUPLICATE KEY DO NOTHING;</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;user_languages&quot; (&quot;user_id&quot;,&quot;language_id&quot;) VALUES (111, 1), (111, 2) ON DUPLICATE KEY DO NOTHING;</span></span><br><span class="line"><span class="comment">// COMMIT;</span></span><br><span class="line"></span><br><span class="line">db.Save(&amp;user)</span><br></pre></td></tr></table></figure>

<p>如果您想要更新关联的数据，您应该使用 <code>FullSaveAssociations</code> 模式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.Session(&amp;gorm.Session&#123;FullSaveAssociations: <span class="literal">true</span>&#125;).Updates(&amp;user)</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY SET address1=VALUES(address1);</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY SET email=VALUES(email);</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h2 id="跳过自动创建、更新"><a href="#跳过自动创建、更新" class="headerlink" title="跳过自动创建、更新"></a>跳过自动创建、更新</h2><p>若要在创建、更新时跳过自动保存，您可以使用 <code>Select</code> 或 <code>Omit</code>，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;</span><br><span class="line">  Name:            <span class="string">&quot;jinzhu&quot;</span>,</span><br><span class="line">  BillingAddress:  Address&#123;Address1: <span class="string">&quot;Billing Address - Address 1&quot;</span>&#125;,</span><br><span class="line">  ShippingAddress: Address&#123;Address1: <span class="string">&quot;Shipping Address - Address 1&quot;</span>&#125;,</span><br><span class="line">  Emails:          []Email&#123;</span><br><span class="line">    &#123;Email: <span class="string">&quot;jinzhu@example.com&quot;</span>&#125;,</span><br><span class="line">    &#123;Email: <span class="string">&quot;jinzhu-2@example.com&quot;</span>&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  Languages:       []Language&#123;</span><br><span class="line">    &#123;Name: <span class="string">&quot;ZH&quot;</span>&#125;,</span><br><span class="line">    &#123;Name: <span class="string">&quot;EN&quot;</span>&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Select(<span class="string">&quot;Name&quot;</span>).Create(&amp;user)</span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; (name) VALUES (&quot;jinzhu&quot;, 1, 2);</span></span><br><span class="line"></span><br><span class="line">db.Omit(<span class="string">&quot;BillingAddress&quot;</span>).Create(&amp;user)</span><br><span class="line"><span class="comment">// Skip create BillingAddress when creating a user</span></span><br><span class="line"></span><br><span class="line">db.Omit(clause.Associations).Create(&amp;user)</span><br><span class="line"><span class="comment">// Skip all associations when creating a user</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>NOTE:</strong> 对于 many2many 关联，GORM 在创建连接表引用之前，会先 upsert<br>关联。如果你想跳过关联的 upsert，你可以这样做：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Omit(<span class="string">&quot;Languages.*&quot;</span>).Create(&amp;user)</span><br></pre></td></tr></table></figure>

<p>下面的代码将跳过创建关联及其引用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Omit(<span class="string">&quot;Languages&quot;</span>).Create(&amp;user)</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="Select-x2F-Omit-关联字段"><a href="#Select-x2F-Omit-关联字段" class="headerlink" title="Select&#x2F;Omit 关联字段"></a>Select&#x2F;Omit 关联字段</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">user := User&#123;</span><br><span class="line">  Name:            <span class="string">&quot;jinzhu&quot;</span>,</span><br><span class="line">  BillingAddress:  Address&#123;Address1: <span class="string">&quot;Billing Address - Address 1&quot;</span>, Address2: <span class="string">&quot;addr2&quot;</span>&#125;,</span><br><span class="line">  ShippingAddress: Address&#123;Address1: <span class="string">&quot;Shipping Address - Address 1&quot;</span>, Address2: <span class="string">&quot;addr2&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 user 及其 BillingAddress、ShippingAddress</span></span><br><span class="line"><span class="comment">// 在创建 BillingAddress 时，仅使用其 address1、address2 字段，忽略其它字段</span></span><br><span class="line">db.Select(<span class="string">&quot;BillingAddress.Address1&quot;</span>, <span class="string">&quot;BillingAddress.Address2&quot;</span>).Create(&amp;user)</span><br><span class="line"></span><br><span class="line">db.Omit(<span class="string">&quot;BillingAddress.Address2&quot;</span>, <span class="string">&quot;BillingAddress.CreatedAt&quot;</span>).Create(&amp;user)</span><br></pre></td></tr></table></figure>

<h2 id="关联模式"><a href="#关联模式" class="headerlink" title="关联模式"></a>关联模式</h2><p>关联模式包含一些在处理关系时有用的方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开始关联模式</span></span><br><span class="line"><span class="keyword">var</span> user User</span><br><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>)</span><br><span class="line"><span class="comment">// `user` 是源模型，它的主键不能为空</span></span><br><span class="line"><span class="comment">// 关系的字段名是 `Languages`</span></span><br><span class="line"><span class="comment">// 如果匹配了上面两个要求，会开始关联模式，否则会返回错误</span></span><br><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Error</span><br></pre></td></tr></table></figure>

<h3 id="查找关联"><a href="#查找关联" class="headerlink" title="查找关联"></a>查找关联</h3><p>查找所有匹配的关联记录</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Find(&amp;languages)</span><br></pre></td></tr></table></figure>

<p>查找带条件的关联</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">codes := []<span class="type">string</span>&#123;<span class="string">&quot;zh-CN&quot;</span>, <span class="string">&quot;en-US&quot;</span>, <span class="string">&quot;ja-JP&quot;</span>&#125;</span><br><span class="line">db.Model(&amp;user).Where(<span class="string">&quot;code IN ?&quot;</span>, codes).Association(<span class="string">&quot;Languages&quot;</span>).Find(&amp;languages)</span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Where(<span class="string">&quot;code IN ?&quot;</span>, codes).Order(<span class="string">&quot;code desc&quot;</span>).Association(<span class="string">&quot;Languages&quot;</span>).Find(&amp;languages)</span><br></pre></td></tr></table></figure>

<h3 id="添加关联"><a href="#添加关联" class="headerlink" title="添加关联"></a>添加关联</h3><p>为 <code>many to many</code>、<code>has many</code> 添加新的关联；为 <code>has one</code>, <code>belongs to</code><br>替换当前的关联</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Append([]Language&#123;languageZH, languageEN&#125;)</span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Append(&amp;Language&#123;Name: <span class="string">&quot;DE&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;CreditCard&quot;</span>).Append(&amp;CreditCard&#123;Number: <span class="string">&quot;411111111111&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="替换关联"><a href="#替换关联" class="headerlink" title="替换关联"></a>替换关联</h3><p>用一个新的关联替换当前的关联</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Replace([]Language&#123;languageZH, languageEN&#125;)</span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Replace(Language&#123;Name: <span class="string">&quot;DE&quot;</span>&#125;, languageEN)</span><br></pre></td></tr></table></figure>

<h3 id="删除关联"><a href="#删除关联" class="headerlink" title="删除关联"></a>删除关联</h3><p>如果存在，则删除源模型与参数之间的关系，只会删除引用，不会从数据库中删除这些对象。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Delete([]Language&#123;languageZH, languageEN&#125;)</span><br><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Delete(languageZH, languageEN)</span><br></pre></td></tr></table></figure>

<h3 id="清空关联"><a href="#清空关联" class="headerlink" title="清空关联"></a>清空关联</h3><p>删除源模型与关联之间的所有引用，但不会删除这些关联</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Clear()</span><br></pre></td></tr></table></figure>

<h3 id="关联计数"><a href="#关联计数" class="headerlink" title="关联计数"></a>关联计数</h3><p>返回当前关联的计数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Model(&amp;user).Association(<span class="string">&quot;Languages&quot;</span>).Count()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 条件计数</span></span><br><span class="line">codes := []<span class="type">string</span>&#123;<span class="string">&quot;zh-CN&quot;</span>, <span class="string">&quot;en-US&quot;</span>, <span class="string">&quot;ja-JP&quot;</span>&#125;</span><br><span class="line">db.Model(&amp;user).Where(<span class="string">&quot;code IN ?&quot;</span>, codes).Association(<span class="string">&quot;Languages&quot;</span>).Count()</span><br></pre></td></tr></table></figure>

<h3 id="批量处理数据"><a href="#批量处理数据" class="headerlink" title="批量处理数据"></a>批量处理数据</h3><p>关联模式也支持批量处理，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询所有用户的所有角色</span></span><br><span class="line">db.Model(&amp;users).Association(<span class="string">&quot;Role&quot;</span>).Find(&amp;roles)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从所有 team 中删除 user A</span></span><br><span class="line">db.Model(&amp;users).Association(<span class="string">&quot;Team&quot;</span>).Delete(&amp;userA)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取去重的用户所属 team 数量</span></span><br><span class="line">db.Model(&amp;users).Association(<span class="string">&quot;Team&quot;</span>).Count()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于批量数据的 `Append`、`Replace`，参数的长度必须与数据的长度相同，否则会返回 error</span></span><br><span class="line"><span class="keyword">var</span> users = []User&#123;user1, user2, user3&#125;</span><br><span class="line"><span class="comment">// 例如：现在有三个 user，Append userA 到 user1 的 team，Append userB 到 user2 的 team，Append userA、userB 和 userC 到 user3 的 team</span></span><br><span class="line">db.Model(&amp;users).Association(<span class="string">&quot;Team&quot;</span>).Append(&amp;userA, &amp;userB, &amp;[]User&#123;userA, userB, userC&#125;)</span><br><span class="line"><span class="comment">// 重置 user1 team 为 userA，重置 user2 的 team 为 userB，重置 user3 的 team 为 userA、 userB 和 userC</span></span><br><span class="line">db.Model(&amp;users).Association(<span class="string">&quot;Team&quot;</span>).Replace(&amp;userA, &amp;userB, &amp;[]User&#123;userA, userB, userC&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="带-Select-的删除"><a href="#带-Select-的删除" class="headerlink" title="带 Select 的删除"></a>带 Select 的删除</h2><p>你可以在删除记录时通过 <code>Select</code> 来删除具有 has one、has many、many2many<br>关系的记录，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除 user 时，也删除 user 的 account</span></span><br><span class="line">db.Select(<span class="string">&quot;Account&quot;</span>).Delete(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除 user 时，也删除 user 的 Orders、CreditCards 记录</span></span><br><span class="line">db.Select(<span class="string">&quot;Orders&quot;</span>, <span class="string">&quot;CreditCards&quot;</span>).Delete(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除 user 时，也删除用户所有 has one/many、many2many 记录</span></span><br><span class="line">db.Select(clause.Associations).Delete(&amp;user)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除 users 时，也删除每一个 user 的 account</span></span><br><span class="line">db.Select(<span class="string">&quot;Account&quot;</span>).Delete(&amp;users)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：</strong> 只有当记录的主键不为空时，关联才会被删除，GORM<br>会使用这些主键作为条件来删除关联记录</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DOESN&#x27;T WORK</span></span><br><span class="line">db.Select(<span class="string">&quot;Account&quot;</span>).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Delete(&amp;User&#123;&#125;)</span><br><span class="line"><span class="comment">// 会删除所有 name=`jinzhu` 的 user，但这些 user 的 account 不会被删除</span></span><br><span class="line"></span><br><span class="line">db.Select(<span class="string">&quot;Account&quot;</span>).Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Delete(&amp;User&#123;ID: <span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">// 会删除 name = `jinzhu` 且 id = `1` 的 user，并且 user `1` 的 account 也会被删除</span></span><br><span class="line"></span><br><span class="line">db.Select(<span class="string">&quot;Account&quot;</span>).Delete(&amp;User&#123;ID: <span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">// 会删除 id = `1` 的 user，并且 user `1` 的 account 也会被删除</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="关联标签-1"><a href="#关联标签-1" class="headerlink" title="关联标签"></a>关联标签</h2><table>
<thead>
<tr>
<th align="left">标签</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">foreignKey</td>
<td align="left">指定当前模型的列作为连接表的外键</td>
</tr>
<tr>
<td align="left">references</td>
<td align="left">指定引用表的列名，其将被映射为连接表外键</td>
</tr>
<tr>
<td align="left">polymorphic</td>
<td align="left">指定多态类型，比如模型名</td>
</tr>
<tr>
<td align="left">polymorphicValue</td>
<td align="left">指定多态值、默认表名</td>
</tr>
<tr>
<td align="left">many2many</td>
<td align="left">指定连接表表名</td>
</tr>
<tr>
<td align="left">joinForeignKey</td>
<td align="left">指定连接表的外键列名，其将被映射到当前表</td>
</tr>
<tr>
<td align="left">joinReferences</td>
<td align="left">指定连接表的外键列名，其将被映射到引用表</td>
</tr>
<tr>
<td align="left">constraint</td>
<td align="left">关系约束，例如：<code>OnUpdate</code>、<code>OnDelete</code></td>
</tr>
</tbody></table>
<h1 id="gorm-会话"><a href="#gorm-会话" class="headerlink" title="gorm 会话"></a>gorm 会话</h1><p>GORM 提供了 <code>Session</code> 方法，这是一个<br><code>New Session Method</code>，它允许创建带配置的新建会话模式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Session 配置</span></span><br><span class="line"><span class="keyword">type</span> Session <span class="keyword">struct</span> &#123;</span><br><span class="line">  DryRun                 <span class="type">bool</span></span><br><span class="line">  PrepareStmt            <span class="type">bool</span></span><br><span class="line">  NewDB                  <span class="type">bool</span></span><br><span class="line">  SkipHooks              <span class="type">bool</span></span><br><span class="line">  SkipDefaultTransaction <span class="type">bool</span></span><br><span class="line">  AllowGlobalUpdate      <span class="type">bool</span></span><br><span class="line">  FullSaveAssociations   <span class="type">bool</span></span><br><span class="line">  Context                context.Context</span><br><span class="line">  Logger                 logger.Interface</span><br><span class="line">  NowFunc                <span class="function"><span class="keyword">func</span><span class="params">()</span></span> time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DryRun"><a href="#DryRun" class="headerlink" title="DryRun"></a>DryRun</h2><p>生成 <code>SQL</code> 但不执行。 它可以用于准备或测试生成的 SQL，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新建会话模式</span></span><br><span class="line">stmt := db.Session(&amp;Session&#123;DryRun: <span class="literal">true</span>&#125;).First(&amp;user, <span class="number">1</span>).Statement</span><br><span class="line">stmt.SQL.String() <span class="comment">//=&gt; SELECT * FROM `users` WHERE `id` = $1 ORDER BY `id`</span></span><br><span class="line">stmt.Vars         <span class="comment">//=&gt; []interface&#123;&#125;&#123;1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局 DryRun 模式</span></span><br><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">&quot;gorm.db&quot;</span>), &amp;gorm.Config&#123;DryRun: <span class="literal">true</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不同的数据库生成不同的 SQL</span></span><br><span class="line">stmt := db.Find(&amp;user, <span class="number">1</span>).Statement</span><br><span class="line">stmt.SQL.String() <span class="comment">//=&gt; SELECT * FROM `users` WHERE `id` = $1 // PostgreSQL</span></span><br><span class="line">stmt.SQL.String() <span class="comment">//=&gt; SELECT * FROM `users` WHERE `id` = ?  // MySQL</span></span><br><span class="line">stmt.Vars         <span class="comment">//=&gt; []interface&#123;&#125;&#123;1&#125;</span></span><br></pre></td></tr></table></figure>

<p>你可以使用下面的代码生成最终的 SQL：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意：SQL 并不总是能安全地执行，GORM 仅将其用于日志，它可能导致会 SQL 注入</span></span><br><span class="line">db.Dialector.Explain(stmt.SQL.String(), stmt.Vars...)</span><br><span class="line"><span class="comment">// SELECT * FROM `users` WHERE `id` = 1</span></span><br></pre></td></tr></table></figure>

<h2 id="预编译"><a href="#预编译" class="headerlink" title="预编译"></a>预编译</h2><p><code>PreparedStmt</code> 在执行任何 SQL 时都会创建一个 prepared statement<br>并将其缓存，以提高后续的效率，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局模式，所有 DB 操作都会创建并缓存预编译语句</span></span><br><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">&quot;gorm.db&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line">  PrepareStmt: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 会话模式</span></span><br><span class="line">tx := db.Session(&amp;Session&#123;PrepareStmt: <span class="literal">true</span>&#125;)</span><br><span class="line">tx.First(&amp;user, <span class="number">1</span>)</span><br><span class="line">tx.Find(&amp;users)</span><br><span class="line">tx.Model(&amp;user).Update(<span class="string">&quot;Age&quot;</span>, <span class="number">18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// returns prepared statements manager</span></span><br><span class="line">stmtManger, ok := tx.ConnPool.(*PreparedStmtDB)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭 *当前会话* 的预编译模式</span></span><br><span class="line">stmtManger.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 *当前会话* 预编译 SQL</span></span><br><span class="line">stmtManger.PreparedSQL <span class="comment">// =&gt; []string&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为当前数据库连接池的（所有会话）开启预编译模式</span></span><br><span class="line">stmtManger.Stmts <span class="comment">// map[string]*sql.Stmt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sql, stmt := <span class="keyword">range</span> stmtManger.Stmts &#123;</span><br><span class="line">  sql  <span class="comment">// 预编译 SQL</span></span><br><span class="line">  stmt <span class="comment">// 预编译模式</span></span><br><span class="line">  stmt.Close() <span class="comment">// 关闭预编译模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NewDB"><a href="#NewDB" class="headerlink" title="NewDB"></a>NewDB</h2><p>通过 <code>NewDB</code> 选项创建一个不带之前条件的新 DB，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tx := db.Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Session(&amp;gorm.Session&#123;NewDB: <span class="literal">true</span>&#125;)</span><br><span class="line"></span><br><span class="line">tx.First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users ORDER BY id LIMIT 1</span></span><br><span class="line"></span><br><span class="line">tx.First(&amp;user, <span class="string">&quot;id = ?&quot;</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE id = 10 ORDER BY id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不带 `NewDB` 选项</span></span><br><span class="line">tx2 := db.Where(<span class="string">&quot;name = ?&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>).Session(&amp;gorm.Session&#123;&#125;)</span><br><span class="line">tx2.First(&amp;user)</span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE name = &quot;jinzhu&quot; ORDER BY id</span></span><br></pre></td></tr></table></figure>

<h2 id="跳过钩子"><a href="#跳过钩子" class="headerlink" title="跳过钩子"></a>跳过钩子</h2><p>如果您想跳过 <code>钩子</code> 方法，您可以使用 <code>SkipHooks</code> 会话模式，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Create(&amp;user)</span><br><span class="line"></span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Create(&amp;users)</span><br><span class="line"></span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).CreateInBatches(users, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Find(&amp;user)</span><br><span class="line"></span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Delete(&amp;user)</span><br><span class="line"></span><br><span class="line">DB.Session(&amp;gorm.Session&#123;SkipHooks: <span class="literal">true</span>&#125;).Model(User&#123;&#125;).Where(<span class="string">&quot;age &gt; ?&quot;</span>, <span class="number">18</span>).Updates(&amp;user)</span><br></pre></td></tr></table></figure>

<h2 id="禁用嵌套事务"><a href="#禁用嵌套事务" class="headerlink" title="禁用嵌套事务"></a>禁用嵌套事务</h2><p>在一个 DB 事务中使用 <code>Transaction</code> 方法，GORM 会使用<br><code>SavePoint(savedPointName)</code>，<code>RollbackTo(savedPointName)</code><br>为你提供嵌套事务支持。 你可以通过 <code>DisableNestedTransaction</code><br>选项关闭它，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.Session(&amp;gorm.Session&#123;</span><br><span class="line">  DisableNestedTransaction: <span class="literal">true</span>,</span><br><span class="line">&#125;).CreateInBatches(&amp;users, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h2 id="AllowGlobalUpdate"><a href="#AllowGlobalUpdate" class="headerlink" title="AllowGlobalUpdate"></a>AllowGlobalUpdate</h2><p>GORM 默认不允许进行全局 update&#x2F;delete，该操作会返回<br><code>ErrMissingWhereClause</code> 错误。 您可以通过将一个选项设置为 true<br>来启用它，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.Session(&amp;gorm.Session&#123;</span><br><span class="line">  AllowGlobalUpdate: <span class="literal">true</span>,</span><br><span class="line">&#125;).Model(&amp;User&#123;&#125;).Update(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;jinzhu&quot;</span>)</span><br><span class="line"><span class="comment">// UPDATE users SET `name` = &quot;jinzhu&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="FullSaveAssociations"><a href="#FullSaveAssociations" class="headerlink" title="FullSaveAssociations"></a>FullSaveAssociations</h2><p>在创建、更新记录时，GORM 会通过 Upsert 自动保存关联及其引用记录。<br>如果您想要更新关联的数据，您应该使用 <code>FullSaveAssociations</code> 模式，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.Session(&amp;gorm.Session&#123;FullSaveAssociations: <span class="literal">true</span>&#125;).Updates(&amp;user)</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;addresses&quot; (address1) VALUES (&quot;Billing Address - Address 1&quot;), (&quot;Shipping Address - Address 1&quot;) ON DUPLICATE KEY SET address1=VALUES(address1);</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;users&quot; (name,billing_address_id,shipping_address_id) VALUES (&quot;jinzhu&quot;, 1, 2);</span></span><br><span class="line"><span class="comment">// INSERT INTO &quot;emails&quot; (user_id,email) VALUES (111, &quot;jinzhu@example.com&quot;), (111, &quot;jinzhu-2@example.com&quot;) ON DUPLICATE KEY SET email=VALUES(email);</span></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>通过 <code>Context</code> 选项，您可以传入 <code>Context</code> 来追踪 SQL 操作，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">timeoutCtx, _ := context.WithTimeout(context.Background(), time.Second)</span><br><span class="line">tx := db.Session(&amp;Session&#123;Context: timeoutCtx&#125;)</span><br><span class="line"></span><br><span class="line">tx.First(&amp;user) <span class="comment">// 带 timeoutCtx 的查询</span></span><br><span class="line">tx.Model(&amp;user).Update(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;admin&quot;</span>) <span class="comment">// 带 timeoutCtx 的更新</span></span><br></pre></td></tr></table></figure>

<p>GORM 也提供了快捷调用方法 <code>WithContext</code>，其实现如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> WithContext(ctx context.Context) *DB &#123;</span><br><span class="line">  <span class="keyword">return</span> db.Session(&amp;Session&#123;Context: ctx&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Logger"><a href="#Logger" class="headerlink" title="Logger"></a>Logger</h2><p>Gorm 允许使用 <code>Logger</code> 选项自定义内建 Logger，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">newLogger := logger.New(log.New(os.Stdout, <span class="string">&quot;\r\n&quot;</span>, log.LstdFlags),</span><br><span class="line">              logger.Config&#123;</span><br><span class="line">                SlowThreshold: time.Second,</span><br><span class="line">                LogLevel:      logger.Silent,</span><br><span class="line">                Colorful:      <span class="literal">false</span>,</span><br><span class="line">              &#125;)</span><br><span class="line">db.Session(&amp;Session&#123;Logger: newLogger&#125;)</span><br><span class="line"></span><br><span class="line">db.Session(&amp;Session&#123;Logger: logger.Default.LogMode(logger.Silent)&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="NowFunc"><a href="#NowFunc" class="headerlink" title="NowFunc"></a>NowFunc</h2><p><code>NowFunc</code> 允许改变 GORM 获取当前时间的实现，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.Session(&amp;Session&#123;</span><br><span class="line">  NowFunc: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> time.Time &#123;</span><br><span class="line">    <span class="keyword">return</span> time.Now().Local()</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><p><code>Debug</code> 只是将会话的 <code>Logger</code> 修改为调试模式的快捷方法，其实现如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span></span> Debug() (tx *DB) &#123;</span><br><span class="line">  <span class="keyword">return</span> db.Session(&amp;Session&#123;</span><br><span class="line">    Logger:         db.Logger.LogMode(logger.Info),</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="QueryFields"><a href="#QueryFields" class="headerlink" title="QueryFields"></a>QueryFields</h2><p>Select by fields</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.Session(&amp;gorm.Session&#123;QueryFields: <span class="literal">true</span>&#125;).Find(&amp;user)</span><br><span class="line"><span class="comment">// SELECT `users`.`name`, `users`.`age`, ... FROM `users` // 带该选项</span></span><br><span class="line"><span class="comment">// SELECT * FROM `users` // 不带该选项</span></span><br></pre></td></tr></table></figure>

<h2 id="CreateBatchSize"><a href="#CreateBatchSize" class="headerlink" title="CreateBatchSize"></a>CreateBatchSize</h2><p>Default batch size</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">users = [<span class="number">5000</span>]User&#123;&#123;Name: <span class="string">&quot;jinzhu&quot;</span>, Pets: []Pet&#123;pet1, pet2, pet3&#125;&#125;...&#125;</span><br><span class="line"></span><br><span class="line">db.Session(&amp;gorm.Session&#123;CreateBatchSize: <span class="number">1000</span>&#125;).Create(&amp;users)</span><br><span class="line"><span class="comment">// INSERT INTO users xxx (需 5 次)</span></span><br><span class="line"><span class="comment">// INSERT INTO pets xxx (需 15 次)</span></span><br></pre></td></tr></table></figure>

<h1 id="gorm事务"><a href="#gorm事务" class="headerlink" title="gorm事务"></a>gorm事务</h1><h2 id="禁用默认事务"><a href="#禁用默认事务" class="headerlink" title="禁用默认事务"></a>禁用默认事务</h2><p>为了确保数据一致性，GORM<br>会在事务里执行写入操作（创建、更新、删除）。如果没有这方面的要求，您可以在初始化时禁用它，这将获得大约<br>30%+ 性能提升。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局禁用</span></span><br><span class="line">db, err := gorm.Open(sqlite.Open(<span class="string">&quot;gorm.db&quot;</span>), &amp;gorm.Config&#123;</span><br><span class="line">  SkipDefaultTransaction: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 持续会话模式</span></span><br><span class="line">tx := db.Session(&amp;Session&#123;SkipDefaultTransaction: <span class="literal">true</span>&#125;)</span><br><span class="line">tx.First(&amp;user, <span class="number">1</span>)</span><br><span class="line">tx.Find(&amp;users)</span><br><span class="line">tx.Model(&amp;user).Update(<span class="string">&quot;Age&quot;</span>, <span class="number">18</span>)</span><br></pre></td></tr></table></figure>

<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p>要在事务中执行一系列操作，一般流程如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  <span class="comment">// 在事务中执行一些 db 操作（从这里开始，您应该使用 &#x27;tx&#x27; 而不是 &#x27;db&#x27;）</span></span><br><span class="line">  <span class="keyword">if</span> err := tx.Create(&amp;Animal&#123;Name: <span class="string">&quot;Giraffe&quot;</span>&#125;).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// 返回任何错误都会回滚事务</span></span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := tx.Create(&amp;Animal&#123;Name: <span class="string">&quot;Lion&quot;</span>&#125;).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 nil 提交事务</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="嵌套事务"><a href="#嵌套事务" class="headerlink" title="嵌套事务"></a>嵌套事务</h3><p>GORM 支持嵌套事务，您可以回滚较大事务内执行的一部分操作，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">db.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  tx.Create(&amp;user1)</span><br><span class="line"></span><br><span class="line">  tx.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    tx2.Create(&amp;user2)</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;rollback user2&quot;</span>) <span class="comment">// Rollback user2</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  tx.Transaction(<span class="function"><span class="keyword">func</span><span class="params">(tx2 *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    tx2.Create(&amp;user3)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Commit user1, user3</span></span><br></pre></td></tr></table></figure>

<h2 id="手动事务"><a href="#手动事务" class="headerlink" title="手动事务"></a>手动事务</h2><p>Gorm 支持直接调用事务控制方法（commit、rollback），例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开始事务</span></span><br><span class="line">tx := db.Begin()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在事务中执行一些 db 操作（从这里开始，您应该使用 &#x27;tx&#x27; 而不是 &#x27;db&#x27;）</span></span><br><span class="line">tx.Create(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遇到错误时回滚事务</span></span><br><span class="line">tx.Rollback()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 否则，提交事务</span></span><br><span class="line">tx.Commit()</span><br></pre></td></tr></table></figure>

<h3 id="一个特殊的示例"><a href="#一个特殊的示例" class="headerlink" title="一个特殊的示例"></a>一个特殊的示例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateAnimals</span><span class="params">(db *gorm.DB)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">  <span class="comment">// 再唠叨一下，事务一旦开始，你就应该使用 tx 处理数据</span></span><br><span class="line">  tx := db.Begin()</span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</span><br><span class="line">      tx.Rollback()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := tx.Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := tx.Create(&amp;Animal&#123;Name: <span class="string">&quot;Giraffe&quot;</span>&#125;).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">     tx.Rollback()</span><br><span class="line">     <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> err := tx.Create(&amp;Animal&#123;Name: <span class="string">&quot;Lion&quot;</span>&#125;).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">     tx.Rollback()</span><br><span class="line">     <span class="keyword">return</span> err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tx.Commit().Error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SavePoint、RollbackTo"><a href="#SavePoint、RollbackTo" class="headerlink" title="SavePoint、RollbackTo"></a>SavePoint、RollbackTo</h2><p>GORM 提供了 <code>SavePoint</code>、<code>Rollbackto</code><br>方法，来提供保存点以及回滚至保存点功能，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tx := db.Begin()</span><br><span class="line">tx.Create(&amp;user1)</span><br><span class="line"></span><br><span class="line">tx.SavePoint(<span class="string">&quot;sp1&quot;</span>)</span><br><span class="line">tx.Create(&amp;user2)</span><br><span class="line">tx.RollbackTo(<span class="string">&quot;sp1&quot;</span>) <span class="comment">// Rollback user2</span></span><br><span class="line"></span><br><span class="line">tx.Commit() <span class="comment">// Commit user1</span></span><br></pre></td></tr></table></figure>

<h1 id="Gorm总结"><a href="#Gorm总结" class="headerlink" title="Gorm总结"></a>Gorm总结</h1><p>本节以客户customer和订单order为模型，并且以dao设计模式来实现他们的curd操作。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p><img src="https://ryanchou612.github.io/storage/thumbnails/_signature/1CDANHL3GGDP8IEIT9542IPUHQ.png" alt="项目结构"></p>
<h2 id="准备数据库和表以及数据"><a href="#准备数据库和表以及数据" class="headerlink" title="准备数据库和表以及数据"></a>准备数据库和表以及数据</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database gorm_demo;</span><br><span class="line"></span><br><span class="line">customers <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `customers` (</span><br><span class="line">  `id` <span class="type">int</span> unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `created_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `updated_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `deleted_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `address` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `email` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_customers_deleted_at` (`deleted_at`)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">orders <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `orders` (</span><br><span class="line">  `id` <span class="type">int</span> unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `created_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `updated_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `deleted_at` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `customer_id` <span class="type">int</span> unsigned <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `product` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `price` <span class="keyword">double</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `idx_orders_deleted_at` (`deleted_at`)</span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> customers (name, address, email)</span><br><span class="line"><span class="keyword">VALUES</span> </span><br><span class="line">  (<span class="string">&#x27;John Doe&#x27;</span>, <span class="string">&#x27;123 Main St&#x27;</span>, <span class="string">&#x27;john.doe@example.com&#x27;</span>),</span><br><span class="line">  (<span class="string">&#x27;Jane Doe&#x27;</span>, <span class="string">&#x27;456 Main St&#x27;</span>, <span class="string">&#x27;jane.doe@example.com&#x27;</span>),</span><br><span class="line">  (<span class="string">&#x27;Jim Smith&#x27;</span>, <span class="string">&#x27;789 Main St&#x27;</span>, <span class="string">&#x27;jim.smith@example.com&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders (customer_id, product, price)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="string">&#x27;iPhone&#x27;</span>, <span class="number">999.99</span>),</span><br><span class="line">  (<span class="number">1</span>, <span class="string">&#x27;Macbook Pro&#x27;</span>, <span class="number">1499.99</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="string">&#x27;iPad&#x27;</span>, <span class="number">499.99</span>),</span><br><span class="line">  (<span class="number">3</span>, <span class="string">&#x27;Apple Watch&#x27;</span>, <span class="number">399.99</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在上面的代码中：</p>
<p>customers表有5个字段：</p>
<pre><code>id：主键，自动递增。
name：客户姓名，类型为字符串，不能为空。
address：客户地址，类型为字符串，不能为空。
email：客户电子邮件，类型为字符串，不能为空，唯一。
created_at：客户创建时间，类型为时间戳，默认值为当前时间。
</code></pre>
<p>orders表有5个字段：</p>
<pre><code>id：主键，自动递增。
customer_id：客户ID，类型为整数，不能为空。
product：产品名称，类型为字符串，不能为空。
price：产品价格，类型为十进制，不能为空。
created_at：订单创建时间，类型为时间戳，默认值为当前
</code></pre>
</blockquote>
<h2 id="创建并初始化项目"><a href="#创建并初始化项目" class="headerlink" title="创建并初始化项目"></a>创建并初始化项目</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> gorm_demo</span><br><span class="line"><span class="built_in">cd</span> gorm_demo</span><br><span class="line">code .</span><br><span class="line">go mod init gorm_demo</span><br></pre></td></tr></table></figure>

<h2 id="创建实体"><a href="#创建实体" class="headerlink" title="创建实体"></a>创建实体</h2><p>创建一个entity文件夹，里面创建order.go和customer.go 文件内容如下：</p>
<p><strong>order.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> entity</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;gorm.io/gorm&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    CustomerID <span class="type">uint</span></span><br><span class="line">    Product    <span class="type">string</span></span><br><span class="line">    Price      <span class="type">float32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>customer.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> entity</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/jinzhu/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Customer model</span></span><br><span class="line"><span class="keyword">type</span> Customer <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    Name    <span class="type">string</span> <span class="string">`gorm:&quot;type:varchar(100);not null&quot;`</span></span><br><span class="line">    Address <span class="type">string</span> <span class="string">`gorm:&quot;type:varchar(100);not null&quot;`</span></span><br><span class="line">    Email   <span class="type">string</span> <span class="string">`gorm:&quot;type:varchar(100);not null&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建连接数据库工具类"><a href="#创建连接数据库工具类" class="headerlink" title="创建连接数据库工具类"></a>创建连接数据库工具类</h2><p>创建一个util文件夹，在该文件夹中创建db_util.go文件内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> util</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/jinzhu/gorm&quot;</span></span><br><span class="line">    _ <span class="string">&quot;github.com/jinzhu/gorm/dialects/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> db *gorm.DB</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">    db, err = gorm.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;root:123456@/gorm_demo?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to connect database&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetDB</span><span class="params">()</span></span> *gorm.DB &#123;</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建dao接口"><a href="#创建dao接口" class="headerlink" title="创建dao接口"></a>创建dao接口</h2><p>创建一个dao文件夹，里面创建order_dao.go、customer_dao.go、order_dao_impl.go、customer_dao_impl.go文件，内容如下：</p>
<p><strong>order_dao.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dao</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;gorm_demo/entity&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/jinzhu/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OrderDAO <span class="keyword">interface</span> &#123;</span><br><span class="line">    FindAllOrders(db *gorm.DB) ([]entity.Order, <span class="type">error</span>)</span><br><span class="line">    FindOrderByID(db *gorm.DB, id <span class="type">int</span>) (entity.Order, <span class="type">error</span>)</span><br><span class="line">    CreateOrder(db *gorm.DB, order entity.Order) <span class="type">error</span></span><br><span class="line">    UpdateOrder(db *gorm.DB, order entity.Order) <span class="type">error</span></span><br><span class="line">    DeleteOrder(db *gorm.DB, order entity.Order) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>customer_dao.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dao</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;gorm_demo/entity&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/jinzhu/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// CustomerDAO interface</span></span><br><span class="line"><span class="keyword">type</span> CustomerDAO <span class="keyword">interface</span> &#123;</span><br><span class="line">    CreateCustomer(db *gorm.DB, customer entity.Customer) (entity.Customer, <span class="type">error</span>)</span><br><span class="line">    GetCustomer(db *gorm.DB, id <span class="type">uint</span>) (entity.Customer, <span class="type">error</span>)</span><br><span class="line">    GetAllCustomers(db *gorm.DB) ([]entity.Customer, <span class="type">error</span>)</span><br><span class="line">    UpdateCustomer(db *gorm.DB, customer entity.Customer) (entity.Customer, <span class="type">error</span>)</span><br><span class="line">    DeleteCustomer(db *gorm.DB, customer entity.Customer) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>order_dao_impl.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dao</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;gorm_demo/entity&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/jinzhu/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OrderDAOImpl <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(odao *OrderDAOImpl)</span></span> FindAllOrders(db *gorm.DB) ([]entity.Order, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> orders []entity.Order</span><br><span class="line">    <span class="keyword">if</span> err := db.Find(&amp;orders).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> orders, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(odao *OrderDAOImpl)</span></span> FindOrderByID(db *gorm.DB, id <span class="type">int</span>) (entity.Order, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> order entity.Order</span><br><span class="line">    <span class="keyword">if</span> err := db.First(&amp;order, id).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> entity.Order&#123;&#125;, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> order, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(odao *OrderDAOImpl)</span></span> CreateOrder(db *gorm.DB, order entity.Order) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := db.Create(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(odao *OrderDAOImpl)</span></span> UpdateOrder(db *gorm.DB, order entity.Order) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := db.Save(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(odao *OrderDAOImpl)</span></span> DeleteOrder(db *gorm.DB, order entity.Order) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := db.Delete(&amp;order).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>customer_dao_impl.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dao</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;gorm_demo/entity&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/jinzhu/gorm&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// CustomerDAOImpl customer data access object implementation</span></span><br><span class="line"><span class="keyword">type</span> CustomerDAOImpl <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateCustomer method to create a new customer</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dao CustomerDAOImpl)</span></span> CreateCustomer(db *gorm.DB, customer entity.Customer) (entity.Customer, <span class="type">error</span>) &#123;</span><br><span class="line">    err := db.Create(&amp;customer).Error</span><br><span class="line">    <span class="keyword">return</span> customer, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetCustomer method to get a customer by ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dao CustomerDAOImpl)</span></span> GetCustomer(db *gorm.DB, id <span class="type">uint</span>) (entity.Customer, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> customer entity.Customer</span><br><span class="line">    err := db.First(&amp;customer, id).Error</span><br><span class="line">    <span class="keyword">return</span> customer, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAllCustomers method to get all customers</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dao CustomerDAOImpl)</span></span> GetAllCustomers(db *gorm.DB) ([]entity.Customer, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> customers []entity.Customer</span><br><span class="line">    err := db.Find(&amp;customers).Error</span><br><span class="line">    <span class="keyword">return</span> customers, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UpdateCustomer method to update a customer</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dao CustomerDAOImpl)</span></span> UpdateCustomer(db *gorm.DB, customer entity.Customer) (entity.Customer, <span class="type">error</span>) &#123;</span><br><span class="line">    err := db.Save(&amp;customer).Error</span><br><span class="line">    <span class="keyword">return</span> customer, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dao *CustomerDAOImpl)</span></span> DeleteCustomer(db *gorm.DB, customer entity.Customer) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := db.Delete(&amp;customer).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm_demo/dao&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm_demo/entity&quot;</span></span><br><span class="line">    <span class="string">&quot;gorm_demo/util&quot;</span></span><br><span class="line"></span><br><span class="line">    _ <span class="string">&quot;github.com/jinzhu/gorm/dialects/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    db := util.GetDB()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> db.Close()</span><br><span class="line"></span><br><span class="line">    db.AutoMigrate(&amp;entity.Customer&#123;&#125;, &amp;entity.Order&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    customerDAO := dao.CustomerDAOImpl&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a new customer</span></span><br><span class="line">    newCustomer := entity.Customer&#123;</span><br><span class="line">        Name:    <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        Address: <span class="string">&quot;123 Main St&quot;</span>,</span><br><span class="line">        Email:   <span class="string">&quot;john.doe@example.com&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    createdCustomer, err := customerDAO.CreateCustomer(db, newCustomer)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Created customer:&quot;</span>, createdCustomer)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get a customer by ID</span></span><br><span class="line">    customer, err := customerDAO.GetCustomer(db, createdCustomer.ID)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Retrieved customer:&quot;</span>, customer)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get all customers</span></span><br><span class="line">    customers, err := customerDAO.GetAllCustomers(db)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Retrieved customers:&quot;</span>, customers)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update a customer</span></span><br><span class="line">    customer.Name = <span class="string">&quot;Jane Doe&quot;</span></span><br><span class="line">    updatedCustomer, err := customerDAO.UpdateCustomer(db, customer)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Updated customer:&quot;</span>, updatedCustomer)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Delete a customer</span></span><br><span class="line">    err = customerDAO.DeleteCustomer(db, customer)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Deleted customer:&quot;</span>, customer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        </article>
        <div class="post-tools" id="post-tools">
            <div class="post-tools-left">
                
                <div class="share-link mobile">
    <div class="share-qrcode">
        <div class="share-button" title="使用手机访问这篇文章">
            <i class="fas fa-qrcode"></i>
        </div>
        <div class="share-main">
            <div class="share-main-all">
                <div id="qrcode" title="https://ryanchou612.github.io/posts/f95eb837.html">
                </div>
                <div class="reward-dec">使用手机访问这篇文章</div>
            </div>
        </div>
        <script type="text/javascript">
            new QRCode(document.getElementById("qrcode"), "https://ryanchou612.github.io/posts/f95eb837.html");
        </script>
    </div>
</div>
                <div class="share-link weibo"><a class="share-button" target="_blank"
    href="https://service.weibo.com/share/share.php?title=学习笔记｜Gorm框架&amp;url=https://ryanchou612.github.io/posts/f95eb837.html&amp;pic=/img/hello.jpg"
    title="分享到微博" rel="noopener external nofollow noreferrer noopener">
    <i class="fab fa-weibo" style="font-size:22px"></i>
</a>
</div>
<div class="share-link copyurl">
<div class="share-button" id="post-share-url" title="复制链接" onclick="acrylic.copyPageUrl()">
    <i class="fas fa-link"></i>
</div>
</div>
            </div>
            <div class="post-tools-right">
                <div class="tag_share">
                    <div class="post-meta__tag-list">
                        
                            <a href="/tags/Gorm/" class="post-meta__tags">
                                <span class="tags-punctuation">#</span>
                                Gorm
                                <span class="tagsPageCount">1</span>
                            </a>
                        
                    </div>
                </div>
            </div>
        </div>
        <div class="post-copyright">
    <div class="post-copyright__author">
        <a class="post-copyright__original" title="该文章为文章，注意版权协议"></a>
        <a class="post-copyright-title" href="#">
            <span>学习笔记｜Gorm框架</span>
        </a>
    </div>
    <div class="post-copyright__type">
        <span class="post-copyright-info" id="post-copyright-url">
            <a href="/posts/f95eb837.html">https://ryanchou612.github.io/posts/f95eb837.html</a>
        </span>
        <button class="post-copyright-copybtn" onclick="acrylic.copyPageUrl()">
            <i class="fas fa-paste copy-btn"></i>
        </button>
    </div>
    <div class="post-copyright__notice"><span class="post-copyright-info">本文是文章，采用 <a
                href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a> 协议，完整转载请注明来自 <a
                href="/">RyanChouBlog</a>
            </span>
        </div>
</div>
        <nav class="pagination-post" id="pagination">
    
        <div class="prev-post pull-left">
            <a href="/posts/10ebb886.html">
                <div class="pagination-info">
                    <div class="label">上一篇</div>
                    <div class="prev_info">学习笔记｜Linux</div>
                </div>
            </a>
        </div>
        <div class="next-post pull-right">
            <a href="/posts/69c3279c.html">
                <div class="pagination-info">
                    <div class="label">下一篇</div>
                    <div class="next_info">学习笔记｜Git</div>
                </div>
            </a>
        </div>
    
</nav>
            
    </div>
    <div class="aside-content" id="aside-content">
    
    
        
        <div class="card-widget card-info">
    <div class="card-content">
        <div class="card-info-avatar is-center">
            <div class="author-info__sayhi" id="author-info__sayhi">
            </div>
            <div class="author-info__name">
                RyanChou
            </div>
            <div class="author-info__description">这里记录关于<b>开发</b>、<b>技术</b>、<b>学习</b>相关的问题。<br/><br/><b>道阻且长 行则将至</b><br><br>博客正在完善...</div>
        </div>
    </div>
    <div class="banner-button-group">
        <a class="banner-button" href="/about/">
            <i class="fas fa-circle-chevron-right"></i>
            <span class="banner-button-text">个人主页</span>
        </a>
    </div>
    <div class="card-info-social-icons is-center">
        
    </div>
</div>
     
    
    <div class="sticky_layout">
        
            <div class="card-widget" id="card-toc">
    <div class="item-headline">
        <i class="fas fa-bars"></i>
        <span>文章目录</span>
    </div>
    <div class="toc-content" id="toc-content">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Gorm%E6%A6%82%E8%BF%B0"><span class="toc-text">Gorm概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ORM%E7%AE%80%E4%BB%8B"><span class="toc-text">ORM简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">快速入门</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm%E5%A3%B0%E6%98%8E%E6%A8%A1%E5%9E%8B"><span class="toc-text">gorm声明模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="toc-text">模型定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%A6%E5%AE%9A"><span class="toc-text">约定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gorm-Model"><span class="toc-text">gorm.Model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9"><span class="toc-text">高级选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E7%BA%A7%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-text">字段级权限控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-x2F-%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E8%BF%BD%E8%B8%AA%EF%BC%88%E7%BA%B3%E7%A7%92%E3%80%81%E6%AF%AB%E7%A7%92%E3%80%81%E7%A7%92%E3%80%81Time%EF%BC%89"><span class="toc-text">创建&#x2F;更新时间追踪（纳秒、毫秒、秒、Time）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%85%A5%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">嵌入结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E6%A0%87%E7%AD%BE"><span class="toc-text">字段标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%A0%87%E7%AD%BE"><span class="toc-text">关联标签</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm%E8%BF%9E%E6%8E%A5%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">gorm连接到数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL"><span class="toc-text">MySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A9%B1%E5%8A%A8"><span class="toc-text">自定义驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E6%9C%89%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="toc-text">现有的数据库连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PostgreSQL"><span class="toc-text">PostgreSQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A9%B1%E5%8A%A8-1"><span class="toc-text">自定义驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E6%9C%89%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5-1"><span class="toc-text">现有的数据库连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQLite"><span class="toc-text">SQLite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-Server"><span class="toc-text">SQL Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clickhouse"><span class="toc-text">Clickhouse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-text">连接池</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95"><span class="toc-text">gorm创建记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%8C%87%E5%AE%9A%E7%9A%84%E5%AD%97%E6%AE%B5%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95"><span class="toc-text">用指定的字段创建记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5"><span class="toc-text">批量插入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%92%A9%E5%AD%90"><span class="toc-text">创建钩子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE-Map-%E5%88%9B%E5%BB%BA"><span class="toc-text">根据 Map 创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-SQL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E3%80%81Context-Valuer-%E5%88%9B%E5%BB%BA%E8%AE%B0%E5%BD%95"><span class="toc-text">使用 SQL 表达式、Context Valuer 创建记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9-1"><span class="toc-text">高级选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E5%88%9B%E5%BB%BA"><span class="toc-text">关联创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-text">默认值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Upsert-%E5%8F%8A%E5%86%B2%E7%AA%81"><span class="toc-text">Upsert 及冲突</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm%E6%9F%A5%E8%AF%A2%E8%AE%B0%E5%BD%95"><span class="toc-text">gorm查询记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E5%8D%95%E4%B8%AA%E5%AF%B9%E8%B1%A1"><span class="toc-text">检索单个对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E4%B8%BB%E9%94%AE%E6%A3%80%E7%B4%A2"><span class="toc-text">用主键检索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E5%85%A8%E9%83%A8%E5%AF%B9%E8%B1%A1"><span class="toc-text">检索全部对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6"><span class="toc-text">条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#String-%E6%9D%A1%E4%BB%B6"><span class="toc-text">String 条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct-amp-Map-%E6%9D%A1%E4%BB%B6"><span class="toc-text">Struct &amp; Map 条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E7%BB%93%E6%9E%84%E4%BD%93%E6%9F%A5%E8%AF%A2%E5%AD%97%E6%AE%B5"><span class="toc-text">指定结构体查询字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E8%81%94%E6%9D%A1%E4%BB%B6"><span class="toc-text">内联条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Not-%E6%9D%A1%E4%BB%B6"><span class="toc-text">Not 条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Or-%E6%9D%A1%E4%BB%B6"><span class="toc-text">Or 条件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E7%89%B9%E5%AE%9A%E5%AD%97%E6%AE%B5"><span class="toc-text">选择特定字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Order"><span class="toc-text">Order</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Limit-amp-Offset"><span class="toc-text">Limit &amp; Offset</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Group-By-amp-Having"><span class="toc-text">Group By &amp; Having</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Distinct"><span class="toc-text">Distinct</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Joins"><span class="toc-text">Joins</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Joins-%E9%A2%84%E5%8A%A0%E8%BD%BD"><span class="toc-text">Joins 预加载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E7%BB%93%E6%9E%9C"><span class="toc-text">扫描结果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2"><span class="toc-text">gorm高级查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E9%80%89%E6%8B%A9%E5%AD%97%E6%AE%B5"><span class="toc-text">智能选择字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Locking-FOR-UPDATE"><span class="toc-text">Locking (FOR UPDATE)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-text">子查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#From-%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="toc-text">From 子查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Group-%E6%9D%A1%E4%BB%B6"><span class="toc-text">Group 条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%A6%E5%A4%9A%E4%B8%AA%E5%88%97%E7%9A%84-In"><span class="toc-text">带多个列的 In</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E5%8F%82%E6%95%B0"><span class="toc-text">命名参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Find-%E8%87%B3-map"><span class="toc-text">Find 至 map</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FirstOrInit"><span class="toc-text">FirstOrInit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FirstOrCreate"><span class="toc-text">FirstOrCreate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%99%A8%E3%80%81%E7%B4%A2%E5%BC%95%E6%8F%90%E7%A4%BA"><span class="toc-text">优化器、索引提示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3"><span class="toc-text">迭代</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FindInBatches"><span class="toc-text">FindInBatches</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E9%92%A9%E5%AD%90"><span class="toc-text">查询钩子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pluck"><span class="toc-text">Pluck</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scope"><span class="toc-text">Scope</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Count"><span class="toc-text">Count</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm%E6%9B%B4%E6%96%B0"><span class="toc-text">gorm更新</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E6%89%80%E6%9C%89%E5%AD%97%E6%AE%B5"><span class="toc-text">保存所有字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E5%8D%95%E4%B8%AA%E5%88%97"><span class="toc-text">更新单个列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E5%A4%9A%E5%88%97"><span class="toc-text">更新多列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E9%80%89%E5%AE%9A%E5%AD%97%E6%AE%B5"><span class="toc-text">更新选定字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0-Hook"><span class="toc-text">更新 Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E6%9B%B4%E6%96%B0"><span class="toc-text">批量更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E6%AD%A2%E5%85%A8%E5%B1%80%E6%9B%B4%E6%96%B0"><span class="toc-text">阻止全局更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%9A%84%E8%AE%B0%E5%BD%95%E6%95%B0"><span class="toc-text">更新的记录数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E9%80%89%E9%A1%B9-2"><span class="toc-text">高级选项</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-SQL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%9B%B4%E6%96%B0"><span class="toc-text">使用 SQL 表达式更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E5%AD%90%E6%9F%A5%E8%AF%A2%E8%BF%9B%E8%A1%8C%E6%9B%B4%E6%96%B0"><span class="toc-text">根据子查询进行更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E4%BD%BF%E7%94%A8-Hook-%E5%92%8C%E6%97%B6%E9%97%B4%E8%BF%BD%E8%B8%AA"><span class="toc-text">不使用 Hook 和时间追踪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E4%BF%AE%E6%94%B9%E8%A1%8C%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-text">返回修改行的数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%AD%97%E6%AE%B5%E6%98%AF%E5%90%A6%E6%9C%89%E5%8F%98%E6%9B%B4%EF%BC%9F"><span class="toc-text">检查字段是否有变更？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8-Update-%E6%97%B6%E4%BF%AE%E6%94%B9%E5%80%BC"><span class="toc-text">在 Update 时修改值</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm%E5%88%A0%E9%99%A4"><span class="toc-text">gorm删除</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95"><span class="toc-text">删除一条记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AE%E4%B8%BB%E9%94%AE%E5%88%A0%E9%99%A4"><span class="toc-text">根据主键删除</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Delete-Hook"><span class="toc-text">Delete Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="toc-text">批量删除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E6%AD%A2%E5%85%A8%E5%B1%80%E5%88%A0%E9%99%A4"><span class="toc-text">阻止全局删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%88%A0%E9%99%A4%E8%A1%8C%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-text">返回删除行的数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E5%88%A0%E9%99%A4"><span class="toc-text">软删除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E8%A2%AB%E8%BD%AF%E5%88%A0%E9%99%A4%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="toc-text">查找被软删除的记录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E5%88%A0%E9%99%A4"><span class="toc-text">永久删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Delete-Flag"><span class="toc-text">Delete Flag</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SQL-%E6%9E%84%E5%BB%BA%E5%99%A8"><span class="toc-text">SQL 构建器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F-SQL"><span class="toc-text">原生 SQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E5%8F%82%E6%95%B0-1"><span class="toc-text">命名参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DryRun-%E6%A8%A1%E5%BC%8F"><span class="toc-text">DryRun 模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ToSQL"><span class="toc-text">ToSQL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Row-amp-Rows"><span class="toc-text">Row &amp; Rows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86-sql-Rows-%E6%89%AB%E6%8F%8F%E8%87%B3-model"><span class="toc-text">将 sql.Rows 扫描至 model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Connection"><span class="toc-text">Connection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8"><span class="toc-text">高级应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E5%8F%A5%EF%BC%88Clause%EF%BC%89"><span class="toc-text">子句（Clause）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E5%8F%A5%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-text">子句构造器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%90%E5%8F%A5%E9%80%89%E9%A1%B9"><span class="toc-text">子句选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E5%8F%A5%E4%BF%AE%E9%A5%B0%E7%AC%A6"><span class="toc-text">语句修饰符</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Belongs-To"><span class="toc-text">Belongs To</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Belongs-To-1"><span class="toc-text">Belongs To</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%A4%96%E9%94%AE"><span class="toc-text">重写外键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%BC%95%E7%94%A8"><span class="toc-text">重写引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Belongs-to-%E7%9A%84-CRUD"><span class="toc-text">Belongs to 的 CRUD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%8A%A0%E8%BD%BD"><span class="toc-text">预加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="toc-text">外键约束</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm-Has-One%E5%85%B3%E7%B3%BB"><span class="toc-text">gorm Has One关系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Has-One"><span class="toc-text">Has One</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%A4%96%E9%94%AE-1"><span class="toc-text">重写外键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%BC%95%E7%94%A8-1"><span class="toc-text">重写引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94"><span class="toc-text">多态关联</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Has-One-%E7%9A%84-CURD"><span class="toc-text">Has One 的 CURD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%8A%A0%E8%BD%BD-1"><span class="toc-text">预加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%BC%95%E7%94%A8-Has-One"><span class="toc-text">自引用 Has One</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F-1"><span class="toc-text">外键约束</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm-Has-Many%E5%85%B3%E7%B3%BB"><span class="toc-text">gorm Has Many关系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Has-Many"><span class="toc-text">Has Many</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%A4%96%E9%94%AE-2"><span class="toc-text">重写外键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%BC%95%E7%94%A8-2"><span class="toc-text">重写引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94-1"><span class="toc-text">多态关联</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Has-Many-%E7%9A%84-CURD"><span class="toc-text">Has Many 的 CURD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%8A%A0%E8%BD%BD-2"><span class="toc-text">预加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%BC%95%E7%94%A8-Has-Many"><span class="toc-text">自引用 Has Many</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F-2"><span class="toc-text">外键约束</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm-Many-To-Many%E5%85%B3%E7%B3%BB"><span class="toc-text">gorm Many To Many关系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Many-To-Many"><span class="toc-text">Many To Many</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E5%BC%95%E7%94%A8"><span class="toc-text">反向引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%A4%96%E9%94%AE-3"><span class="toc-text">重写外键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%BC%95%E7%94%A8-Many2Many"><span class="toc-text">自引用 Many2Many</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%8A%A0%E8%BD%BD-3"><span class="toc-text">预加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Many2Many-%E7%9A%84-CURD"><span class="toc-text">Many2Many 的 CURD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%9E%E6%8E%A5%E8%A1%A8"><span class="toc-text">自定义连接表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F-3"><span class="toc-text">外键约束</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E5%A4%96%E9%94%AE"><span class="toc-text">复合外键</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm-%E5%AE%9E%E4%BD%93%E5%85%B3%E8%81%94"><span class="toc-text">gorm 实体关联</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E3%80%81%E6%9B%B4%E6%96%B0"><span class="toc-text">自动创建、更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%B3%E8%BF%87%E8%87%AA%E5%8A%A8%E5%88%9B%E5%BB%BA%E3%80%81%E6%9B%B4%E6%96%B0"><span class="toc-text">跳过自动创建、更新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Select-x2F-Omit-%E5%85%B3%E8%81%94%E5%AD%97%E6%AE%B5"><span class="toc-text">Select&#x2F;Omit 关联字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F"><span class="toc-text">关联模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E5%85%B3%E8%81%94"><span class="toc-text">查找关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%85%B3%E8%81%94"><span class="toc-text">添加关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E5%85%B3%E8%81%94"><span class="toc-text">替换关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%85%B3%E8%81%94"><span class="toc-text">删除关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%85%E7%A9%BA%E5%85%B3%E8%81%94"><span class="toc-text">清空关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E8%AE%A1%E6%95%B0"><span class="toc-text">关联计数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE"><span class="toc-text">批量处理数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%A6-Select-%E7%9A%84%E5%88%A0%E9%99%A4"><span class="toc-text">带 Select 的删除</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%A0%87%E7%AD%BE-1"><span class="toc-text">关联标签</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm-%E4%BC%9A%E8%AF%9D"><span class="toc-text">gorm 会话</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DryRun"><span class="toc-text">DryRun</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E7%BC%96%E8%AF%91"><span class="toc-text">预编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NewDB"><span class="toc-text">NewDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%B3%E8%BF%87%E9%92%A9%E5%AD%90"><span class="toc-text">跳过钩子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1"><span class="toc-text">禁用嵌套事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AllowGlobalUpdate"><span class="toc-text">AllowGlobalUpdate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FullSaveAssociations"><span class="toc-text">FullSaveAssociations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Context"><span class="toc-text">Context</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Logger"><span class="toc-text">Logger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NowFunc"><span class="toc-text">NowFunc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug"><span class="toc-text">Debug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QueryFields"><span class="toc-text">QueryFields</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CreateBatchSize"><span class="toc-text">CreateBatchSize</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gorm%E4%BA%8B%E5%8A%A1"><span class="toc-text">gorm事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E9%BB%98%E8%AE%A4%E4%BA%8B%E5%8A%A1"><span class="toc-text">禁用默认事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E4%BA%8B%E5%8A%A1"><span class="toc-text">嵌套事务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E4%BA%8B%E5%8A%A1"><span class="toc-text">手动事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%89%B9%E6%AE%8A%E7%9A%84%E7%A4%BA%E4%BE%8B"><span class="toc-text">一个特殊的示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SavePoint%E3%80%81RollbackTo"><span class="toc-text">SavePoint、RollbackTo</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Gorm%E6%80%BB%E7%BB%93"><span class="toc-text">Gorm总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE"><span class="toc-text">准备数据库和表以及数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE"><span class="toc-text">创建并初始化项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93"><span class="toc-text">创建实体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">创建连接数据库工具类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAdao%E6%8E%A5%E5%8F%A3"><span class="toc-text">创建dao接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li></ol></li></ol>
    </div>
</div>
            
        
            
        <div class="card-widget card-recent-post">
    <div class="item-headline">
        <i class="fas fa-list-ol"></i>
        <span>最近发布</span>
    </div>
    <div class="aside-list">
        
        
            <div class="aside-list-item">
                <a class="thumbnail" href="/posts/106f7f46.html" title="学习笔记｜Docker">
                    <img
                        alt="学习笔记｜Docker"
                        src="/img/hello.jpg">
                </a>
                <div class="content">
                    
                    <a class="title" href="/posts/106f7f46.html" title="学习笔记｜Docker">
                        学习笔记｜Docker
                    </a>
                </div>
            </div>
                
        
            <div class="aside-list-item">
                <a class="thumbnail" href="/posts/b7d9b0d0.html" title="学习笔记｜Gin框架">
                    <img
                        alt="学习笔记｜Gin框架"
                        src="/img/hello.jpg">
                </a>
                <div class="content">
                    
                    <a class="title" href="/posts/b7d9b0d0.html" title="学习笔记｜Gin框架">
                        学习笔记｜Gin框架
                    </a>
                </div>
            </div>
                
        
            <div class="aside-list-item">
                <a class="thumbnail" href="/posts/817da579.html" title="学习笔记｜MySQL">
                    <img
                        alt="学习笔记｜MySQL"
                        src="/img/hello.jpg">
                </a>
                <div class="content">
                    
                    <a class="title" href="/posts/817da579.html" title="学习笔记｜MySQL">
                        学习笔记｜MySQL
                    </a>
                </div>
            </div>
                
        
            <div class="aside-list-item">
                <a class="thumbnail" href="/posts/10ebb886.html" title="学习笔记｜Linux">
                    <img
                        alt="学习笔记｜Linux"
                        src="/img/hello.jpg">
                </a>
                <div class="content">
                    
                    <a class="title" href="/posts/10ebb886.html" title="学习笔记｜Linux">
                        学习笔记｜Linux
                    </a>
                </div>
            </div>
                
        
            <div class="aside-list-item">
                <a class="thumbnail" href="/posts/f95eb837.html" title="学习笔记｜Gorm框架">
                    <img
                        alt="学习笔记｜Gorm框架"
                        src="/img/hello.jpg">
                </a>
                <div class="content">
                    
                    <a class="title" href="/posts/f95eb837.html" title="学习笔记｜Gorm框架">
                        学习笔记｜Gorm框架
                    </a>
                </div>
            </div>
            
    </div>
</div>
     
        
    </div>
</div> 
</main>
                <footer id="footer">
                    <div id="footer_deal">
    
        <a class="deal_link" target="_blank" href="https://github.com/ryanchou612/ryanchou612.github.io" rel="external nofollow noopener" title="Github">
            <i class="fa-brands fa-github"></i>
        </a>
    
    <img class="footer_mini_logo" src="/img/avatar.webp"
        title="返回顶部" onclick="acrylic.toTop()">
    
</div>    
<div id="heo-footer">
    
    
</div>
<div id="footer-section">
    <div class="footer-section-links">
        <div class="footer-section-left">
            <div id="footer-section-tips">
                <div class="copyright">©2023 - 2023 By 
                    <a class="footer-section-link" href="/" rel="external nofollow">RyanChou</a>
                    <a class="footer-section-link" href="https://github.com/hexo-theme-Acrylic/Hexo-Theme-Acrylic-Next" rel="external nofollow" target="_blank"> Theme By Acrylic-Next</a>
                </div>
            </div>
        </div>
        <div class="footer-section-right">
            <a class="footer-section-link" href="/rss/">订阅</a>
            
            <a class="footer-section-link cc" target="_blank" href="https://creativecommons.org/licenses/by/4.0/" title="cc协议">
                <i class="fa-solid fa-closed-captioning"></i>
            </a>
        </div>
    </div>
</div>
                </footer>
            </div>
         
        <div>
    <script type="text/javascript" src="/js/utils.js"></script>
    <script type="text/javascript" src="/js/main.js"></script>
    

<script src="/lib/pjax.min.js"></script>



<script src="/lib/snackbar.min.js"></script>


    
<script src="/lib/view-image.min.js"></script>



<div id="js-pjax">
    
     
</div>


    
<script src="/js/extend/covercolor/web.js"></script>

        


    <script>
  let pjaxSelectors = [
    'title',
    '#body-wrap',
    '#site-config',
    'meta[name="description"]',
    '#js-pjax'
  ]
  
  const pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
  })

  document.addEventListener('pjax:error', (e) => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
</script>
    
</div>
        
     
        <div class="needEndHide" id="nav-music" onclick="acrylic.musicToggle()">
    <div id="nav-music-hoverTips">音乐已暂停</div>
    <meting-js id="1708664797" server="tencent" type="playlist" mutex="true"
        preload="none" data-lrctype="0" order="random" theme="var(--heo-main)"></meting-js>
</div>
    
    </body>
</html>
<script>const posts=["posts/106f7f46.html","posts/b7d9b0d0.html","posts/817da579.html","posts/10ebb886.html","posts/f95eb837.html","posts/69c3279c.html","posts/b1efffe8.html","posts/eae62c98.html","posts/3e97faf3.html"];function toRandomPost(){ window.pjax ? pjax.loadUrl('/'+posts[Math.floor(Math.random()*posts.length)]) : window.open('/'+posts[Math.floor(Math.random()*posts.length)], "_self"); };</script>